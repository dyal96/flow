<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flow Accounting - Personal Edition</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb">

    <!-- Libraries -->
    <!-- Libraries -->
    <script src="assets/js/tailwind.js"></script>
    <script src="assets/js/chart.js"></script>
    <script src="assets/js/jspdf.umd.min.js"></script>
    <script src="assets/js/jspdf.plugin.autotable.min.js"></script>
    <!-- PapaParse for robust CSV/Excel handling -->
    <script src="assets/js/papaparse.min.js"></script>

    <!-- Icons & Fonts -->
    <link rel="stylesheet" href="assets/css/fonts.css">
    <link rel="stylesheet" href="assets/css/fontawesome.min.css">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Google Sans', 'Roboto', 'sans-serif'],
                    },
                    colors: {
                        primary: '#1a73e8',
                        secondary: '#e8f0fe',
                        success: '#1e8e3e',
                        danger: '#d93025',
                        surface: '#f8f9fa',
                        dark: {
                            bg: '#0f172a',
                            surface: '#1e293b',
                            border: '#334155',
                            text: '#f1f5f9',
                            muted: '#94a3b8'
                        }
                    }
                }
            }
        }
    </script>

    <style>
        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        body {
            background-color: #f0f2f5;
            min-height: 100vh;
        }

        .dark body {
            background-color: #18181b;
            color: #f4f4f5;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }

        .dark .glass-panel {
            background: rgba(39, 39, 42, 0.95);
        }

        .sidebar-item.active {
            background-color: #e8f0fe;
            color: #1a73e8;
            font-weight: 500;
        }

        .sidebar-item:hover:not(.active) {
            background-color: #f1f3f4;
        }

        /* Keyboard Navigation Styles */
        /* Keyboard Navigation Styles - Unified & Robust */
        /* Table Rows */
        tr.kb-focused {
            background-color: rgba(59, 130, 246, 0.1) !important;
            box-shadow: inset 4px 0 0 #3b82f6 !important;
        }

        .dark tr.kb-focused {
            background-color: rgba(59, 130, 246, 0.25) !important;
            box-shadow: inset 4px 0 0 #60a5fa !important;
        }

        /* Cards (Divs) - Preserve drop shadow, add inset highlight & scale */
        div.kb-focused {
            background-color: rgba(59, 130, 246, 0.05) !important;
            box-shadow: inset 4px 0 0 #3b82f6, 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1) !important;
            transform: scale(1.01);
            z-index: 10;
        }

        .dark div.kb-focused {
            background-color: rgba(59, 130, 246, 0.15) !important;
            box-shadow: inset 4px 0 0 #60a5fa, 0 0 0 1px rgba(96, 165, 250, 0.3) !important;
        }

        /* Focus styles for accessibility/keyboard nav */
        button:focus-visible,
        a:focus-visible,
        input:focus-visible,
        select:focus-visible {
            outline: 2px solid #1a73e8;
            outline-offset: 2px;
        }

        /* Smooth Transitions */
        .fade-in {
            animation: fadeIn 0.2s ease-out forwards;
            opacity: 0;
            transform: translateY(5px);
        }

        @keyframes fadeIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #dadce0;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #bdc1c6;
        }

        .dark ::-webkit-scrollbar-thumb {
            background: #475569;
        }

        .dark ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }

        /* Chip Selection for Transactions/Accounts/Categories */
        .chip-radio:checked+span {
            background-color: #e8f0fe;
            color: #1a73e8;
            border-color: #1a73e8;
            font-weight: 600;
        }

        /* === THEME SYSTEM === */

        /* 1. DEFAULT THEME (Light) - No overrides needed, base styles */

        /* 2. DARK THEME */
        [data-theme="dark"] {
            color-scheme: dark;
        }

        [data-theme="dark"] body {
            background-color: #0f172a !important;
            color: #f1f5f9 !important;
        }

        [data-theme="dark"] aside {
            background-color: #1e293b !important;
            border-color: #334155 !important;
        }

        [data-theme="dark"] .bg-white {
            background-color: #1e293b !important;
            color: #f1f5f9 !important;
        }

        [data-theme="dark"] .text-gray-700,
        [data-theme="dark"] .text-gray-800,
        [data-theme="dark"] .text-gray-900 {
            color: #f1f5f9 !important;
        }

        [data-theme="dark"] .text-gray-500,
        [data-theme="dark"] .text-gray-600 {
            color: #94a3b8 !important;
        }

        [data-theme="dark"] .text-gray-400 {
            color: #9ca3af !important;
        }

        [data-theme="dark"] .bg-gray-50 {
            background-color: #0f172a !important;
        }

        [data-theme="dark"] .bg-gray-100 {
            background-color: #1e293b !important;
        }

        [data-theme="dark"] .border-gray-200,
        [data-theme="dark"] .border-gray-100 {
            border-color: #334155 !important;
        }

        [data-theme="dark"] main {
            background-color: #0f172a !important;
        }

        [data-theme="dark"] .sidebar-item {
            color: #94a3b8;
        }

        [data-theme="dark"] .sidebar-item.active {
            background-color: #334155 !important;
            color: #60a5fa !important;
        }

        [data-theme="dark"] .sidebar-item:hover {
            background-color: #1e293b !important;
            color: #f1f5f9 !important;
        }

        /* Fix shadows in dark theme */
        [data-theme="dark"] .shadow-blue-100,
        [data-theme="dark"] .shadow-blue-200,
        [data-theme="dark"] .shadow-sm,
        [data-theme="dark"] .shadow-md,
        [data-theme="dark"] .shadow-lg,
        [data-theme="dark"] .shadow-xl {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5), 0 2px 4px -1px rgba(0, 0, 0, 0.3) !important;
        }

        [data-theme="dark"] .hover\:ring-blue-100:hover {
            --tw-ring-color: rgba(59, 130, 246, 0.3) !important;
        }


        /* 3. CUTE THEME (Pink) */
        [data-theme="cute"] body {
            background-color: #fce7f3 !important;
        }

        [data-theme="cute"] aside {
            background-color: #fff1f2 !important;
        }

        [data-theme="cute"] .bg-white {
            background-color: #ffffff !important;
        }

        [data-theme="cute"] .bg-gray-50 {
            background-color: #fff1f2 !important;
        }

        /* CUTE / PINK THEME */
        [data-theme="cute"] body {
            background-color: #fdf2f8 !important;
            color: #831843 !important;
        }

        [data-theme="cute"] aside {
            background-color: #fff1f2 !important;
            border-right: 1px solid #fecdd3 !important;
        }

        [data-theme="cute"] .sidebar-item.active {
            background-color: #fbcfe8 !important;
            color: #db2777 !important;
        }

        [data-theme="cute"] .text-blue-600 {
            color: #db2777 !important;
        }

        [data-theme="cute"] .bg-blue-600 {
            background-color: #db2777 !important;
            border-color: #db2777 !important;
        }

        [data-theme="cute"] .hover\:bg-blue-700:hover {
            background-color: #be185d !important;
        }

        [data-theme="cute"] .shadow-blue-100,
        [data-theme="cute"] .shadow-blue-200 {
            box-shadow: 0 4px 12px rgba(219, 39, 119, 0.15) !important;
        }

        [data-theme="cute"] .bg-white {
            background-color: rgba(255, 255, 255, 0.9) !important;
            border: 1px solid #fbcfe8 !important;
        }

        /* Ensure text is visible in cute theme */
        [data-theme="cute"] .text-gray-700,
        [data-theme="cute"] .text-gray-800,
        [data-theme="cute"] .text-gray-900 {
            color: #831843 !important;
        }

        [data-theme="cute"] .text-gray-500,
        [data-theme="cute"] .text-gray-600 {
            color: #be185d !important;
        }

        [data-theme="cute"] .text-gray-400 {
            color: #f472b6 !important;
        }

        [data-theme="cute"] .text-gray-200 {
            color: #831843 !important;
        }

        [data-theme="cute"] main {
            background-color: transparent !important;
        }

        /* 4. PASTEL GRADIENT 1 (Purple to Blue) */
        [data-theme="pastel"] body {
            background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%) !important;
            background-attachment: fixed !important;
        }

        [data-theme="pastel"] aside {
            background-color: rgba(255, 255, 255, 0.75) !important;
            backdrop-filter: blur(12px) !important;
            border-right: 1px solid rgba(255, 255, 255, 0.5) !important;
        }

        [data-theme="pastel"] main {
            background-color: transparent !important;
        }

        [data-theme="pastel"] .bg-white {
            background-color: rgba(255, 255, 255, 0.85) !important;
            backdrop-filter: blur(10px) !important;
            border: 1px solid rgba(255, 255, 255, 0.6) !important;
        }

        [data-theme="pastel"] .bg-gray-50 {
            background-color: rgba(255, 255, 255, 0.5) !important;
        }

        [data-theme="pastel"] .sidebar-item.active {
            background-color: rgba(255, 255, 255, 0.95) !important;
            color: #6366f1 !important;
        }

        /* 5. PASTEL GRADIENT 2 (Pink to Yellow) */
        [data-theme="pastel2"] body {
            background: linear-gradient(135deg, #fbc2eb 0%, #a6c1ee 100%) !important;
            background-attachment: fixed !important;
        }

        [data-theme="pastel2"] aside {
            background-color: rgba(255, 255, 255, 0.75) !important;
            backdrop-filter: blur(12px) !important;
            border-right: 1px solid rgba(255, 255, 255, 0.5) !important;
        }

        [data-theme="pastel2"] main {
            background-color: transparent !important;
        }

        [data-theme="pastel2"] .bg-white {
            background-color: rgba(255, 255, 255, 0.85) !important;
            backdrop-filter: blur(10px) !important;
            border: 1px solid rgba(255, 255, 255, 0.6) !important;
        }

        [data-theme="pastel2"] .bg-gray-50 {
            background-color: rgba(255, 255, 255, 0.5) !important;
        }

        [data-theme="pastel2"] .sidebar-item.active {
            background-color: rgba(255, 255, 255, 0.95) !important;
            color: #ec4899 !important;
        }

        /* 6. SEA BLUE THEME (Ocean Blue Dark) */
        [data-theme="seablue"] {
            color-scheme: dark;
        }

        [data-theme="seablue"] body {
            background: linear-gradient(135deg, #001f3f 0%, #003d5c 50%, #006d99 100%) !important;
            background-attachment: fixed !important;
            color: #e0f2fe !important;
        }

        [data-theme="seablue"] aside {
            background-color: rgba(0, 40, 70, 0.95) !important;
            border-right: 1px solid rgba(0, 119, 190, 0.3) !important;
        }

        [data-theme="seablue"] .bg-white {
            background-color: rgba(0, 50, 85, 0.9) !important;
            backdrop-filter: blur(10px) !important;
            color: #e0f2fe !important;
        }

        [data-theme="seablue"] .bg-gray-50 {
            background-color: rgba(0, 30, 55, 0.8) !important;
        }

        [data-theme="seablue"] .bg-gray-100 {
            background-color: rgba(0, 40, 70, 0.8) !important;
        }

        [data-theme="seablue"] main {
            background-color: transparent !important;
        }

        [data-theme="seablue"] .text-gray-700,
        [data-theme="seablue"] .text-gray-800,
        [data-theme="seablue"] .text-gray-900 {
            color: #e0f2fe !important;
        }

        [data-theme="seablue"] .text-gray-500,
        [data-theme="seablue"] .text-gray-600 {
            color: #7dd3fc !important;
        }

        [data-theme="seablue"] .text-gray-400 {
            color: #bae6fd !important;
        }

        [data-theme="seablue"] .border-gray-200,
        [data-theme="seablue"] .border-gray-100 {
            border-color: rgba(0, 119, 190, 0.3) !important;
        }

        [data-theme="seablue"] .sidebar-item {
            color: #7dd3fc;
        }

        [data-theme="seablue"] .sidebar-item.active {
            background-color: rgba(0, 119, 190, 0.3) !important;
            color: #60d5ff !important;
        }

        [data-theme="seablue"] .sidebar-item:hover {
            background-color: rgba(0, 80, 130, 0.5) !important;
            color: #e0f2fe !important;
        }

        [data-theme="seablue"] .bg-blue-600 {
            background-color: #0077be !important;
        }

        [data-theme="seablue"] .hover\:bg-blue-700:hover {
            background-color: #005f99 !important;
        }

        /* Fix shadows in seablue theme */
        [data-theme="seablue"] .shadow-blue-100,
        [data-theme="seablue"] .shadow-blue-200,
        [data-theme="seablue"] .shadow-sm,
        [data-theme="seablue"] .shadow-md,
        [data-theme="seablue"] .shadow-lg,
        [data-theme="seablue"] .shadow-xl {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5), 0 2px 4px -1px rgba(0, 0, 0, 0.3) !important;
        }

        [data-theme="seablue"] .hover\:ring-blue-100:hover {
            --tw-ring-color: rgba(125, 211, 252, 0.2) !important;
        }

        [data-theme="seablue"] .text-blue-600 {
            color: #38bdf8 !important;
        }

        [data-theme="seablue"] .shadow-blue-200,
        [data-theme="seablue"] .shadow-blue-100 {
            --tw-shadow-color: rgba(0, 119, 190, 0.3) !important;
        }


        /* Account View Toggle Buttons */
        .account-view-btn:hover {
            color: #4b5563;
            background-color: rgba(255, 255, 255, 0.5);
        }

        /* TOAST NOTIFICATIONS */
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            background: white;
            border-left: 4px solid #3b82f6;
            padding: 16px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 300px;
            animation: slideIn 0.3s ease-out forwards;
            font-size: 14px;
            color: #333;
        }

        .toast.warning {
            border-left-color: #f59e0b;
        }

        .toast.error {
            border-left-color: #ef4444;
        }

        .dark .toast {
            background: #1e293b;
            color: #f1f5f9;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(100%);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes fadeOut {
            to {
                opacity: 0;
                transform: translateX(100%);
            }
        }

        .account-view-btn.active {
            background-color: #ffffff;
            color: #1a73e8;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        [data-theme="dark"] .account-view-btn.active {
            background-color: #334155;
            color: #60a5fa;
        }
    </style>
</head>

<body class="text-gray-600 transition-colors duration-200">

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <!-- UNLOCK MODAL -->
    <div id="unlockModal"
        class="fixed inset-0 bg-gray-900 bg-opacity-90 hidden flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="bg-white dark:bg-dark-surface rounded-2xl shadow-2xl w-full max-w-md p-8 text-center">
            <div class="mb-6">
                <div
                    class="w-16 h-16 bg-blue-100 dark:bg-blue-900/30 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fa-solid fa-lock text-2xl text-blue-600 dark:text-blue-400"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100">Welcome Back</h2>
                <p class="text-gray-500 dark:text-gray-400 mt-2">Enter your password to unlock your data.</p>
            </div>

            <form id="unlockForm" class="space-y-4">
                <input type="password" id="unlockPassword" required placeholder="Password"
                    class="w-full px-4 py-3 rounded-xl border border-gray-200 dark:border-dark-border bg-gray-50 dark:bg-dark-bg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition text-center text-lg" />

                <button type="submit"
                    class="w-full py-3 px-6 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white rounded-xl font-medium shadow-lg hover:shadow-xl transition-all transform hover:-translate-y-0.5">
                    Unlock App
                </button>
            </form>
            <div id="recoveryLinkContainer" class="mt-4 hidden">
                <button type="button" onclick="initiateRecovery()" class="text-sm text-blue-500 hover:underline">Forgot
                    Password?</button>
            </div>
            <p id="unlockError" class="text-red-500 mt-4 text-sm hidden"></p>
        </div>
    </div>

    <!-- PASSWORD SETUP MODAL -->
    <div id="passwordSetupModal"
        class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-50 backdrop-blur-sm px-4">
        <div class="bg-white dark:bg-dark-surface rounded-3xl p-8 w-full max-w-md shadow-2xl relative">
            <button onclick="closeModal('passwordSetupModal')"
                class="absolute top-4 right-4 w-8 h-8 rounded-full hover:bg-gray-100 dark:hover:bg-dark-bg flex items-center justify-center text-gray-400">
                <i class="fa-solid fa-xmark"></i>
            </button>
            <h2 id="passwordModalTitle" class="text-2xl font-bold text-gray-800 dark:text-gray-100 mb-6">Setup Password
            </h2>

            <form id="passwordSetupForm" onsubmit="handlePasswordSetupSubmit(event)" class="space-y-4">
                <input type="hidden" id="passwordMode" value="set">

                <div id="oldPasswordField" class="hidden">
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-1 ml-1">Current Password</label>
                    <input type="password" id="oldPassword"
                        class="w-full px-4 py-3 bg-gray-50 dark:bg-dark-bg border border-gray-200 dark:border-dark-border rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition">
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-1 ml-1">New Password</label>
                    <input type="password" id="newPassword" required
                        class="w-full px-4 py-3 bg-gray-50 dark:bg-dark-bg border border-gray-200 dark:border-dark-border rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition">
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-1 ml-1">Confirm Password</label>
                    <input type="password" id="confirmPassword" required
                        class="w-full px-4 py-3 bg-gray-50 dark:bg-dark-bg border border-gray-200 dark:border-dark-border rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition">
                </div>

                <p id="passwordSetupError" class="text-red-500 text-sm hidden"></p>

                <button type="submit"
                    class="w-full py-3 px-6 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-bold shadow-lg transition mt-2">
                    Save Password
                </button>
            </form>
        </div>
    </div>

    <!-- RECOVERY SETUP MODAL -->
    <div id="recoverySetupModal" style="z-index: 60;"
        class="fixed inset-0 bg-black/50 hidden flex items-center justify-center backdrop-blur-sm px-4">
        <div class="bg-white dark:bg-dark-surface rounded-3xl p-8 w-full max-w-md shadow-2xl relative">
            <button onclick="closeModal('recoverySetupModal')"
                class="absolute top-4 right-4 w-8 h-8 rounded-full hover:bg-gray-100 dark:hover:bg-dark-bg flex items-center justify-center text-gray-400">
                <i class="fa-solid fa-xmark"></i>
            </button>
            <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100 mb-6">Backup Codes / Keywords</h2>
            <p class="text-sm text-gray-500 mb-4 dark:text-gray-400">Set two memorable keywords (e.g., color, mobile
                number, email) to recover your password if you forget it.</p>

            <form id="recoverySetupForm" onsubmit="handleRecoverySetupSubmit(event)" class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-1 ml-1">Security Keyword
                        1</label>
                    <input type="text" id="reqQ1" required placeholder="e.g. Favorite Color (Red)"
                        class="w-full px-4 py-3 bg-gray-50 dark:bg-dark-bg border border-gray-200 dark:border-dark-border rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition">
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-1 ml-1">Security Keyword
                        2</label>
                    <input type="text" id="reqQ2" required placeholder="e.g. Mobile Number or Email"
                        class="w-full px-4 py-3 bg-gray-50 dark:bg-dark-bg border border-gray-200 dark:border-dark-border rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition">
                </div>

                <div id="recoveryCurrentPassField">
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-1 ml-1">Current
                        Password</label>
                    <input type="password" id="reqCurrentPass" required
                        class="w-full px-4 py-3 bg-gray-50 dark:bg-dark-bg border border-gray-200 dark:border-dark-border rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition">
                </div>

                <button type="submit"
                    class="w-full py-3 px-6 bg-purple-600 hover:bg-purple-700 text-white rounded-xl font-bold shadow-lg transition mt-2">
                    Save Recovery Options
                </button>
            </form>
        </div>
    </div>

    <!-- RECOVERY ACTION MODAL -->
    <div id="recoveryActionModal" style="z-index: 100;"
        class="fixed inset-0 bg-black/50 hidden flex items-center justify-center backdrop-blur-sm px-4">
        <div class="bg-white dark:bg-dark-surface rounded-3xl p-8 w-full max-w-md shadow-2xl relative">
            <button onclick="closeModal('recoveryActionModal')"
                class="absolute top-4 right-4 w-8 h-8 rounded-full hover:bg-gray-100 dark:hover:bg-dark-bg flex items-center justify-center text-gray-400">
                <i class="fa-solid fa-xmark"></i>
            </button>
            <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100 mb-6">Recover Password</h2>

            <form id="recoveryActionForm" onsubmit="handleRecoveryActionSubmit(event)" class="space-y-4">
                <div id="targetQ1Box">
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-1 ml-1" id="labelQ1">Question
                        1</label>
                    <input type="text" id="targetA1" required placeholder="Answer"
                        class="w-full px-4 py-3 bg-gray-50 dark:bg-dark-bg border border-gray-200 dark:border-dark-border rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition">
                </div>
                <div id="targetQ2Box">
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-1 ml-1" id="labelQ2">Question
                        2</label>
                    <input type="text" id="targetA2" required placeholder="Answer"
                        class="w-full px-4 py-3 bg-gray-50 dark:bg-dark-bg border border-gray-200 dark:border-dark-border rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition">
                </div>

                <p id="recoveryActionError" class="text-red-500 text-sm hidden"></p>

                <button type="submit"
                    class="w-full py-3 px-6 bg-green-600 hover:bg-green-700 text-white rounded-xl font-bold shadow-lg transition mt-2">
                    Recover & Unlock
                </button>
            </form>

            <!-- Success State with Reset Options -->
            <div id="recoverySuccessState" class="hidden space-y-4">
                <div class="text-center mb-4">
                    <div
                        class="w-16 h-16 bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fa-solid fa-check text-2xl text-green-600 dark:text-green-400"></i>
                    </div>
                    <h3 class="text-lg font-bold text-gray-800 dark:text-gray-100">Password Recovered!</h3>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">Your account is unlocked. Would you like to
                        update your security settings?</p>
                </div>

                <button onclick="resetSecurityKeysAfterRecovery()"
                    class="w-full py-3 px-6 bg-purple-600 hover:bg-purple-700 text-white rounded-xl font-bold shadow-lg transition flex items-center justify-center gap-2">
                    <i class="fa-solid fa-key"></i> Reset Security Keys
                </button>

                <button onclick="changePasswordAfterRecovery()"
                    class="w-full py-3 px-6 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-bold shadow-lg transition flex items-center justify-center gap-2">
                    <i class="fa-solid fa-lock"></i> Change Password
                </button>

                <button onclick="continueWithoutReset()"
                    class="w-full py-3 px-6 bg-gray-100 dark:bg-dark-bg text-gray-700 dark:text-gray-300 rounded-xl font-medium hover:bg-gray-200 dark:hover:bg-gray-700 transition">
                    Continue Without Changes
                </button>
            </div>
        </div>
    </div>
    <div id="appContainer" class="flex h-screen overflow-hidden">
        <!-- Sidebar -->
        <aside
            class="w-72 bg-white dark:bg-dark-surface h-full flex flex-col border-r border-gray-200 dark:border-dark-border hidden md:flex shadow-[4px_0_24px_rgba(0,0,0,0.02)] z-20">
            <div class="p-6 flex items-center gap-3">
                <div
                    class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center text-white shadow-lg shadow-blue-200">
                    <i class="fa-solid fa-chart-simple text-xl"></i>
                </div>
                <div>
                    <h1 class="text-lg font-bold text-gray-800 dark:text-gray-100 leading-tight">Flow Accounting</h1>
                    <p class="text-xs text-gray-500 font-medium">Personal Edition</p>
                </div>
            </div>

            <div class="px-4 py-2">
                <button onclick="openTxModal()"
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white p-4 rounded-2xl shadow-lg shadow-blue-100 transition-all flex items-center justify-center gap-2 font-medium text-sm group">
                    <i class="fa-solid fa-plus transition-transform group-hover:rotate-90"></i> Quick Transaction
                </button>
            </div>

            <nav class="flex-1 overflow-y-auto px-3 py-4 space-y-1">
                <button onclick="router('dashboard')"
                    class="sidebar-item w-full flex items-center space-x-3 px-4 py-3 text-gray-400 hover:bg-gray-800 hover:text-white dark:hover:bg-dark-bg dark:hover:text-white rounded-xl transition group">
                    <i class="fa-solid fa-chart-pie w-6 text-center group-hover:scale-110 transition"></i>
                    <span class="font-medium">Dashboard</span>
                </button>
                <button onclick="router('accounts')"
                    class="sidebar-item w-full flex items-center space-x-3 px-4 py-3 text-gray-400 hover:bg-gray-800 hover:text-white dark:hover:bg-dark-bg dark:hover:text-white rounded-xl transition group">
                    <i class="fa-solid fa-wallet w-6 text-center group-hover:scale-110 transition"></i>
                    <span class="font-medium">Accounts</span>
                </button>
                <button onclick="router('transactions')"
                    class="sidebar-item w-full flex items-center space-x-3 px-4 py-3 text-gray-400 hover:bg-gray-800 hover:text-white dark:hover:bg-dark-bg dark:hover:text-white rounded-xl transition group">
                    <i class="fa-solid fa-list w-6 text-center group-hover:scale-110 transition"></i>
                    <span class="font-medium">Transactions</span>
                </button>

                <button onclick="router('reports')"
                    class="sidebar-item w-full flex items-center space-x-3 px-4 py-3 text-gray-400 hover:bg-gray-800 hover:text-white dark:hover:bg-dark-bg dark:hover:text-white rounded-xl transition group">
                    <i class="fa-solid fa-chart-line w-6 text-center group-hover:scale-110 transition"></i>
                    <span class="font-medium">Reports</span>
                </button>
                <button onclick="router('settings')"
                    class="sidebar-item w-full flex items-center space-x-3 px-4 py-3 text-gray-400 hover:bg-gray-800 hover:text-white dark:hover:bg-dark-bg dark:hover:text-white rounded-xl transition group">
                    <i class="fa-solid fa-gear w-6 text-center group-hover:scale-110 transition"></i>
                    <span class="font-medium">Settings</span>
                </button>
            </nav>

            <div class="p-4 border-t border-gray-200 dark:border-dark-border">
                <div class="grid grid-cols-2 gap-2 mb-2">
                    <button id="undoBtn" onclick="undo()"
                        class="flex items-center justify-center gap-2 px-3 py-2 bg-gray-50 dark:bg-gray-800 rounded-xl text-xs font-bold hover:bg-gray-100 dark:hover:bg-gray-700 transition"
                        style="opacity: 0.3">
                        <i class="fa-solid fa-rotate-left"></i> Undo
                    </button>
                    <button id="redoBtn" onclick="redo()"
                        class="flex items-center justify-center gap-2 px-3 py-2 bg-gray-50 dark:bg-gray-800 rounded-xl text-xs font-bold hover:bg-gray-100 dark:hover:bg-gray-700 transition"
                        style="opacity: 0.3">
                        <i class="fa-solid fa-rotate-right"></i> Redo
                    </button>
                </div>
                <button onclick="cycleTheme()"
                    class="w-full flex items-center justify-between px-4 py-3 bg-gray-50 dark:bg-gray-800 rounded-xl text-sm font-medium hover:bg-gray-100 dark:hover:bg-gray-700 transition">
                    <span class="flex items-center gap-2"><i class="fa-solid fa-palette"></i> Theme</span>
                    <span id="themeBadge"
                        class="text-xs uppercase font-bold text-gray-400 bg-gray-200 px-2 py-0.5 rounded">Default</span>
                </button>
            </div>

        </aside>

        <!-- Main Area -->
        <main class="flex-1 flex flex-col h-full overflow-hidden relative bg-[#f8f9fa]">

            <!-- Mobile Header -->
            <header
                class="md:hidden h-16 bg-white border-b border-gray-200 flex items-center justify-between px-4 shrink-0">
                <div class="flex items-center gap-2 font-bold text-gray-700 dark:text-gray-300">
                    <i class="fa-solid fa-chart-simple text-blue-600"></i> Flow
                </div>
                <button onclick="document.querySelector('aside').classList.toggle('hidden')"
                    class="w-10 h-10 flex items-center justify-center rounded-full hover:bg-gray-100 dark:bg-dark-bg">
                    <i class="fa-solid fa-bars"></i>
                </button>
            </header>



            <!-- Content Container -->
            <div id="app-content" class="flex-1 overflow-y-auto p-4 md:p-8">
                <!-- Dynamic Views Injected Here -->
            </div>

            <!-- Floating Action Button (Mobile Only) -->
            <button onclick="openTxModal()"
                class="md:hidden fixed bottom-6 right-6 w-14 h-14 bg-blue-600 text-white rounded-2xl shadow-xl flex items-center justify-center z-30">
                <i class="fa-solid fa-plus text-xl"></i>
            </button>
        </main>

        <!-- 1. TRANSACTION ADD/EDIT MODAL -->
        <div id="txModal"
            class="fixed inset-0 bg-black/40 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4 opacity-0 transition-opacity duration-200"
            style="transition: opacity 0.2s;">
            <div
                class="bg-white dark:bg-dark-surface rounded-3xl shadow-2xl w-full max-w-lg overflow-hidden transform scale-95 transition-transform duration-200">
                <div
                    class="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50/50 dark:bg-dark-bg/50">
                    <h3 id="txModalTitle" class="font-bold text-lg text-gray-800 dark:text-gray-200">New Entry</h3>
                    <button onclick="closeModal('txModal')"
                        class="w-8 h-8 rounded-full hover:bg-gray-100 dark:bg-dark-bg flex items-center justify-center text-gray-500"><i
                            class="fa-solid fa-xmark"></i></button>
                </div>

                <form id="txForm" onsubmit="handleTxSubmit(event)" class="p-6 space-y-5">
                    <input type="hidden" id="txId" value="">

                    <!-- Type Chips -->
                    <div class="flex bg-gray-100 dark:bg-dark-bg p-1 rounded-xl">
                        <label class="flex-1 cursor-pointer">
                            <input type="radio" name="txType" value="income" class="hidden chip-radio"
                                onclick="toggleTransferMode(false)">
                            <span
                                class="flex items-center justify-center py-2 rounded-lg text-sm font-medium text-gray-500 transition-all hover:bg-white/50">Income</span>
                        </label>
                        <label class="flex-1 cursor-pointer">
                            <input type="radio" name="txType" value="expense" checked class="hidden chip-radio"
                                onclick="toggleTransferMode(false)">
                            <span
                                class="flex items-center justify-center py-2 rounded-lg text-sm font-medium text-gray-500 transition-all hover:bg-white/50">Expense</span>
                        </label>
                        <label class="flex-1 cursor-pointer">
                            <input type="radio" name="txType" value="transfer" class="hidden chip-radio"
                                onclick="toggleTransferMode(true)">
                            <span
                                class="flex items-center justify-center py-2 rounded-lg text-sm font-medium text-gray-500 transition-all hover:bg-white/50">Transfer</span>
                        </label>
                    </div>

                    <!-- Core Inputs -->
                    <div class="grid grid-cols-2 gap-4">
                        <div class="col-span-2">
                            <label class="block text-xs font-bold text-gray-400 uppercase mb-1 ml-1">Amount</label>
                            <div class="relative">
                                <span class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 font-bold"
                                    id="txCurrencySymbol">$</span>
                                <input type="number" step="0.01" id="txAmount" required
                                    class="w-full pl-8 pr-4 py-3 bg-gray-50 dark:bg-dark-bg border border-gray-200 dark:border-dark-border rounded-xl focus:bg-white dark:focus:bg-dark-surface focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition font-bold text-lg text-gray-800 dark:text-gray-200"
                                    placeholder="0.00">
                            </div>
                        </div>

                        <div class="col-span-2 sm:col-span-1">
                            <label class="block text-xs font-bold text-gray-400 uppercase mb-1 ml-1">Date</label>
                            <input type="date" id="txDate" required
                                class="w-full px-4 py-3 bg-gray-50 dark:bg-dark-bg border border-gray-200 dark:border-dark-border rounded-xl focus:bg-white dark:focus:bg-dark-surface focus:ring-2 focus:ring-blue-500 outline-none transition text-sm">
                        </div>

                        <!-- Category (Hidden for Transfer) -->
                        <div class="col-span-2 sm:col-span-1" id="categoryField">
                            <label class="block text-xs font-bold text-gray-400 uppercase mb-1 ml-1">Category</label>
                            <select id="txCategory"
                                class="w-full px-4 py-3 bg-gray-50 dark:bg-dark-bg border border-gray-200 dark:border-dark-border rounded-xl focus:bg-white dark:focus:bg-dark-surface focus:ring-2 focus:ring-blue-500 outline-none transition text-sm appearance-none cursor-pointer">
                                <!-- Populated via JS -->
                            </select>
                        </div>
                    </div>

                    <!-- Account Selection Logic -->
                    <div class="grid grid-cols-2 gap-4">
                        <div class="col-span-2 sm:col-span-1" id="fromAccountField">
                            <label class="block text-xs font-bold text-gray-400 uppercase mb-1 ml-1"
                                id="accountLabel">Account</label>
                            <select id="txAccount" required
                                class="w-full px-4 py-3 bg-gray-50 dark:bg-dark-bg border border-gray-200 dark:border-dark-border rounded-xl focus:bg-white dark:focus:bg-dark-surface focus:ring-2 focus:ring-blue-500 outline-none transition text-sm"></select>
                        </div>

                        <div class="col-span-2 sm:col-span-1 hidden" id="toAccountField">
                            <label class="block text-xs font-bold text-gray-400 uppercase mb-1 ml-1">To Account</label>
                            <select id="txToAccount"
                                class="w-full px-4 py-3 bg-gray-50 dark:bg-dark-bg border border-gray-200 dark:border-dark-border rounded-xl focus:bg-white dark:focus:bg-dark-surface focus:ring-2 focus:ring-blue-500 outline-none transition text-sm"></select>
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-gray-400 uppercase mb-1 ml-1">Description</label>
                        <input type="text" id="txDesc"
                            class="w-full px-4 py-3 bg-gray-50 dark:bg-dark-bg border border-gray-200 dark:border-dark-border rounded-xl focus:bg-white dark:focus:bg-dark-surface focus:ring-2 focus:ring-blue-500 outline-none transition text-sm"
                            placeholder="What was this for?">
                    </div>

                    <!-- Recurring Options -->
                    <div class="space-y-3">
                        <div
                            class="flex items-center gap-3 bg-gray-50 dark:bg-dark-bg p-3 rounded-xl border border-gray-100 dark:border-dark-border">
                            <div class="flex items-center h-5">
                                <input id="txRecurring" type="checkbox"
                                    onchange="document.getElementById('recurringOptions').classList.toggle('hidden', !this.checked)"
                                    class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
                            </div>
                            <div class="flex-1">
                                <label for="txRecurring"
                                    class="text-sm font-medium text-gray-900 dark:text-gray-300 select-none cursor-pointer">Recurring
                                    Transaction</label>
                                <p class="text-xs text-gray-500 dark:text-gray-400">Automatically repeat this
                                    transaction</p>
                            </div>
                        </div>

                        <div id="recurringOptions" class="hidden pl-2 border-l-2 border-blue-500 ml-2">
                            <label class="block text-xs font-bold text-gray-400 uppercase mb-1 ml-1">Frequency</label>
                            <select id="txRecurrenceFreq"
                                class="w-full px-4 py-3 bg-gray-50 dark:bg-dark-bg border border-gray-200 dark:border-dark-border rounded-xl focus:bg-white dark:focus:bg-dark-surface focus:ring-2 focus:ring-blue-500 outline-none transition text-sm">
                                <option value="daily">Daily</option>
                                <option value="weekly">Weekly</option>
                                <option value="monthly" selected>Monthly</option>
                                <option value="yearly">Yearly</option>
                            </select>
                        </div>
                    </div>

                    <button type="submit" id="txSubmitBtn"
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl transition shadow-lg shadow-blue-200 mt-2">
                        Save Transaction
                    </button>
                </form>
            </div>
        </div>

        <!-- EXPORT MODAL -->
        <div id="exportModal" onclick="if(event.target === this) closeModal('exportModal')"
            class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-50 backdrop-blur-sm opacity-0 transition-opacity duration-300">
            <div
                class="bg-white dark:bg-dark-surface rounded-3xl p-8 w-full max-w-sm transform scale-95 transition-transform duration-300 shadow-2xl">
                <h2 class="text-xl font-bold text-gray-800 dark:text-gray-200 mb-4">Export Data</h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Duration</label>
                        <select id="exportDuration" onchange="toggleExportDates()"
                            class="w-full px-4 py-2 bg-gray-50 dark:bg-dark-bg border border-gray-200 dark:border-dark-border rounded-xl outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="current_month">Current Month</option>
                            <option value="last_3_months">Last 3 Months</option>
                            <option value="last_6_months">Last 6 Months</option>
                            <option value="current_year">Current Year</option>
                            <option value="all">All Time</option>
                            <option value="custom">Custom Range</option>
                        </select>
                    </div>
                    <div id="exportCustomDates" class="hidden grid grid-cols-2 gap-2">
                        <input type="date" id="exportStartDate" class="px-3 py-2 border rounded-lg text-sm">
                        <input type="date" id="exportEndDate" class="px-3 py-2 border rounded-lg text-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Format</label>
                        <div class="grid grid-cols-2 gap-3">
                            <button onclick="handleExport('csv')"
                                class="flex items-center justify-center gap-2 py-3 border border-gray-200 rounded-xl hover:bg-gray-50 font-medium text-gray-700 dark:text-gray-300">
                                <i class="fa-solid fa-file-csv text-green-600"></i> CSV
                            </button>
                            <button onclick="handleExport('pdf')"
                                class="flex items-center justify-center gap-2 py-3 border border-gray-200 rounded-xl hover:bg-gray-50 font-medium text-gray-700 dark:text-gray-300">
                                <i class="fa-solid fa-file-pdf text-red-500"></i> PDF
                            </button>
                        </div>
                    </div>
                </div>
                <button onclick="closeModal('exportModal')"
                    class="mt-4 w-full py-2 text-gray-400 hover:text-gray-600">Cancel</button>
            </div>
        </div>

        <!-- 2. ADD/EDIT ACCOUNT MODAL -->
        <div id="accountModal" onclick="if(event.target === this) closeModal('accountModal')"
            class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-50 backdrop-blur-sm opacity-0 transition-opacity duration-300">
            <div onclick="event.stopPropagation()"
                class="bg-white dark:bg-dark-surface rounded-3xl p-8 w-full max-w-md transform scale-95 transition-transform duration-300 shadow-2xl overflow-hidden relative">

                <div class="flex justify-between items-center mb-6">
                    <h2 id="accountModalTitle" class="text-2xl font-bold text-gray-800 dark:text-gray-200">Add Account
                    </h2>
                    <button onclick="closeModal('accountModal')"
                        class="w-8 h-8 rounded-full hover:bg-gray-100 dark:bg-dark-bg flex items-center justify-center text-gray-400"><i
                            class="fa-solid fa-xmark"></i></button>
                </div>

                <form id="accountForm" onsubmit="handleAccountSubmit(event)" class="space-y-5">
                    <input type="hidden" id="accountId">

                    <!-- 1. Category Selection -->
                    <div>
                        <label class="block text-xs font-bold text-gray-400 uppercase mb-2">Account Category</label>
                        <div class="grid grid-cols-2 gap-3">
                            <label class="cursor-pointer relative">
                                <input type="radio" name="accountCategory" value="asset" class="hidden peer" checked
                                    onchange="toggleAccountCategory()">
                                <div
                                    class="flex items-center justify-center py-3 rounded-xl bg-gray-50 border-2 border-transparent text-gray-500 font-bold transition peer-checked:bg-green-50 peer-checked:text-green-600 peer-checked:border-green-200">
                                    <i class="fa-solid fa-wallet mr-2"></i> Asset
                                </div>
                            </label>
                            <label class="cursor-pointer relative">
                                <input type="radio" name="accountCategory" value="liability" class="hidden peer"
                                    onchange="toggleAccountCategory()">
                                <div
                                    class="flex items-center justify-center py-3 rounded-xl bg-gray-50 border-2 border-transparent text-gray-500 font-bold transition peer-checked:bg-red-50 peer-checked:text-red-600 peer-checked:border-red-200">
                                    <i class="fa-solid fa-file-invoice-dollar mr-2"></i> Liability
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- 2. Type Chips (Dynamic) -->
                    <div>
                        <label class="block text-xs font-bold text-gray-400 uppercase mb-2">Account Type</label>

                        <!-- Asset Options -->
                        <div id="assetOptions" class="flex flex-wrap gap-2">
                            <label class="cursor-pointer">
                                <input type="radio" name="accountType" value="asset" class="hidden chip-radio" checked>
                                <span
                                    class="px-4 py-2 bg-gray-50 dark:bg-dark-bg border border-gray-200 dark:border-dark-border rounded-xl text-sm font-medium text-gray-600 transition hover:bg-gray-100 dark:bg-dark-bg">Bank
                                    / Cash</span>
                            </label>
                            <label class="cursor-pointer">
                                <input type="radio" name="accountType" value="general" class="hidden chip-radio">
                                <span
                                    class="px-4 py-2 bg-gray-50 dark:bg-dark-bg border border-gray-200 dark:border-dark-border rounded-xl text-sm font-medium text-gray-600 transition hover:bg-gray-100 dark:bg-dark-bg">People
                                    (Lending)</span>
                            </label>
                        </div>

                        <!-- Liability Options -->
                        <div id="liabilityOptions" class="flex flex-wrap gap-2 hidden">
                            <label class="cursor-pointer">
                                <input type="radio" name="accountType" value="credit_card" class="hidden chip-radio"
                                    onchange="toggleCCFields()">
                                <span
                                    class="px-4 py-2 bg-gray-50 dark:bg-dark-bg border border-gray-200 dark:border-dark-border rounded-xl text-sm font-medium text-gray-600 transition hover:bg-gray-100 dark:bg-dark-bg">Credit
                                    Card</span>
                            </label>
                            <label class="cursor-pointer">
                                <input type="radio" name="accountType" value="payable" class="hidden chip-radio"
                                    onchange="toggleCCFields()">
                                <span
                                    class="px-4 py-2 bg-gray-50 dark:bg-dark-bg border border-gray-200 dark:border-dark-border rounded-xl text-sm font-medium text-gray-600 transition hover:bg-gray-100 dark:bg-dark-bg">People
                                    (Borrowing)</span>
                            </label>
                        </div>
                    </div>

                    <!-- 3. Details -->
                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-400 uppercase mb-1 ml-1">Account
                                Name</label>
                            <input type="text" id="accountName" required
                                class="w-full px-4 py-3 bg-gray-50 dark:bg-dark-bg border border-gray-200 dark:border-dark-border rounded-xl focus:bg-white dark:focus:bg-dark-surface focus:ring-2 focus:ring-blue-500 outline-none transition font-medium text-gray-800 dark:text-gray-200"
                                placeholder="e.g. Chase Bank">
                        </div>

                        <!-- Credit Card Specifics -->
                        <!-- Credit Card Specifics -->
                        <div id="creditCardFields"
                            class="hidden grid grid-cols-2 gap-4 p-4 bg-gray-50 dark:bg-dark-bg rounded-2xl border border-gray-100 dark:border-dark-border fade-in">
                            <div>
                                <label
                                    class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-1">Billing
                                    Day</label>
                                <input type="number" id="accountBillingDay" min="1" max="31" placeholder="Day (1-31)"
                                    class="w-full px-3 py-2 bg-white dark:bg-dark-surface border border-gray-200 dark:border-dark-border rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition text-sm text-center font-bold text-gray-700 dark:text-gray-200">
                            </div>
                            <div>
                                <label
                                    class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-1">Grace
                                    Period</label>
                                <input type="number" id="accountGracePeriod" min="0" placeholder="Days"
                                    class="w-full px-3 py-2 bg-white dark:bg-dark-surface border border-gray-200 dark:border-dark-border rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition text-sm text-center font-bold text-gray-700 dark:text-gray-200">
                            </div>
                            <div class="col-span-2">
                                <label
                                    class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-1">Credit
                                    Limit</label>
                                <div class="relative">
                                    <span id="accLimitCurrency"
                                        class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 font-bold text-xs">$</span>
                                    <input type="number" id="accountLimit" placeholder="Total Limit"
                                        class="w-full pl-6 pr-3 py-2 bg-white dark:bg-dark-surface border border-gray-200 dark:border-dark-border rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition text-sm font-bold text-gray-700 dark:text-gray-200">
                                </div>
                            </div>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-gray-400 uppercase mb-1 ml-1">Current
                                Balance</label>
                            <div class="relative">
                                <span id="accBalCurrency"
                                    class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-500 font-bold">$</span>
                                <input type="number" id="accountOpeningBalance" step="0.01" required
                                    class="w-full pl-8 pr-4 py-3 bg-gray-50 dark:bg-dark-bg border border-gray-200 dark:border-dark-border rounded-xl focus:bg-white dark:focus:bg-dark-surface focus:ring-2 focus:ring-blue-500 outline-none transition font-bold text-lg text-gray-800 dark:text-gray-200"
                                    placeholder="0.00">
                            </div>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-gray-400 uppercase mb-1 ml-1">Notes / Bank
                                Details (Optional)</label>
                            <textarea id="accountNotes" rows="2"
                                class="w-full px-4 py-3 bg-gray-50 dark:bg-dark-bg border border-gray-200 dark:border-dark-border rounded-xl focus:bg-white dark:focus:bg-dark-surface focus:ring-2 focus:ring-blue-500 outline-none transition font-medium text-gray-800 dark:text-gray-200 text-sm"
                                placeholder="Account Number, Branch, etc."></textarea>
                        </div>
                    </div>

                    <div class="pt-2">
                        <button type="submit" id="accountSubmitBtn"
                            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl transition shadow-lg shadow-blue-200">
                            Save Account
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 3. ADD/EDIT CATEGORY MODAL -->
        <div id="categoryModal"
            class="fixed inset-0 bg-black/40 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4 opacity-0 transition-opacity duration-200">
            <div
                class="bg-white dark:bg-dark-surface rounded-3xl shadow-2xl w-full max-w-sm overflow-hidden transform scale-95 transition-transform duration-200">
                <div
                    class="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50/50 dark:bg-dark-bg/50">
                    <h3 id="categoryModalTitle" class="font-bold text-lg text-gray-800 dark:text-gray-200">Add New
                        Category
                    </h3>
                    <button onclick="closeModal('categoryModal')"
                        class="w-8 h-8 rounded-full hover:bg-gray-100 dark:bg-dark-bg flex items-center justify-center text-gray-500"><i
                            class="fa-solid fa-xmark"></i></button>
                </div>

                <form id="categoryForm" onsubmit="handleCategorySubmit(event)" class="p-6 space-y-5">
                    <input type="hidden" id="categoryId" value="">

                    <div class="flex bg-gray-100 dark:bg-dark-bg p-1 rounded-xl">
                        <label class="flex-1 cursor-pointer">
                            <input type="radio" name="categoryType" value="income" class="hidden chip-radio">
                            <span
                                class="flex items-center justify-center py-2 rounded-lg text-sm font-medium text-gray-500 transition-all hover:bg-white/50">Income</span>
                        </label>
                        <label class="flex-1 cursor-pointer">
                            <input type="radio" name="categoryType" value="expense" checked class="hidden chip-radio">
                            <span
                                class="flex items-center justify-center py-2 rounded-lg text-sm font-medium text-gray-500 transition-all hover:bg-white/50">Expense</span>
                        </label>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-gray-400 uppercase mb-1 ml-1">Category Name</label>
                        <input type="text" id="categoryName" required
                            class="w-full px-4 py-3 bg-gray-50 dark:bg-dark-bg border border-gray-200 dark:border-dark-border rounded-xl focus:bg-white dark:focus:bg-dark-surface focus:ring-2 focus:ring-blue-500 outline-none transition text-sm"
                            placeholder="e.g., Groceries, Rent">
                    </div>

                    <button type="submit" id="categorySubmitBtn"
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl transition">
                        Save Category
                    </button>
                </form>
            </div>
        </div>















        <script>
            const APP_ID = 'flow_finance_v1';

            function generateId(prefix = '') {
                return (prefix ? prefix + '_' : '') + Math.random().toString(36).substr(2, 9) + Date.now().toString(36);
            }
            let store = {
                transactions: [],
                accounts: [],
                categories: [],
                budgets: [], // New
                settings: { currency: 'USD' } // New
            };

            // Global Dashboard Date
            let dashboardDate = new Date();

            const DEFAULT_CATEGORIES = [
                { id: 'c1', name: 'Salary', type: 'income' },
                { id: 'c2', name: 'Investment', type: 'income' },
                { id: 'c3', name: 'Food & Dining', type: 'expense' },
                { id: 'c4', name: 'Transportation', type: 'expense' },
                { id: 'c5', name: 'Shopping', type: 'expense' },
                { id: 'c6', name: 'Housing', type: 'expense' },
                { id: 'c7', name: 'Entertainment', type: 'expense' },
                { id: 'c8', name: 'Utilities', type: 'expense' }
            ];

            // --- CORE FUNCTIONS ---

            // --- ENCRYPTION SERVICE (Web Crypto API) ---
            const EncryptionService = {
                algo: { name: 'AES-GCM', length: 256 },
                kdf: { name: 'PBKDF2', hash: 'SHA-256', iterations: 100000 },

                // Generate a key from answers (low entropy input, high iterations)
                async deriveRecoveryKey(answersJson, salt) {
                    const enc = new TextEncoder();
                    // Normalization: Lowercase, trimmed, joined by |
                    const keyMaterialStr = answersJson.map(a => a.toLowerCase().trim()).join('|');
                    const keyMaterial = await window.crypto.subtle.importKey(
                        'raw', enc.encode(keyMaterialStr), 'PBKDF2', false, ['deriveKey']
                    );
                    return window.crypto.subtle.deriveKey(
                        { ...this.kdf, salt: salt, iterations: 500000 }, // Higher iterations for security
                        keyMaterial,
                        this.algo,
                        false,
                        ['encrypt', 'decrypt']
                    );
                },

                async backupPassword(password, answers) {
                    const salt = window.crypto.getRandomValues(new Uint8Array(16));
                    const iv = window.crypto.getRandomValues(new Uint8Array(12));
                    const key = await this.deriveRecoveryKey(answers, salt);
                    const enc = new TextEncoder();
                    const encrypted = await window.crypto.subtle.encrypt(
                        { name: this.algo.name, iv: iv },
                        key,
                        enc.encode(password)
                    );

                    const buffer = new Uint8Array(salt.byteLength + iv.byteLength + encrypted.byteLength);
                    buffer.set(salt, 0);
                    buffer.set(iv, salt.byteLength);
                    buffer.set(new Uint8Array(encrypted), salt.byteLength + iv.byteLength);

                    return this.bufferToBase64(buffer);
                },

                async recoverPassword(backupData, answers) {
                    try {
                        const buffer = this.base64ToBuffer(backupData);
                        const salt = buffer.slice(0, 16);
                        const iv = buffer.slice(16, 28);
                        const data = buffer.slice(28);

                        const key = await this.deriveRecoveryKey(answers, salt);
                        const decrypted = await window.crypto.subtle.decrypt(
                            { name: this.algo.name, iv: iv },
                            key,
                            data
                        );
                        return new TextDecoder().decode(decrypted);
                    } catch (e) {
                        throw new Error('Incorrect Security Answers');
                    }
                },

                async deriveKey(password, salt) {
                    const enc = new TextEncoder();
                    const keyMaterial = await window.crypto.subtle.importKey(
                        'raw', enc.encode(password), 'PBKDF2', false, ['deriveKey']
                    );
                    return window.crypto.subtle.deriveKey(
                        { ...this.kdf, salt: salt },
                        keyMaterial,
                        this.algo,
                        false,
                        ['encrypt', 'decrypt']
                    );
                },

                async encrypt(data, password) {
                    const salt = window.crypto.getRandomValues(new Uint8Array(16));
                    const iv = window.crypto.getRandomValues(new Uint8Array(12));
                    const key = await this.deriveKey(password, salt);
                    const enc = new TextEncoder();
                    const encrypted = await window.crypto.subtle.encrypt(
                        { name: this.algo.name, iv: iv },
                        key,
                        enc.encode(data)
                    );

                    // Pack: salt + iv + encrypted
                    const buffer = new Uint8Array(salt.byteLength + iv.byteLength + encrypted.byteLength);
                    buffer.set(salt, 0);
                    buffer.set(iv, salt.byteLength);
                    buffer.set(new Uint8Array(encrypted), salt.byteLength + iv.byteLength);

                    return this.bufferToBase64(buffer);
                },

                async decrypt(base64Data, password) {
                    try {
                        const buffer = this.base64ToBuffer(base64Data);
                        const salt = buffer.slice(0, 16);
                        const iv = buffer.slice(16, 28);
                        const data = buffer.slice(28);

                        const key = await this.deriveKey(password, salt);
                        const decrypted = await window.crypto.subtle.decrypt(
                            { name: this.algo.name, iv: iv },
                            key,
                            data
                        );
                        return new TextDecoder().decode(decrypted);
                    } catch (e) {
                        throw new Error('Incorrect Password');
                    }
                },

                bufferToBase64(buf) {
                    return btoa(String.fromCharCode(...new Uint8Array(buf)));
                },

                base64ToBuffer(str) {
                    return Uint8Array.from(atob(str), c => c.charCodeAt(0));
                }
            };

            // Global State for Encryption
            let currentPassword = null;
            let isAppLocked = false;
            let unlockListenerAdded = false;

            // Navigation State
            window.navState = { mode: 'sidebar', index: 0 };
            window.activeRoute = 'dashboard';

            // Route History for back navigation
            let routeHistory = ['dashboard'];

            // --- LOCAL STORAGE WRAPPER ---
            function loadStore() {
                const encrypted = localStorage.getItem('flow_encrypted_v1');
                if (encrypted) {
                    // App is Locked
                    isAppLocked = true;
                    document.getElementById('unlockModal').classList.remove('hidden');
                    document.getElementById('appContainer').classList.add('blur-sm', 'pointer-events-none');
                    if (!unlockListenerAdded) {
                        document.getElementById('unlockForm').addEventListener('submit', handleUnlock);
                        unlockListenerAdded = true;
                    }
                    if (localStorage.getItem('flow_recovery_v1')) {
                        document.getElementById('recoveryLinkContainer').classList.remove('hidden');
                    }
                    return null; // Defer loading
                }

                // Normal Load
                const saved = localStorage.getItem(APP_ID);
                return saved ? JSON.parse(saved) : null;
            }

            async function handleUnlock(e) {
                e.preventDefault();
                const pwd = document.getElementById('unlockPassword').value;
                const encrypted = localStorage.getItem('flow_encrypted_v1');
                const errorMsg = document.getElementById('unlockError');

                try {
                    errorMsg.classList.add('hidden');
                    const json = await EncryptionService.decrypt(encrypted, pwd);
                    store = JSON.parse(json);

                    // Unlock Success
                    currentPassword = pwd;
                    isAppLocked = false;
                    document.getElementById('unlockModal').classList.add('hidden');
                    document.getElementById('appContainer').classList.remove('blur-sm', 'pointer-events-none');

                    // Resume Init
                    finishInit();
                } catch (err) {
                    console.error(err);
                    errorMsg.innerText = 'Incorrect Password. Please try again.';
                    errorMsg.classList.remove('hidden');
                    document.getElementById('unlockPassword').value = '';
                }
            }

            function finishInit() {
                if (!store) {
                    store = {
                        user: { name: 'User', currency: 'USD' },
                        accounts: [
                            { id: generateId('acc'), name: 'Cash', type: 'asset', openingBalance: 0 },
                            { id: generateId('acc'), name: 'Bank', type: 'asset', openingBalance: 0 }
                        ],
                        categories: [
                            { id: 'c1', name: 'Food', type: 'expense' },
                            { id: 'c2', name: 'Salary', type: 'income' },
                            { id: 'c3', name: 'Transport', type: 'expense' },
                            { id: 'c4', name: 'Utilities', type: 'expense' },
                            { id: 'c5', name: 'Entertainment', type: 'expense' }
                        ],
                        transactions: [],
                        settings: { theme: 'light', currency: 'USD', dateFormat: 'yyyy-mm-dd' }
                    };
                }

                initHistory();

                // PWA Service Worker Registration
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.register('./sw.js')
                        .then(() => console.log('Service Worker Registered'))
                        .catch(err => console.error('SW Registration Failed:', err));
                }


                applyTheme(store.settings.theme);
                checkAutoDarkMode();

                // Check auto dark mode every 5 minutes
                setInterval(checkAutoDarkMode, 5 * 60 * 1000);

                router('dashboard');
                window.navState.mode = 'sidebar';
            }

            function init() {
                // Try Loading Store
                const loaded = loadStore();

                if (loaded === null && isAppLocked) {
                    // Waiting for Unlock...
                    return;
                }

                store = loaded || {
                    user: { name: 'User', currency: 'USD' },
                    accounts: [
                        { id: generateId('acc'), name: 'Cash', type: 'asset', openingBalance: 0 },
                        { id: generateId('acc'), name: 'Bank', type: 'asset', openingBalance: 0 }
                    ],
                    categories: [
                        { id: 'c1', name: 'Food', type: 'expense' },
                        { id: 'c2', name: 'Salary', type: 'income' },
                        { id: 'c3', name: 'Transport', type: 'expense' },
                        { id: 'c4', name: 'Utilities', type: 'expense' },
                        { id: 'c5', name: 'Entertainment', type: 'expense' }
                    ],
                    transactions: [],
                    settings: { theme: 'light', currency: 'USD', dateFormat: 'yyyy-mm-dd' }
                };

                // Ensure all store keys exist (Robustness)
                const defaults = {
                    transactions: [], accounts: [], categories: DEFAULT_CATEGORIES,
                    settings: { theme: 'light', currency: 'USD', dateFormat: 'yyyy-mm-dd' }
                };
                Object.keys(defaults).forEach(key => {
                    if (!store[key]) store[key] = defaults[key];
                });

                if (!loaded) save();
                finishInit();
            }



            // --- SPATIAL NAVIGATION LOGIC ---

            function handleSpatialNav(key, shift) {
                const state = window.navState;

                // SIDEBAR MODE
                if (state.mode === 'sidebar') {
                    if (key === 'arrowdown' || (key === 'tab' && !shift)) {
                        navigateTabs(1);
                    } else if (key === 'arrowup' || (key === 'tab' && shift)) {
                        navigateTabs(-1);
                    } else if (key === 'arrowright' || key === 'enter') {
                        // Enter Content Area
                        enterContentArea();
                    } else if (key === 'arrowleft') {
                        // Maybe collapse sidebar? do nothing for now
                    }
                    return;
                }

                // CONTENT MODE
                if (state.mode === 'content') {
                    const items = getFocusableItems();
                    if (items.length === 0) return; // No items to nav

                    if (key === 'arrowdown') {
                        state.index = Math.min(state.index + 1, items.length - 1);
                    } else if (key === 'arrowup') {
                        state.index = Math.max(state.index - 1, 0);
                    } else if (key === 'arrowleft') {
                        // If Grid (like accounts), move left. If list (transactions), exit to sidebar
                        // Simple heuristic: check if grid layout
                        if (isGridLayout()) {
                            if (state.index === 0) { state.mode = 'sidebar'; clearFocus(); }
                            else state.index = Math.max(state.index - 1, 0);
                        } else {
                            state.mode = 'sidebar';
                            clearFocus();
                        }
                    } else if (key === 'arrowright') {
                        if (isGridLayout()) {
                            state.index = Math.min(state.index + 1, items.length - 1);
                        }
                    } else if (key === 'escape') {
                        state.mode = 'sidebar';
                        clearFocus();
                    } else if (key === 'enter') {
                        triggerItemAction(items[state.index]);
                    } else if (key === 'delete') {
                        triggerItemDelete(items[state.index]);
                    }

                    if (state.mode === 'content') renderFocus(items);
                }
            }

            function enterContentArea() {
                const items = getFocusableItems();
                if (items.length > 0) {
                    window.navState.mode = 'content';
                    window.navState.index = 0;
                    renderFocus(items);
                }
            }

            function getFocusableItems() {
                // Determine items based on current view
                // Accounts: .account-item
                // Transactions: #txTableBody tr
                // Banking: .banking-card (need to add class)
                // Credit Cards: .credit-card-item (need to add class)

                const activeLink = document.querySelector('.sidebar-item.active');
                const route = activeLink ? activeLink.getAttribute('onclick').match(/'([^']+)'/)[1] : '';

                if (route === 'accounts') return Array.from(document.querySelectorAll('.account-item:not(.hidden)'));
                if (route === 'transactions') return Array.from(document.querySelectorAll('#txTableBody tr'));

                return [];
            }

            function isGridLayout() {
                const activeLink = document.querySelector('.sidebar-item.active');
                const route = activeLink ? activeLink.getAttribute('onclick').match(/'([^']+)'/)[1] : '';
                return ['accounts'].includes(route);
            }

            function renderFocus(items = null) {
                clearFocus();
                if (!items) items = getFocusableItems();
                const idx = window.navState.index;
                if (items[idx]) {
                    items[idx].classList.add('kb-focused');
                    items[idx].scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            }

            function clearFocus() {
                document.querySelectorAll('.kb-focused').forEach(el => el.classList.remove('kb-focused'));
            }

            function triggerItemAction(el) {
                // Try to find a click handler or common action
                if (el.onclick) {
                    el.onclick();
                } else {
                    // Heuristics for specific elements
                    if (el.tagName === 'TR') { // Transaction Row
                        // The edit button inside? Or row click?
                        // Typically row has buttons. Let's find edit button or use ID
                        const btn = el.querySelector('.fa-pen-to-square')?.parentElement;
                        if (btn) btn.click();
                    }
                    // Account Item
                    if (el.classList.contains('account-item')) {
                        // Open Edit modal
                        const onclickStr = el.getAttribute('onclick');
                        if (onclickStr) {
                            // eval is dangerous, but onclick string execution is context dependent.
                            // simpler: create a click event
                            el.click();
                        }
                    }
                }
            }

            function triggerItemDelete(el) {
                if (el.classList.contains('account-item')) {
                    // Find delete button inside or use context
                    // Account items usually have a delete menu or button
                    // Current implementation: Accounts have a click -> Edit -> Delete in Modal.
                    // Shortcut: Trigger Click (Edit) -> Then user can delete.
                    // Or: Direct delete? Risks accidental data loss without ID knowledge.
                    // Safer: Open Edit Modal (Enter behavior)
                    triggerItemAction(el);
                } else if (el.tagName === 'TR') {
                    // Transaction
                    const btn = el.querySelector('.fa-trash')?.parentElement;
                    if (btn) btn.click();
                }
            }

            function handleGlobalSearch() {
                // If in Accounts: Focus Account Search
                // If in Transactions: Focus Tx Search
                const activeLink = document.querySelector('.sidebar-item.active');
                const route = activeLink ? activeLink.getAttribute('onclick').match(/'([^']+)'/)[1] : '';

                if (route === 'accounts') {
                    toggleAccountSearch();
                } else if (route === 'transactions') {
                    const inp = document.getElementById('txSearch');
                    if (inp) inp.focus();
                }
            }

            // --- HISTORY API (Undo/Redo) ---
            const MAX_HISTORY = 50;
            let historyStack = [];
            let historyIndex = -1;
            let isUndoRedo = false;

            function initHistory() {
                // Push initial state
                historyStack = [JSON.parse(JSON.stringify(store))];
                historyIndex = 0;
                updateUndoRedoUI();
            }

            async function save(skipHistory = false) {
                // Save to LocalStorage (Encrypted or Plain)
                if (currentPassword) {
                    try {
                        const json = JSON.stringify(store);
                        const encrypted = await EncryptionService.encrypt(json, currentPassword);
                        localStorage.setItem('flow_encrypted_v1', encrypted);
                        // Clear plain data for security
                        localStorage.removeItem(APP_ID);
                    } catch (e) {
                        console.error('Encryption Failed during save:', e);
                        showToast('Error saving encrypted data!', 'danger');
                    }
                } else {
                    localStorage.setItem(APP_ID, JSON.stringify(store));
                }

                // Push to History Stack
                if (!skipHistory && !isUndoRedo) {
                    // If we are in the middle of the stack, remove future states
                    if (historyIndex < historyStack.length - 1) {
                        historyStack = historyStack.slice(0, historyIndex + 1);
                    }

                    // Push new state
                    historyStack.push(JSON.parse(JSON.stringify(store)));

                    // Limit stack size
                    if (historyStack.length > MAX_HISTORY) {
                        historyStack.shift();
                    } else {
                        historyIndex++;
                    }
                    updateUndoRedoUI();
                }
            }

            function undo() {
                if (historyIndex > 0) {
                    isUndoRedo = true;
                    historyIndex--;
                    store = JSON.parse(JSON.stringify(historyStack[historyIndex]));
                    save(true); // Persist to LS without adding to stack

                    // Re-render current view
                    const activeLink = document.querySelector('.sidebar-item.active');
                    const route = activeLink ? activeLink.getAttribute('onclick').match(/'([^']+)'/)[1] : 'dashboard';
                    router(route);

                    isUndoRedo = false;
                    updateUndoRedoUI();
                    showToast('Undo Successful');
                }
            }

            function redo() {
                if (historyIndex < historyStack.length - 1) {
                    isUndoRedo = true;
                    historyIndex++;
                    store = JSON.parse(JSON.stringify(historyStack[historyIndex]));
                    save(true);

                    // Re-render
                    const activeLink = document.querySelector('.sidebar-item.active');
                    const route = activeLink ? activeLink.getAttribute('onclick').match(/'([^']+)'/)[1] : 'dashboard';
                    router(route);

                    isUndoRedo = false;
                    updateUndoRedoUI();
                    showToast('Redo Successful');
                }
            }

            function updateUndoRedoUI() {
                const undoBtn = document.getElementById('undoBtn');
                const redoBtn = document.getElementById('redoBtn');
                if (undoBtn) undoBtn.style.opacity = historyIndex > 0 ? '1' : '0.3';
                if (redoBtn) redoBtn.style.opacity = historyIndex < historyStack.length - 1 ? '1' : '0.3';
            }

            function router(route, options = {}) {
                // Options can be: { params: any, skipHistory: boolean }
                // For backward compatibility, if options is not an object, treat it as params
                let params = null;
                let skipHistory = false;

                if (options && typeof options === 'object' && !Array.isArray(options)) {
                    params = options.params || null;
                    skipHistory = options.skipHistory || false;
                } else {
                    // Legacy call: router('transactions', accountId)
                    params = options;
                }

                // Track navigation history for back button
                if (!skipHistory && routeHistory[routeHistory.length - 1] !== route) {
                    routeHistory.push(route);
                    // Keep history manageable
                    if (routeHistory.length > 20) routeHistory.shift();
                }

                // Sidebar Active State
                document.querySelectorAll('.sidebar-item').forEach(el => el.classList.remove('active'));
                const activeLink = document.querySelector(`.sidebar-item[onclick="router('${route}')"]`);
                if (activeLink) activeLink.classList.add('active');

                const content = document.getElementById('app-content');
                content.innerHTML = ''; // Clear

                if (route === 'dashboard') {
                    renderDashboard(content);
                }
                else if (route === 'accounts') renderAccounts(content);
                else if (route === 'reports') renderReports(content);
                else if (route === 'transactions') renderTransactions(content, params);

                else if (route === 'account_detail') renderAccountDetail(content, params);
                else if (route === 'settings') renderSettings(content);

                // Update global activeRoute for shortcuts
                window.activeRoute = route;
            }


            // --- HELPERS ---

            function getAccountBalance(accId) {
                const acc = store.accounts.find(a => a.id === accId);

                let bal = 0;
                if (acc) bal = acc.openingBalance || 0;
                else return 0;

                store.transactions.forEach(t => {
                    if (t.accountId === accId) {
                        if (t.type === 'income') bal += t.amount;
                        else bal -= t.amount;
                    }
                    if (t.toAccountId === accId && t.type === 'transfer') {
                        bal += t.amount;
                    }
                });
                return bal;
            }

            function getAccountName(id) {
                if (!id) return "Interest / System";
                const acc = store.accounts.find(a => a.id === id);
                if (acc) return acc.name;
                return "Unknown";
            }

            function formatMoney(amount) {
                if (typeof amount !== 'number') amount = parseFloat(amount) || 0;
                if (store.settings && store.settings.privacyMode) return '****';
                const symbol = (store.settings && store.settings.currency === 'INR') ? '' : '$';
                return symbol + amount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            }

            // Plain format for PDF (no special chars)
            function formatMoneyPlain(amount) {
                const symbol = (store.settings && store.settings.currency === 'INR') ? 'Rs ' : '$ ';
                return symbol + parseFloat(amount || 0).toFixed(2);
            }

            window.togglePrivacyMode = function () {
                if (!store.settings) store.settings = {};
                store.settings.privacyMode = !store.settings.privacyMode;
                save();
                // Refresh current view
                const active = window.activeRoute || 'dashboard';
                router(active);
            };

            function openModal(id) {
                const modal = document.getElementById(id);
                modal.classList.remove('hidden');
                void modal.offsetWidth; // Trigger reflow
                modal.classList.remove('opacity-0');
                modal.querySelector('div').classList.remove('scale-95');
            }

            function closeModal(id) {
                const modal = document.getElementById(id);
                modal.classList.add('opacity-0');
                modal.querySelector('div').classList.add('scale-95');
                setTimeout(() => modal.classList.add('hidden'), 200);
            }

            // --- RENDERERS ---

            // --- HELPERS FOR DASHBOARD ---
            function calculateTotal(type, month, year) {
                return store.transactions
                    .filter(t => {
                        const d = new Date(t.date);
                        return t.type === type && d.getMonth() === month && d.getFullYear() === year;
                    })
                    .reduce((sum, t) => sum + parseFloat(t.amount), 0);
            }

            function getCategoryTotals(type, month, year) {
                const totals = {};
                store.transactions
                    .filter(t => {
                        const d = new Date(t.date);
                        return t.type === type && d.getMonth() === month && d.getFullYear() === year;
                    })
                    .forEach(t => {
                        totals[t.categoryName] = (totals[t.categoryName] || 0) + parseFloat(t.amount);
                    });
                return totals;
            }

            function changeDashboardMonth(offset) {
                dashboardDate.setMonth(dashboardDate.getMonth() + offset);
                renderDashboard(document.getElementById('app-content'));
            }

            function renderDashboard(container) {
                const currentMonth = dashboardDate.getMonth();
                const currentYear = dashboardDate.getFullYear();
                const monthName = dashboardDate.toLocaleString('default', { month: 'long', year: 'numeric' });

                const inc = calculateTotal('income', currentMonth, currentYear);
                const exp = calculateTotal('expense', currentMonth, currentYear);
                const netProfit = inc - exp;

                // Net Worth Calculation (Global, not monthly)
                let totalAssets = 0;
                let totalLiabilities = 0;

                store.accounts.forEach(a => {
                    const bal = getAccountBalance(a.id);
                    if (a.type === 'asset' || a.type === 'receivable') {
                        totalAssets += bal;
                    } else if (a.type === 'liability' || a.type === 'payable') {
                        totalLiabilities += Math.abs(bal);
                    } else if (a.type === 'general') {
                        if (bal >= 0) totalAssets += bal;
                        else totalLiabilities += Math.abs(bal);
                    }
                });

                const netWorth = totalAssets - totalLiabilities;


                setTimeout(() => {
                    initMainChart();
                    initSavingsChart(); // New Chart
                    const incCats = getCategoryTotals('income', currentMonth, currentYear);
                    const expCats = getCategoryTotals('expense', currentMonth, currentYear);

                    // Income Colors (Greens)
                    const incomeColors = ['#1e8e3e', '#34a853', '#81c995', '#a8dab5', '#5bb974', '#0d652d', '#137333', '#e6f4ea'];
                    // Expense Colors (Reds/Oranges/Mixed)
                    const expenseColors = ['#d93025', '#ea4335', '#f28b82', '#ff6384', '#ff9f40', '#ffcd56', '#c5221f', '#b31412'];

                    initDonut('incChart', incCats, incomeColors, 'incLegend');
                    initDonut('expChart', expCats, expenseColors, 'expLegend');
                }, 0);

                container.innerHTML = `
                <div class="max-w-7xl mx-auto space-y-6 fade-in pb-10">
                    
                    <!-- Month Navigation & Privacy -->
                    <!-- Month Navigation & Privacy -->
                    <div class="relative flex items-center justify-center bg-white dark:bg-dark-surface p-4 rounded-3xl shadow-sm border border-gray-100 dark:border-dark-border">
                         <div class="flex items-center gap-2">
                             <button onclick="changeDashboardMonth(-1)" class="w-10 h-10 flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-600 transition">
                                <i class="fa-solid fa-chevron-left"></i>
                            </button>
                            <h2 class="text-xl font-bold text-gray-800 dark:text-gray-200 flex items-center gap-2">
                                 <i class="fa-solid fa-calendar-days text-blue-500"></i> ${monthName}
                            </h2>
                            <button onclick="changeDashboardMonth(1)" class="w-10 h-10 flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-600 transition">
                                <i class="fa-solid fa-chevron-right"></i>
                            </button>
                        </div>
                        <div class="absolute right-4 top-1/2 transform -translate-y-1/2">
                            <button onclick="togglePrivacyMode()" class="w-10 h-10 flex items-center justify-center rounded-full bg-gray-50 dark:bg-dark-bg text-gray-500 hover:text-blue-600 transition" title="Toggle Privacy Mode (Shift+H)">
                                <i class="fa-solid ${store.settings?.privacyMode ? 'fa-eye-slash' : 'fa-eye'}"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Top Metrics -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div onclick="router('transactions', { type: 'income' })" class="cursor-pointer bg-white dark:bg-dark-surface p-5 rounded-3xl shadow-sm border border-gray-100 dark:border-dark-border hover:shadow-md transition group">
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 rounded-2xl bg-green-50 text-green-600 flex items-center justify-center text-xl group-hover:scale-110 transition"><i class="fa-solid fa-arrow-trend-up"></i></div>
                                <div>
                                    <p class="text-xs font-bold text-gray-400 uppercase tracking-wide">Total Income</p>
                                    <p class="text-2xl font-bold text-gray-900 dark:text-gray-100">${formatMoney(inc)}</p>
                                </div>
                            </div>
                        </div>
                        <div onclick="router('transactions', { type: 'expense' })" class="cursor-pointer bg-white dark:bg-dark-surface p-5 rounded-3xl shadow-sm border border-gray-100 dark:border-dark-border hover:shadow-md transition group">
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 rounded-2xl bg-red-50 text-red-600 flex items-center justify-center text-xl group-hover:scale-110 transition"><i class="fa-solid fa-arrow-trend-down"></i></div>
                                <div>
                                    <p class="text-xs font-bold text-gray-400 uppercase tracking-wide">Total Expense</p>
                                    <p class="text-2xl font-bold text-gray-900 dark:text-gray-100">${formatMoney(exp)}</p>
                                </div>
                            </div>
                        </div>
                        <div onclick="router('transactions', { month: 'current' })" class="cursor-pointer bg-white dark:bg-dark-surface p-5 rounded-3xl shadow-sm border border-gray-100 dark:border-dark-border hover:shadow-md transition group">
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 rounded-2xl bg-indigo-50 text-indigo-600 flex items-center justify-center text-xl group-hover:scale-110 transition"><i class="fa-solid fa-calendar-check"></i></div>
                                <div>
                                    <p class="text-xs font-bold text-gray-400 uppercase tracking-wide">Net Profit</p>
                                    <p class="text-2xl font-bold ${netProfit >= 0 ? 'text-green-600' : 'text-red-600'}">${formatMoney(netProfit)}</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-blue-600 text-white p-5 rounded-3xl shadow-lg shadow-blue-200">
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 rounded-2xl bg-white/20 flex items-center justify-center text-xl text-white"><i class="fa-solid fa-wallet"></i></div>
                                <div>
                                    <p class="text-xs font-bold text-blue-100 uppercase tracking-wide">Net Worth</p>
                                    <p class="text-2xl font-bold">${formatMoney(netWorth)}</p>
                                </div>
                            </div>

                        </div>
                    </div>

                    <!-- Charts Grid (2x2) -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        
                        <!-- 1. Cash Flow (Income vs Expense) -->
                        <div class="bg-white dark:bg-dark-surface p-6 rounded-3xl shadow-sm border border-gray-100 dark:border-dark-border">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="font-bold text-gray-800 dark:text-gray-200">Cash Flow (6 Months)</h3>
                            </div>
                            <div class="h-64 w-full">
                                <canvas id="mainChart"></canvas>
                            </div>
                        </div>

                         <!-- 2. Monthly Savings Trend (New) -->
                        <div class="bg-white dark:bg-dark-surface p-6 rounded-3xl shadow-sm border border-gray-100 dark:border-dark-border">
                             <div class="flex justify-between items-center mb-4">
                                <h3 class="font-bold text-gray-800 dark:text-gray-200">Monthly Savings Trend</h3>
                            </div>
                            <div class="h-64 w-full">
                                <canvas id="savingsChart"></canvas>
                            </div>
                        </div>

                        <!-- 3. Income Breakdown -->
                        <div class="bg-white dark:bg-dark-surface p-6 rounded-3xl shadow-sm border border-gray-100 dark:border-dark-border flex flex-col items-center">
                            <h3 class="font-bold text-gray-700 dark:text-gray-300 text-sm mb-3 self-start w-full border-b border-gray-50 dark:border-gray-800 pb-2">Income Sources</h3>
                            <div class="w-56 h-56 relative">
                                <canvas id="incChart"></canvas>
                            </div>
                            <div id="incLegend" class="mt-4 w-full space-y-2 text-xs"></div>
                        </div>

                        <!-- 4. Expense Breakdown -->
                        <div class="bg-white dark:bg-dark-surface p-6 rounded-3xl shadow-sm border border-gray-100 dark:border-dark-border flex flex-col items-center">
                            <h3 class="font-bold text-gray-700 dark:text-gray-300 text-sm mb-3 self-start w-full border-b border-gray-50 dark:border-gray-800 pb-2">Expense Breakdown</h3>
                             <div class="w-56 h-56 relative">
                                <canvas id="expChart"></canvas>
                            </div>
                            <div id="expLegend" class="mt-4 w-full space-y-2 text-xs"></div>
                        </div>

                    </div>
                </div>
            `;
            }

            // Account utility functions defined below in main functions section

            function toggleAccountSearch() {
                const container = document.getElementById('accountSearchContainer');
                const input = document.getElementById('accountSearchInput');
                container.classList.toggle('hidden');
                if (!container.classList.contains('hidden')) {
                    input.focus();
                } else {
                    input.value = '';
                    searchAccounts('');
                }
            }

            function searchAccounts(query) {
                query = query.toLowerCase();
                // Filter both Grid cards and List rows
                const items = document.querySelectorAll('.account-item');
                let visibleCount = 0;
                items.forEach(item => {
                    const name = item.getAttribute('data-name')?.toLowerCase() || '';
                    const type = item.getAttribute('data-type')?.toLowerCase() || '';
                    if (name.includes(query) || type.includes(query)) {
                        item.classList.remove('hidden');
                        visibleCount++;
                    } else {
                        item.classList.add('hidden');
                    }
                });

                // Handle group headers visibility
                document.querySelectorAll('.account-group').forEach(group => {
                    const visibleItems = group.querySelectorAll('.account-item:not(.hidden)');
                    if (visibleItems.length === 0) group.classList.add('hidden');
                    else group.classList.remove('hidden');
                });
            }

            function renderAccounts(container) {
                const groups = { asset: [], liability: [], general: [] };
                const totals = { asset: 0, liability: 0, general: 0 };

                // View Preferences
                const grouping = localStorage.getItem('accountGrouping') || 'grouped';
                const view = localStorage.getItem('accountView') || 'grid';
                const sortBy = localStorage.getItem('accountSort') || 'balance-desc';

                store.accounts.forEach(acc => {
                    const bal = getAccountBalance(acc.id);
                    // Migrate old types to general if needed, or just handle them as general for display
                    let type = acc.type;
                    if (type === 'receivable' || type === 'payable') type = 'general';

                    // Grouping for Display
                    if (groups[type]) {
                        groups[type].push({ ...acc, balance: bal });
                        totals[type] += bal;
                    } else {
                        // Fall back
                        if (!groups.general) groups.general = [];
                        groups.general.push({ ...acc, balance: bal });
                        totals.general += bal;
                    }
                });

                // Sort Logic
                const [sortField, sortDir] = sortBy.split('-');
                const sortFn = (a, b) => {
                    let valA, valB;
                    if (sortField === 'name') {
                        valA = a.name.toLowerCase();
                        valB = b.name.toLowerCase();
                    } else { // balance
                        valA = a.balance;
                        valB = b.balance;
                    }

                    if (sortDir === 'asc') {
                        return valA > valB ? 1 : valA < valB ? -1 : 0;
                    } else {
                        return valA < valB ? 1 : valA > valB ? -1 : 0;
                    }
                };

                // Apply sorting to all groups
                Object.keys(groups).forEach(key => groups[key].sort(sortFn));

                // Net Worth Calc
                let totalAssets = totals.asset;
                let totalLiabilities = Math.abs(totals.liability);

                // General Split for Calculation
                let generalNet = 0;
                groups.general.forEach(a => {
                    generalNet += a.balance;
                    if (a.balance >= 0) totalAssets += a.balance;
                    else totalLiabilities += Math.abs(a.balance);
                });

                // Net Worth = Total Assets - Total Liabilities
                let netWorth = totalAssets - totalLiabilities;

                const summaryCards = [
                    { label: 'Total Assets', val: totalAssets, bg: 'bg-green-500', icon: 'fa-sack-dollar', type: 'asset' },
                    { label: 'Total Liabilities', val: totalLiabilities, bg: 'bg-red-500', icon: 'fa-file-invoice-dollar', type: 'liability' },
                    { label: 'Persons (Net)', val: generalNet, bg: 'bg-blue-400', icon: 'fa-user-group', type: 'general' },
                    { label: 'Net Worth', val: netWorth, bg: 'bg-purple-500', icon: 'fa-chart-line', type: 'all' },
                ];


                const renderAccountCard = (acc) => {
                    const typeColor = {
                        asset: 'text-green-600 bg-green-50',
                        liability: 'text-red-600 bg-red-50',
                        receivable: 'text-cyan-600 bg-cyan-50',
                        payable: 'text-orange-600 bg-orange-50',
                        overdraft: 'text-pink-600 bg-pink-50'
                    }[acc.type] || 'text-gray-600 bg-gray-50 dark:bg-dark-bg';

                    const typeLabel = (['asset'].includes(acc.type)) ? 'Asset' :
                        (['liability', 'overdraft'].includes(acc.type)) ? 'Liability' :
                            (acc.type === 'general' ? 'Person' : 'Other');

                    return `
            <div onclick="router('account_detail', '${acc.id}')" data-type="${acc.type}" data-name="${acc.name}"
                class="account-item bg-white dark:bg-dark-surface p-6 rounded-3xl shadow-sm border border-gray-100 dark:border-dark-border hover:shadow-md transition cursor-pointer group">
                <div class="flex justify-between items-start mb-4">
                    <div class="w-12 h-12 rounded-2xl ${typeColor} flex items-center justify-center text-xl">
                        <i class="fa-solid ${(acc.name.toLowerCase().includes('card') ? 'fa-credit-card' : (acc.name.toLowerCase().includes('cash') ? 'fa-money-bill' : (acc.type === 'general' ? 'fa-user' : 'fa-building-columns')))}"></i>
                    </div>
                    <div class="bg-gray-100 dark:bg-dark-bg text-gray-500 dark:text-gray-400 px-3 py-1 rounded-full text-xs font-semibold uppercase tracking-wide group-hover:bg-gray-200 dark:group-hover:bg-dark-border transition">
                        ${typeLabel}
                    </div>
                </div>
                <div>
                    <h3 class="font-bold text-gray-700 dark:text-gray-300 text-lg">${acc.name}</h3>
                    <p class="text-2xl font-bold ${acc.balance < 0 ? 'text-red-500' : 'text-gray-900 dark:text-gray-100'} mt-2">${formatMoney(acc.balance)}</p>
                    <div class="mt-1">
                         <p class="text-xs text-gray-400 capitalize inline-block mr-2">${acc.type.replace('_', ' ')}</p>
                         ${acc.notes ? `<span class="text-xs text-gray-400" title="${acc.notes}"><i class="fa-solid fa-circle-info text-blue-400"></i></span>` : ''}
                    </div>
                </div>
            </div>
            `;
                };

                const renderAccountListRow = (acc) => {
                    const typeColor = {
                        asset: 'text-green-600 bg-green-50',
                        liability: 'text-red-600 bg-red-50',
                        receivable: 'text-cyan-600 bg-cyan-50',
                        payable: 'text-orange-600 bg-orange-50',
                        overdraft: 'text-pink-600 bg-pink-50'
                    }[acc.type] || 'text-gray-600 bg-gray-50 dark:bg-dark-bg';

                    const typeLabel = (['asset'].includes(acc.type)) ? 'Asset' :
                        (['liability', 'overdraft'].includes(acc.type)) ? 'Liability' :
                            (acc.type === 'general' ? 'Person' : 'Other');

                    // Read-only list row (Removed action buttons)
                    return `
                <tr data-type="${acc.type}" data-name="${acc.name}" onclick="router('account_detail', '${acc.id}')"
                    class="account-item hover:bg-gray-50 dark:hover:bg-dark-bg transition cursor-pointer group border-b border-gray-50 dark:border-dark-border last:border-0">
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-xl ${typeColor} flex items-center justify-center">
                                <i class="fa-solid ${acc.name.toLowerCase().includes('card') ? 'fa-credit-card' : (acc.name.toLowerCase().includes('cash') ? 'fa-money-bill' : (acc.type === 'general' ? 'fa-user' : 'fa-building-columns'))}"></i>
                            </div>
                            <div>
                                <h4 class="font-bold text-gray-700 dark:text-gray-300">${acc.name}</h4>
                                <span class="text-xs text-gray-400 uppercase">${typeLabel}</span>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 text-right">
                        <p class="text-lg font-bold ${acc.balance < 0 ? 'text-red-500' : 'text-gray-900 dark:text-gray-100'}">${formatMoney(acc.balance)}</p>
                    </td>
                </tr>
                `;
                };

                const renderGroup = (items, title) => {
                    if (!items || items.length === 0) return '';

                    if (view === 'list') {
                        return `
    <div class="account-group mb-8" data-group-type="${title.toLowerCase()}">
        <h3 class="font-bold text-gray-700 dark:text-gray-300 text-lg mb-4 capitalize border-b border-gray-100 dark:border-dark-border pb-2">${title}</h3>
        <div class="bg-white dark:bg-dark-surface rounded-2xl shadow-sm border border-gray-100 dark:border-dark-border overflow-hidden">
            <table class="w-full">
                <tbody class="divide-y divide-gray-100 dark:divide-dark-border">
                    ${items.map(acc => renderAccountListRow(acc)).join('')}
                </tbody>
            </table>
        </div>
    </div>
    `;
                    } else {
                        // Grid view (default)
                        return `
    <div class="account-group mb-8" data-group-type="${title.toLowerCase()}">
        <h3 class="font-bold text-gray-700 dark:text-gray-300 text-lg mb-4 capitalize border-b border-gray-100 dark:border-dark-border pb-2">${title}</h3>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
            ${items.map(acc => renderAccountCard(acc)).join('')}
        </div>
    </div>
    `;
                    }
                };

                // Generate Account Content HTML
                let accountContentHtml = '';

                if (grouping === 'unified') {
                    // Unified View: Combine all accounts
                    let allAccounts = [...groups.asset, ...groups.liability, ...groups.general];

                    // Sort again (already sorted within groups, but need to sort combined list)
                    allAccounts.sort(sortFn);

                    if (allAccounts.length === 0) {
                        accountContentHtml = '<div class="text-center text-gray-400 py-8">No accounts found. Add one above.</div>';
                    } else {
                        // Render as a single group named 'All Accounts'
                        if (view === 'list') {
                            accountContentHtml = `
                        <div class="bg-white dark:bg-dark-surface rounded-2xl shadow-sm border border-gray-100 dark:border-dark-border overflow-hidden">
                            <table class="w-full">
                                <tbody class="divide-y divide-gray-100 dark:divide-dark-border">
                                    ${allAccounts.map(acc => renderAccountListRow(acc)).join('')}
                                </tbody>
                            </table>
                        </div>`;
                        } else {
                            accountContentHtml = `
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                             ${allAccounts.map(acc => renderAccountCard(acc)).join('')}
                        </div>`;
                        }
                    }
                }
                else {
                    // Grouped View
                    accountContentHtml = `
                <div id="accountListGrid" class="space-y-2">
                    ${renderGroup(groups.asset, 'Assets')}
                    ${renderGroup(groups.liability, 'Liabilities')}
                    ${renderGroup(groups.general, 'Persons / Lending & Borrowing')}
                    ${(groups.asset.length + groups.liability.length + groups.general.length) === 0 ? '<div class="text-center text-gray-400 py-8">No accounts found. Add one above.</div>' : ''}
                </div>`;
                }


                container.innerHTML = `
    <div class="max-w-7xl mx-auto space-y-8 fade-in">
        <div class="flex flex-col md:flex-row justify-between items-end gap-4">
            <div>
                <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-200">Accounts</h2>
                <p class="text-gray-500">Manage assets, liabilities, debts & persons</p>
            </div>
            <!-- Search & Add & View Toggle -->
            <div class="flex items-center gap-2">
                 <button onclick="openAccountModal()" class="w-10 h-10 rounded-full bg-blue-600 text-white flex items-center justify-center hover:bg-blue-700 transition shadow-lg shadow-blue-200" title="Add Account">
                    <i class="fa-solid fa-plus"></i>
                </button>
                <div id="accountSearchContainer" class="hidden transition-all">
                    <input type="text" id="accountSearchInput" onkeyup="searchAccounts(this.value)"
                        placeholder="Search accounts..."
                        class="px-4 py-2 border border-blue-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none text-sm w-48">
                </div>
                <button onclick="toggleAccountSearch()"
                    class="w-10 h-10 rounded-full bg-white dark:bg-dark-surface border border-gray-200 hover:bg-gray-50 dark:bg-dark-bg flex items-center justify-center text-gray-600 transition" title="Search">
                    <i class="fa-solid fa-magnifying-glass"></i>
                </button>
                
                <!-- View Controls -->
                <div class="flex items-center gap-2 bg-gray-100 dark:bg-dark-bg p-1 rounded-xl">
                    <!-- Grouping Toggle -->
                    <div class="flex gap-1 border-r border-gray-300 dark:border-gray-600 pr-2 mr-1">
                        <button onclick="toggleAccountGrouping('grouped')" class="w-8 h-8 rounded-lg flex items-center justify-center transition account-view-btn ${grouping === 'grouped' ? 'active' : ''}" title="Grouped View">
                            <i class="fa-solid fa-layer-group text-xs"></i>
                        </button>
                        <button onclick="toggleAccountGrouping('unified')" class="w-8 h-8 rounded-lg flex items-center justify-center transition account-view-btn ${grouping === 'unified' ? 'active' : ''}" title="Unified View">
                            <i class="fa-solid fa-bars-staggered text-xs"></i>
                        </button>
                    </div>

                    <!-- Layout Toggle -->
                    <div class="flex gap-1">
                        <button onclick="setAccountView('grid')" id="gridViewBtn"
                            class="w-8 h-8 rounded-lg flex items-center justify-center transition account-view-btn ${view === 'grid' ? 'active' : ''}" title="Grid View">
                            <i class="fa-solid fa-grip text-xs"></i>
                        </button>
                        <button onclick="setAccountView('list')" id="listViewBtn"
                            class="w-8 h-8 rounded-lg flex items-center justify-center transition account-view-btn ${view === 'list' ? 'active' : ''}" title="List View">
                            <i class="fa-solid fa-list text-xs"></i>
                        </button>
                    </div>
                </div>
                
                <button onclick="toggleAccountSort()" id="sortToggleBtn"
                    class="h-10 px-4 rounded-xl bg-gray-100 dark:bg-dark-bg hover:bg-gray-200 dark:hover:bg-dark-border flex items-center justify-center gap-2 transition text-xs font-medium text-gray-700 dark:text-gray-300">
                    <i class="fa-solid ${(localStorage.getItem('accountSort') || 'balance-desc').split('-')[0] === 'name' ? 'fa-font' : 'fa-coins'} text-sm"></i>
                    <span id="sortLabel">${(localStorage.getItem('accountSort') || 'balance-desc').split('-')[0] === 'name' ? 'Name' : 'Balance'}</span>
                    <i class="fa-solid ${(localStorage.getItem('accountSort') || 'balance-desc').split('-')[1] === 'asc' ? 'fa-arrow-up' : 'fa-arrow-down'} text-sm"></i>
                </button>
                
                <!-- Export Button -->
                <button onclick="openAccountExportModal()" 
                    class="h-10 px-4 rounded-xl bg-gray-100 dark:bg-dark-bg hover:bg-gray-200 dark:hover:bg-dark-border flex items-center justify-center gap-2 transition text-xs font-medium text-gray-700 dark:text-gray-300" title="Export Accounts">
                    <i class="fa-solid fa-file-export text-sm"></i>
                </button>
            </div>
        </div>

        <!-- Summary Cards with Filter -->
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
            ${summaryCards.map(c => `
                <div onclick="filterAccounts('${c.type}')" 
                     class="bg-white dark:bg-dark-surface p-4 rounded-2xl shadow-lg flex flex-col justify-between h-28 relative overflow-hidden group cursor-pointer hover:ring-2 hover:ring-blue-100 transition">
                    <div class="z-10">
                        <div class="text-xs font-medium opacity-90 uppercase tracking-wide mb-1 text-gray-500">${c.label}</div>
                        <div class="text-xl font-bold text-gray-800 dark:text-gray-200">${formatMoney(c.val)}</div>
                    </div>
                    <i class="fa-solid ${c.icon} absolute right-3 bottom-3 text-4xl text-${c.bg.replace('bg-', '').replace('-500', '-200')} opacity-20 group-hover:scale-110 transition"></i>
                </div>
            `).join('')}
        </div>

        <!-- Accounts Content -->
        ${accountContentHtml}
        
    </div>
    `;
            } // End renderAccounts

            window.filterAccounts = function (type) {
                const container = document.getElementById('accountListGrid');
                const items = container.getElementsByClassName('account-item');

                for (let item of items) {
                    const itemType = item.dataset.type;
                    // If filtering by 'general', we accept 'receivable' or 'payable' or 'general' (legacy support)
                    let isMatch = false;
                    if (type === 'all') isMatch = true;
                    else if (type === 'general') {
                        if (['general', 'receivable', 'payable'].includes(itemType)) isMatch = true;
                    } else {
                        if (itemType === type) isMatch = true;
                    }

                    if (isMatch) item.classList.remove('hidden');
                    else item.classList.add('hidden');
                }

                // Handle group headers visibility
                document.querySelectorAll('.account-group').forEach(group => {
                    const visibleItems = group.querySelectorAll('.account-item:not(.hidden)');
                    if (visibleItems.length === 0) group.classList.add('hidden');
                    else group.classList.remove('hidden');
                });
            };

            // Account Grouping Toggle Function
            window.toggleAccountGrouping = function (groupingMode) {
                // Save preference
                localStorage.setItem('accountGrouping', groupingMode);

                // Re-render accounts
                const content = document.getElementById('app-content');
                renderAccounts(content);
            };

            // Account View Toggle Function
            window.setAccountView = function (view) {
                // Save preference
                localStorage.setItem('accountView', view);

                // Update button states
                const gridBtn = document.getElementById('gridViewBtn');
                const listBtn = document.getElementById('listViewBtn');

                if (gridBtn && listBtn) {
                    gridBtn.classList.toggle('active', view === 'grid');
                    listBtn.classList.toggle('active', view === 'list');
                }

                // Re-render accounts
                const content = document.getElementById('app-content');
                renderAccounts(content);
            };


            // Account Sort Toggle Function - Cycles through all 4 states
            window.toggleAccountSort = function () {
                const currentSort = localStorage.getItem('accountSort') || 'balance-desc';

                // Define the cycle: balance-desc  balance-asc  name-asc  name-desc  balance-desc
                const sortCycle = {
                    'balance-desc': 'balance-asc',
                    'balance-asc': 'name-asc',
                    'name-asc': 'name-desc',
                    'name-desc': 'balance-desc'
                };

                const newSort = sortCycle[currentSort] || 'balance-desc';
                localStorage.setItem('accountSort', newSort);

                // Re-render accounts
                const content = document.getElementById('app-content');
                renderAccounts(content);
            };


            // Account management functions defined in later section of the code

            let currentSort = { field: 'date', dir: 'desc' };

            function toggleSort(field) {
                if (currentSort.field === field) {
                    currentSort.dir = currentSort.dir === 'asc' ? 'desc' : 'asc';
                } else {
                    currentSort.field = field;
                    currentSort.dir = 'desc'; // Default new sort to desc
                }
                // Re-render
                const content = document.getElementById('app-content');
                renderTransactions(content, null, true); // true = preserve filters
            }

            // --- FILTER & UTILS ---

            // Filter and reset functions defined in later section of the code

            // Renders transactions view with the new filter panel
            // --- TRANSACTIONS ---

            function formatDate(dateStr) {
                if (!dateStr) return '';
                const date = new Date(dateStr);
                const fmt = (store.settings && store.settings.dateFormat) ? store.settings.dateFormat : 'yyyy-mm-dd';

                if (fmt === 'dd/mm/yyyy') {
                    const d = String(date.getDate()).padStart(2, '0');
                    const m = String(date.getMonth() + 1).padStart(2, '0');
                    const y = date.getFullYear();
                    return `${d}/${m}/${y}`;
                }
                if (fmt === 'dd mmm yyyy') {
                    const d = String(date.getDate()).padStart(2, '0');
                    const m = date.toLocaleString('default', { month: 'short' });
                    const y = date.getFullYear();
                    return `${d} ${m} ${y}`;
                }
                return dateStr; // yyyy-mm-dd
            }

            function toggleFilterDates() {
                const val = document.getElementById('filterDuration').value;
                const container = document.getElementById('filterCustomDates');
                if (val === 'custom') {
                    container.classList.remove('hidden');
                    container.classList.add('flex');
                } else {
                    container.classList.add('hidden');
                    container.classList.remove('flex');
                }
                applyFilters();
            }
            function renderTransactions(container, params, preserveFilters) {
                let sorted = [...store.transactions];

                // Save Filter State if preserving
                const filterState = {};
                if (preserveFilters) {
                    filterState.search = document.getElementById('txSearch')?.value || '';
                    filterState.duration = document.getElementById('filterDuration')?.value || 'current_month';
                    filterState.type = document.getElementById('filterType')?.value || '';
                    filterState.cat = document.getElementById('filterCategory')?.value || '';
                    filterState.start = document.getElementById('filterDateStart')?.value || '';
                    filterState.end = document.getElementById('filterDateEnd')?.value || '';
                }

                // Apply Sort
                sorted.sort((a, b) => {
                    let valA, valB;
                    if (currentSort.field === 'date') {
                        valA = new Date(a.date); valB = new Date(b.date);
                    } else if (currentSort.field === 'amount') {
                        valA = a.amount; valB = b.amount;
                    } else if (currentSort.field === 'account') {
                        valA = store.accounts.find(acc => acc.id === a.accountId)?.name || '';
                        valB = store.accounts.find(acc => acc.id === b.accountId)?.name || '';
                    } else if (currentSort.field === 'category') {
                        valA = a.categoryName || ''; valB = b.categoryName || '';
                    } else if (currentSort.field === 'desc') {
                        valA = (a.desc || '').toLowerCase(); valB = (b.desc || '').toLowerCase();
                    }

                    if (valA < valB) return currentSort.dir === 'asc' ? -1 : 1;
                    if (valA > valB) return currentSort.dir === 'asc' ? 1 : -1;
                    return 0;
                });
                const months = ['All Months', 'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

                // Prepare Month/Year options dynamically
                const monthOptions = months.map((m, i) => `<option value="${i}">${m}</option>`).join('');

                // Prepare Category options
                const categoryOptions = '<option value="">All Categories</option>' + store.categories.map(c => `<option value="${c.id}">${c.name} (${c.type})</option>`).join('');

                // Calculate Summary for Filtered View
                const viewTotalIncome = sorted.reduce((sum, t) => t.type === 'income' ? sum + t.amount : sum, 0);
                const viewTotalExpense = sorted.reduce((sum, t) => t.type === 'expense' ? sum + t.amount : sum, 0);
                const viewNet = viewTotalIncome - viewTotalExpense;

                container.innerHTML = `
    <div class="max-w-7xl mx-auto space-y-6 fade-in">
        <!-- HEADER TOOLBAR: Month Navigation -->
        <div class="bg-white dark:bg-dark-surface p-5 rounded-3xl shadow-sm border border-gray-100 dark:border-dark-border flex flex-col md:flex-row justify-between items-center gap-4">
            <!-- Left: Title -->
            <h2 class="text-xl font-bold text-gray-800 dark:text-gray-200">Transactions</h2>
            
            <!-- Center: Month/Year Navigation -->
            <div class="flex items-center gap-3">
                <button onclick="navigateTransactionMonth(-1)" class="w-8 h-8 rounded-lg hover:bg-gray-100 dark:hover:bg-dark-bg flex items-center justify-center text-gray-600 dark:text-gray-400 transition" title="Previous Month">
                    <i class="fa-solid fa-chevron-left text-sm"></i>
                </button>
                <div id="txMonthYearDisplay" class="text-center min-w-[140px]">
                    <div class="text-lg font-bold text-gray-800 dark:text-gray-200">${new Date().toLocaleString('default', { month: 'long' })}</div>
                    <div class="text-xs text-gray-400">${new Date().getFullYear()}</div>
                </div>
                <button onclick="navigateTransactionMonth(1)" class="w-8 h-8 rounded-lg hover:bg-gray-100 dark:hover:bg-dark-bg flex items-center justify-center text-gray-600 dark:text-gray-400 transition" title="Next Month">
                    <i class="fa-solid fa-chevron-right text-sm"></i>
                </button>
            </div>
            
            <!-- Right: Actions -->
            <div class="flex items-center gap-2">
                <!-- Search Icon Button -->
                <button onclick="toggleTransactionSearch()" 
                    class="w-10 h-10 rounded-xl bg-white dark:bg-dark-surface hover:bg-gray-50 dark:hover:bg-dark-bg border border-gray-200 text-gray-600 dark:text-gray-400 shadow-sm transition flex items-center justify-center" title="Search">
                    <i class="fa-solid fa-magnifying-glass"></i>
                </button>

                <!-- Filter Toggle -->
                <button onclick="toggleFilterPanel()" 
                    class="py-2.5 px-4 bg-white dark:bg-dark-surface hover:bg-gray-50 dark:hover:bg-dark-bg border border-gray-200 text-gray-700 dark:text-gray-300 rounded-xl text-sm font-bold shadow-sm transition flex items-center gap-2">
                    <i class="fa-solid fa-filter text-blue-600"></i> 
                    <span class="hidden sm:inline">Filters</span>
                    <span id="activeFilterCount" class="hidden bg-blue-100 text-blue-600 px-2 py-0.5 rounded-md text-xs ml-1">0</span>
                </button>

                <!-- Export -->
                <button onclick="openExportModal()"
                    class="py-2.5 px-4 bg-white dark:bg-dark-surface hover:bg-gray-50 dark:hover:bg-dark-bg border border-gray-200 text-gray-700 dark:text-gray-300 rounded-xl text-sm font-bold shadow-sm transition flex items-center gap-2 whitespace-nowrap">
                    <i class="fa-solid fa-file-export text-gray-500"></i> <span class="hidden sm:inline">Export</span>
                </button>
            </div>
        </div>

<!-- SEARCH BAR (Collapsible) -->
<div id="txSearchContainer" class="hidden bg-white dark:bg-dark-surface p-4 rounded-2xl shadow-sm border border-gray-100 dark:border-dark-border">
    <div class="relative">
        <i class="fa-solid fa-magnifying-glass absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
        <input type="text" id="txSearch" onkeyup="applyFilters()" placeholder="Search transactions..."
            class="w-full pl-10 pr-4 py-2.5 bg-gray-50 dark:bg-dark-bg border border-gray-200 rounded-xl focus:bg-white dark:bg-dark-surface focus:ring-2 focus:ring-blue-500 outline-none text-sm transition-all">
    </div>
</div>

        <!-- FILTER PANEL -->
        <div id="filterPanel" class="hidden bg-white dark:bg-dark-surface p-6 rounded-3xl shadow-sm border border-gray-100 dark:border-dark-border space-y-4">
            <div class="flex justify-between items-center border-b border-gray-100 dark:border-dark-border pb-2 mb-2">
                <h3 class="text-sm font-bold text-gray-500 uppercase tracking-wide">Filter Options</h3>
                <button onclick="resetFilters()" class="text-sm text-red-500 hover:text-red-700 font-medium hover:underline">Reset All/Clear</button>
            </div>
            <div class="space-y-3">
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4">
                    <select id="filterDuration" class="px-4 py-2.5 bg-gray-50 dark:bg-dark-bg border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none text-sm" onchange="toggleFilterDates()">
                        <option value="current_month">Current Month</option>
                        <option value="last_month">Last Month</option>
                        <option value="last_3_months">Last 3 Months</option>
                        <option value="last_6_months">Last 6 Months</option>
                        <option value="this_year">This Year</option>
                        <option value="previous_year">Previous Year</option>
                        <option value="custom">Custom Dates</option>
                    </select>
                    <select id="filterType" class="px-4 py-2.5 bg-gray-50 dark:bg-dark-bg border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none text-sm" onchange="applyFilters()">
                        <option value="">All Types</option>
                        <option value="income">Income</option>
                        <option value="expense">Expense</option>
                        <option value="transfer">Transfer</option>
                    </select>
                    <select id="filterCategory" class="px-4 py-2.5 bg-gray-50 dark:bg-dark-bg border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none text-sm" onchange="applyFilters()">
                        ${categoryOptions}
                    </select>
                     <!-- Hidden Custom Dates -->
                    <div id="filterCustomDates" class="hidden gap-2 items-center col-span-1 sm:col-span-2 md:col-span-1">
                         <input type="date" id="filterDateStart" class="w-full px-4 py-2.5 bg-gray-50 dark:bg-dark-bg border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none text-sm" onchange="applyFilters()">
                         <span class="text-gray-400">-</span>
                         <input type="date" id="filterDateEnd" class="w-full px-4 py-2.5 bg-gray-50 dark:bg-dark-bg border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none text-sm" onchange="applyFilters()">
                    </div>
                </div>
            </div>
        </div>

        <!-- SUMMARY CARDS (Medium Size) -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
             <div class="bg-white dark:bg-dark-surface p-6 rounded-3xl shadow-sm border border-gray-100 dark:border-dark-border flex items-center gap-5 transition hover:shadow-md">
                 <div class="w-12 h-12 rounded-2xl bg-green-50 dark:bg-green-900/20 text-green-600 dark:text-green-500 flex items-center justify-center text-xl"><i class="fa-solid fa-arrow-down"></i></div>
                 <div class="overflow-hidden">
                     <p class="text-xs text-gray-400 dark:text-gray-500 font-bold uppercase tracking-wider">Total Income</p>
                     <p id="summaryTotalIncome" class="text-xl font-bold text-gray-800 dark:text-gray-200 truncate mt-1">${formatMoney(viewTotalIncome)}</p>
                 </div>
             </div>
             <div class="bg-white dark:bg-dark-surface p-6 rounded-3xl shadow-sm border border-gray-100 dark:border-dark-border flex items-center gap-5 transition hover:shadow-md">
                 <div class="w-12 h-12 rounded-2xl bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-500 flex items-center justify-center text-xl"><i class="fa-solid fa-arrow-up"></i></div>
                 <div class="overflow-hidden">
                     <p class="text-xs text-gray-400 dark:text-gray-500 font-bold uppercase tracking-wider">Total Expense</p>
                     <p id="summaryTotalExpense" class="text-xl font-bold text-gray-800 dark:text-gray-200 truncate mt-1">${formatMoney(viewTotalExpense)}</p>
                 </div>
             </div>
              <div class="bg-white dark:bg-dark-surface p-6 rounded-3xl shadow-sm border border-gray-100 dark:border-dark-border flex items-center gap-5 transition hover:shadow-md">
                 <div class="w-12 h-12 rounded-2xl bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-500 flex items-center justify-center text-xl"><i class="fa-solid fa-scale-balanced"></i></div>
                 <div class="overflow-hidden">
                     <p class="text-xs text-gray-400 dark:text-gray-500 font-bold uppercase tracking-wider">Net Balance</p>
                     <p id="summaryNetBalance" class="text-xl font-bold text-gray-800 dark:text-gray-200 truncate mt-1">${formatMoney(viewNet)}</p>
                 </div>
             </div>
        </div>

        <!-- TRANSACTIONS LIST -->
        <div class="bg-white dark:bg-dark-surface rounded-3xl shadow-sm border border-gray-100 dark:border-dark-border overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-left" id="txTable">
                    <thead class="bg-gray-50 dark:bg-dark-bg border-b border-gray-100 dark:border-dark-border">
                        <tr class="text-xs font-bold text-gray-500 uppercase tracking-wilder">
                            <th class="px-6 py-4 cursor-pointer hover:text-blue-600 select-none whitespace-nowrap" onclick="toggleSort('date')">Date <i class="fa-solid fa-sort text-xs ml-1 opacity-50"></i></th>
                            <th class="px-6 py-4 cursor-pointer hover:text-blue-600 select-none whitespace-nowrap" onclick="toggleSort('desc')">Description <i class="fa-solid fa-sort text-xs ml-1 opacity-50"></i></th>
                            <th class="px-6 py-4 cursor-pointer hover:text-blue-600 select-none whitespace-nowrap" onclick="toggleSort('account')">Account <i class="fa-solid fa-sort text-xs ml-1 opacity-50"></i></th>
                            <th class="px-6 py-4 cursor-pointer hover:text-blue-600 select-none whitespace-nowrap" onclick="toggleSort('category')">Category <i class="fa-solid fa-sort text-xs ml-1 opacity-50"></i></th>
                            <th class="px-6 py-4 text-right cursor-pointer hover:text-blue-600 select-none whitespace-nowrap" onclick="toggleSort('amount')">Amount <i class="fa-solid fa-sort text-xs ml-1 opacity-50"></i></th>
                            <th class="px-6 py-4 text-center">Action</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100 dark:divide-dark-border" id="txTableBody">
                        ${renderTxRows(sorted)}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    `;

                // Restore Filter State
                if (preserveFilters) {
                    if (document.getElementById('txSearch')) document.getElementById('txSearch').value = filterState.search;
                    if (document.getElementById('filterDuration')) document.getElementById('filterDuration').value = filterState.duration;
                    if (document.getElementById('filterType')) document.getElementById('filterType').value = filterState.type;
                    if (document.getElementById('filterCategory')) document.getElementById('filterCategory').value = filterState.cat;
                    if (document.getElementById('filterDateStart')) document.getElementById('filterDateStart').value = filterState.start;
                    if (document.getElementById('filterDateEnd')) document.getElementById('filterDateEnd').value = filterState.end;

                    // Toggle custom dates visibility
                    if (filterState.duration === 'custom') {
                        const cd = document.getElementById('filterCustomDates');
                        if (cd) { cd.classList.remove('hidden'); cd.classList.add('flex'); }
                    }
                }

                // Apply Params if present
                if (params) {
                    if (params.type) {
                        document.getElementById('filterType').value = params.type;
                    }
                    if (params.month === 'current') {
                        document.getElementById('filterDuration').value = 'current_month';
                    }
                    toggleFilterDates(); // Ensure visibility matches
                    applyFilters();
                }
            }

            // Sort State for Account Details
            window.accountDetailSort = { field: 'date', direction: 'desc' };

            window.toggleAccountDetailSort = function (field) {
                if (window.accountDetailSort.field === field) {
                    window.accountDetailSort.direction = window.accountDetailSort.direction === 'desc' ? 'asc' : 'desc';
                } else {
                    window.accountDetailSort.field = field;
                    window.accountDetailSort.direction = 'asc'; // Default new sort to asc, or maybe desc for date/amount?
                    if (field === 'date' || field === 'amount' || field === 'balance') window.accountDetailSort.direction = 'desc';
                }
                if (window.currentAccountId) {
                    renderAccountDetail(document.getElementById('app-content'), window.currentAccountId);
                }
            };

            window.accountHistoryDate = new Date();

            window.changeAccountHistoryMonth = function (offset) {
                window.accountHistoryDate.setMonth(window.accountHistoryDate.getMonth() + offset);
                if (window.currentAccountId) {
                    renderAccountDetail(document.getElementById('app-content'), window.currentAccountId);
                }
            };

            function renderAccountDetail(container, accountId) {
                window.currentAccountId = accountId;
                let acc = store.accounts.find(a => a.id === accountId);

                // If not found in primary accounts, check Virtual Accounts (FDs / Loans)
                if (!acc) {
                    const inv = (store.investments || []).find(i => i.id === accountId);
                    if (inv) {
                        acc = { id: inv.id, name: inv.name, type: 'investment', openingBalance: 0, isVirtual: true };
                    } else {
                        const loan = (store.loans || []).find(l => l.id === accountId);
                        if (loan) {
                            acc = { id: loan.id, name: loan.name, type: 'loan', openingBalance: 0, isVirtual: true };
                        } else {
                            const rd = (store.rds || []).find(r => r.id === accountId);
                            if (rd) {
                                acc = { id: rd.id, name: rd.name, type: 'rd', openingBalance: 0, isVirtual: true };
                            }
                        }
                    }
                }

                if (!acc) return router('accounts');

                // Calculate Running Balance (Chronological first)
                const allTxs = [...store.transactions].sort((a, b) => new Date(a.date) - new Date(b.date));
                let rBal = acc.openingBalance;
                const txsWithBal = [];

                // Totals
                let totalIn = 0;
                let totalOut = 0;

                allTxs.forEach(t => {
                    let change = 0;
                    let isRelevant = false;

                    if (acc.isVirtual) {
                        if (t.accountId === accountId || t.toAccountId === accountId) {
                            isRelevant = true;
                            if (t.accountId === accountId) {
                                // For virtual accounts, if it's an expense/transfer OUT, it's a deduction
                                // If it's an income, it's an addition (like interest)
                                if (t.type === 'income') change = t.amount;
                                else change = -t.amount;
                            }
                            if (t.toAccountId === accountId) change = t.amount;
                        } else if (t.desc && t.desc.toLowerCase().includes(acc.name.toLowerCase())) {
                            isRelevant = true;
                            // Legacy: Match by description
                            if (t.type === 'expense' || t.desc.toLowerCase().includes('investment:')) change = t.amount;
                            else if (t.type === 'income' || t.desc.toLowerCase().includes('withdrawal:')) change = -t.amount;
                        }
                    } else {
                        if (t.accountId === accountId) {
                            isRelevant = true;
                            if (t.type === 'expense') change = -t.amount;
                            if (t.type === 'income') change = t.amount;
                            if (t.type === 'transfer') change = -t.amount;
                        }
                        if (t.type === 'transfer' && t.toAccountId === accountId) {
                            isRelevant = true;
                            change = t.amount;
                        }
                    }

                    if (isRelevant) {
                        if (change > 0) totalIn += change;
                        else totalOut += Math.abs(change);

                        rBal += change;
                        txsWithBal.push({ ...t, balanceAfter: rBal, change });
                    }
                });

                // Filter by Month
                const currentMonth = window.accountHistoryDate.getMonth();
                const currentYear = window.accountHistoryDate.getFullYear();

                const monthTxs = txsWithBal.filter(t => {
                    const d = new Date(t.date);
                    return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
                });

                // Apply Sorting
                const sortField = window.accountDetailSort.field;
                const sortDir = window.accountDetailSort.direction;

                const displayTxs = [...monthTxs].sort((a, b) => {
                    let valA, valB;

                    if (sortField === 'date') {
                        valA = new Date(a.date).getTime();
                        valB = new Date(b.date).getTime();
                    } else if (sortField === 'desc') {
                        valA = a.desc?.toLowerCase() || '';
                        valB = b.desc?.toLowerCase() || '';
                    } else if (sortField === 'category') {
                        valA = a.categoryName?.toLowerCase() || (a.type === 'transfer' ? 'transfer' : '');
                        valB = b.categoryName?.toLowerCase() || (b.type === 'transfer' ? 'transfer' : '');
                    } else if (sortField === 'amount') {
                        valA = a.change;
                        valB = b.change;
                    } else if (sortField === 'balance') {
                        valA = a.balanceAfter;
                        valB = b.balanceAfter;
                    }

                    if (valA < valB) return sortDir === 'asc' ? -1 : 1;
                    if (valA > valB) return sortDir === 'asc' ? 1 : -1;
                    return 0;
                });

                const currentBalance = rBal;

                const monthName = window.accountHistoryDate.toLocaleString('default', { month: 'long', year: 'numeric' });

                // Helper for headers
                const getSortIcon = (f) => {
                    if (window.accountDetailSort.field !== f) return '<i class="fa-solid fa-sort text-gray-300 ml-1"></i>';
                    return window.accountDetailSort.direction === 'asc'
                        ? '<i class="fa-solid fa-sort-up text-blue-500 ml-1"></i>'
                        : '<i class="fa-solid fa-sort-down text-blue-500 ml-1"></i>';
                };

                container.innerHTML = `
    <div class="max-w-5xl mx-auto space-y-6 fade-in">
        <!-- Header Card -->
        <div
            class="bg-white dark:bg-dark-surface p-8 rounded-3xl shadow-sm border border-gray-100 dark:border-dark-border relative overflow-hidden transition-all hover:shadow-md">
            <div class="relative z-10 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <div>
                    <button onclick="router('accounts')"
                        class="text-gray-400 hover:text-gray-600 mb-2 flex items-center gap-1 text-sm font-medium transition">
                        <i class="fa-solid fa-arrow-left"></i> Back to Accounts
                    </button>
                    <div class="flex items-center gap-3">
                        <div
                            class="w-12 h-12 rounded-2xl ${acc.type === 'asset' ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'} flex items-center justify-center text-xl">
                            <i
                                class="fa-solid ${acc.name.toLowerCase().includes('card') ? 'fa-credit-card' : (acc.name.toLowerCase().includes('cash') ? 'fa-money-bill' : 'fa-building-columns')}"></i>
                        </div>
                        <div>
                            <h2 class="text-3xl font-bold text-gray-800 dark:text-gray-200">${acc.name}</h2>
                            <span
                                class="px-3 py-1 bg-gray-100 text-gray-500 rounded-full text-xs font-bold uppercase tracking-wide">${acc.type}</span>
                        </div>
                    </div>
                </div>
                <div class="text-left md:text-right flex flex-col md:items-end gap-3">
                    <div>
                        <div class="text-sm text-gray-500 font-medium">Current Balance</div>
                        <div class="text-4xl font-bold ${currentBalance >= 0 ? 'text-gray-900' : 'text-red-500'}">${formatMoney(currentBalance)}</div>
                    </div>
                    <!-- Actions -->
                    <div class="flex gap-2">
                        <button onclick="openExportModal()" class="px-3 py-1.5 bg-gray-100 dark:bg-dark-bg text-gray-600 dark:text-gray-300 rounded-lg text-xs font-bold hover:bg-gray-200 dark:hover:bg-gray-700 transition">
                            <i class="fa-solid fa-download mr-1"></i> Export
                        </button>
                        <button onclick="openAccountModal('${acc.id}')" class="px-3 py-1.5 bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400 rounded-lg text-xs font-bold hover:bg-blue-100 transition">
                            <i class="fa-solid fa-pen mr-1"></i> Edit
                        </button>
                        <button onclick="deleteAccount('${acc.id}')" class="px-3 py-1.5 bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-500 rounded-lg text-xs font-bold hover:bg-red-100 transition">
                            <i class="fa-solid fa-trash mr-1"></i> Delete
                        </button>
                    </div>
                </div>
            </div>
             <!-- Summary Stats for Account -->
             <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mt-6">
                <div class="bg-green-50 dark:bg-green-900/10 p-4 rounded-2xl">
                    <div class="text-xs text-green-600 font-bold uppercase">Total In</div>
                    <div class="text-lg font-bold text-green-700 dark:text-green-500">${formatMoney(totalIn)}</div>
                </div>
                 <div class="bg-red-50 dark:bg-red-900/10 p-4 rounded-2xl">
                    <div class="text-xs text-red-600 font-bold uppercase">Total Out</div>
                    <div class="text-lg font-bold text-red-700 dark:text-red-500">${formatMoney(totalOut)}</div>
                </div>
                 <div class="bg-blue-50 dark:bg-blue-900/10 p-4 rounded-2xl col-span-2 md:col-span-1">
                    <div class="text-xs text-blue-600 font-bold uppercase">Net Flow</div>
                    <div class="text-lg font-bold text-blue-700 dark:text-blue-500">${formatMoney(totalIn - totalOut)}</div>
                </div>
            </div>
            <div class="absolute right-0 top-0 w-64 h-full bg-gradient-to-l from-blue-50 to-transparent pointer-events-none"></div>
        </div>

        <!-- Transactions List -->
        <div class="bg-white dark:bg-dark-surface rounded-3xl shadow-sm border border-gray-100 dark:border-dark-border overflow-hidden">
            <div class="relative flex items-center justify-center p-4 border-b border-gray-100 dark:border-dark-border h-20">
                <h3 class="absolute left-6 font-bold text-gray-700 dark:text-gray-300">Transaction History</h3>
                
                <!-- Center: Month Navigation -->
                <div class="flex items-center gap-3 bg-gray-50 dark:bg-dark-bg p-1 rounded-xl">
                    <button onclick="changeAccountHistoryMonth(-1)" class="w-8 h-8 rounded-lg flex items-center justify-center hover:bg-gray-200 dark:hover:bg-dark-border transition">
                        <i class="fa-solid fa-chevron-left text-gray-600"></i>
                    </button>
                    <span class="text-sm font-bold text-gray-700 dark:text-gray-300 w-32 text-center select-none">${monthName}</span>
                     <button onclick="changeAccountHistoryMonth(1)" class="w-8 h-8 rounded-lg flex items-center justify-center hover:bg-gray-200 dark:hover:bg-dark-border transition">
                        <i class="fa-solid fa-chevron-right text-gray-600"></i>
                    </button>
                </div>

                <!-- Right: Search Toggle -->
                <div class="absolute right-6 flex items-center">
                     <div id="accountTxSearchContainer" class="hidden absolute right-12 top-1/2 transform -translate-y-1/2 w-64 mr-2 transition-all origin-right">
                         <input type="text" id="accountTxSearch" onkeyup="window.filterAccountTransactions(this.value)" placeholder="Search history... (Press F)"
                            class="w-full pl-4 pr-4 py-2 bg-gray-50 dark:bg-dark-bg border border-gray-200 dark:border-dark-border rounded-xl text-sm focus:ring-2 focus:ring-blue-500 dark:text-gray-200 shadow-lg">
                    </div>
                     <button onclick="window.toggleAccountTxSearch()" 
                        class="w-10 h-10 rounded-full bg-white dark:bg-dark-surface border border-gray-200 hover:bg-gray-50 dark:bg-dark-bg flex items-center justify-center text-gray-600 transition" title="Search History">
                        <i class="fa-solid fa-magnifying-glass"></i>
                    </button>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="bg-gray-50 dark:bg-dark-bg">
                        <tr class="text-xs font-bold text-gray-500 uppercase">
                            <th class="px-6 py-4 cursor-pointer hover:bg-gray-100 dark:hover:bg-dark-border transition select-none" onclick="toggleAccountDetailSort('date')">
                                Date ${getSortIcon('date')}
                            </th>
                            <th class="px-6 py-4 cursor-pointer hover:bg-gray-100 dark:hover:bg-dark-border transition select-none" onclick="toggleAccountDetailSort('desc')">
                                Description ${getSortIcon('desc')}
                            </th>
                            <th class="px-6 py-4 cursor-pointer hover:bg-gray-100 dark:hover:bg-dark-border transition select-none" onclick="toggleAccountDetailSort('category')">
                                Category ${getSortIcon('category')}
                            </th>
                            <th class="px-6 py-4 text-right cursor-pointer hover:bg-gray-100 dark:hover:bg-dark-border transition select-none" onclick="toggleAccountDetailSort('amount')">
                                Amount ${getSortIcon('amount')}
                            </th>
                            <th class="px-6 py-4 text-right cursor-pointer hover:bg-gray-100 dark:hover:bg-dark-border transition select-none" onclick="toggleAccountDetailSort('balance')">
                                Balance ${getSortIcon('balance')}
                            </th>
                            <th class="px-6 py-4 text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="accountTxTableBody" class="divide-y divide-gray-100 dark:divide-dark-border">
                        ${displayTxs.length ? displayTxs.map(t => {
                    let amountClass = (t.change > 0) ? 'text-green-600' : 'text-gray-800 dark:text-gray-200';
                    let sign = (t.change > 0) ? '+' : '';

                    return `
                        <tr class="hover:bg-gray-50 dark:hover:bg-dark-bg transition group">
                            <td class="px-6 py-4 text-sm text-gray-500 whitespace-nowrap">${formatDate(t.date)}</td>
                            <td class="px-6 py-4 text-sm font-medium text-gray-800 dark:text-gray-200">${t.desc}</td>
                            <td class="px-6 py-4 text-sm text-gray-500">
                                ${t.type === 'transfer' ? '<span class="px-2 py-1 bg-blue-50 text-blue-600 rounded text-xs">Transfer</span>' : t.categoryName}
                            </td>
                            <td class="px-6 py-4 text-sm font-bold text-right ${amountClass}">${sign}${formatMoney(t.change)}</td>
                            <td class="px-6 py-4 text-sm font-medium text-gray-500 text-right">${formatMoney(t.balanceAfter)}</td>
                            <td class="px-6 py-4 text-center space-x-2 whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity">
                                <button onclick="openTxModal('${t.id}')" class="text-gray-400 hover:text-blue-500 transition"><i class="fa-solid fa-pen-to-square"></i></button>
                                <button onclick="deleteTx('${t.id}')" class="text-gray-400 hover:text-red-500 transition"><i class="fa-solid fa-trash"></i></button>
                            </td>
                        </tr>
                    `;
                }).join('') : '<tr><td colspan="6" class="px-6 py-8 text-center text-gray-400">No transactions yet</td></tr>'}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
                `;
            }

            // Updates the table rows based on the currently filtered list
            function renderTxRows(txList) {
                if (txList.length === 0) return '<tr><td colspan="6" class="px-6 py-8 text-center text-gray-400">No transactions found</td></tr>';

                return txList.map(t => {
                    let accName = getAccountName(t.accountId);
                    let amountClass = t.type === 'income' ? 'text-green-600' : (t.type === 'transfer' ? 'text-blue-600' :
                        'text-gray-800 dark:text-gray-200');
                    let sign = t.type === 'income' ? '+' : (t.type === 'expense' ? '-' : '');

                    if (t.type === 'transfer') {
                        const fromName = getAccountName(t.accountId);
                        const toName = getAccountName(t.toAccountId);
                        accName = `${fromName} <i class="fa-solid fa-arrow-right text-xs mx-1 text-gray-400"></i> ${toName}`;
                    }

                    return `
                <tr class="hover:bg-gray-50 dark:hover:bg-dark-bg transition group">
                    <td class="px-6 py-4 text-sm text-gray-500 dark:text-gray-400 whitespace-nowrap">${formatDate(t.date)}</td>
                    <td class="px-6 py-4 text-sm font-medium text-gray-800 dark:text-gray-200">${t.desc || ''}</td>
                    <td class="px-6 py-4 text-sm text-gray-600 dark:text-gray-400">${accName}</td>
                    <td class="px-6 py-4 text-sm text-gray-500 dark:text-gray-400">
                        <span class="inline-block px-2 py-1 bg-gray-100 dark:bg-dark-bg rounded text-xs font-medium">${t.type === 'transfer' ? 'Transfer' : (t.categoryName || 'Uncategorized')}</span>
                    </td>
                    <td class="px-6 py-4 text-sm font-bold text-right ${amountClass}">${sign}${formatMoney(t.amount)}</td>
                    <td class="px-6 py-4 text-center space-x-2 whitespace-nowrap">
                        <button onclick="openTxModal('${t.id}')" class="text-gray-400 hover:text-blue-500 transition"><i class="fa-solid fa-pen-to-square"></i></button>
                        <button onclick="deleteTx('${t.id}')" class="text-gray-400 hover:text-red-500 transition"><i class="fa-solid fa-trash"></i></button>
                    </td>
                </tr>
                `;
                }).join('');
            }

            function applyFilters() {
                let filtered = [...store.transactions];
                const txSearchEl = document.getElementById('txSearch');
                const query = txSearchEl ? txSearchEl.value.toLowerCase() : '';
                const filterDuration = document.getElementById('filterDuration').value;
                const filterType = document.getElementById('filterType').value;
                const filterCategory = document.getElementById('filterCategory').value;
                const filterDateStart = document.getElementById('filterDateStart').value;
                const filterDateEnd = document.getElementById('filterDateEnd').value;

                // Date Filters
                let start = new Date(0);
                let end = new Date(9999, 11, 31);
                const now = new Date();

                // Check if using month navigation (currentTxMonth)
                // If the displayed month differs from current month, use it for filtering
                const usingMonthNav = typeof currentTxMonth !== 'undefined' && currentTxMonth;
                if (usingMonthNav && filterDuration !== 'custom' && filterDuration !== 'all') {
                    // Use the navigated month for filtering
                    start = new Date(currentTxMonth.getFullYear(), currentTxMonth.getMonth(), 1);
                    end = new Date(currentTxMonth.getFullYear(), currentTxMonth.getMonth() + 1, 0, 23, 59, 59, 999);
                } else if (filterDuration === 'current_month') {
                    start = new Date(now.getFullYear(), now.getMonth(), 1);
                    end = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59, 999);
                } else if (filterDuration === 'last_month') {
                    start = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                    end = new Date(now.getFullYear(), now.getMonth(), 0, 23, 59, 59, 999);
                } else if (filterDuration === 'last_3_months') {
                    start = new Date(now.getFullYear(), now.getMonth() - 2, 1);
                    end = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59, 999);
                } else if (filterDuration === 'last_6_months') {
                    start = new Date(now.getFullYear(), now.getMonth() - 5, 1);
                    end = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59, 999);
                } else if (filterDuration === 'this_year') {
                    start = new Date(now.getFullYear(), 0, 1);
                    end = new Date(now.getFullYear(), 11, 31, 23, 59, 59, 999);
                } else if (filterDuration === 'previous_year') {
                    start = new Date(now.getFullYear() - 1, 0, 1);
                    end = new Date(now.getFullYear() - 1, 11, 31, 23, 59, 59, 999);
                } else if (filterDuration === 'custom') {
                    if (filterDateStart) start = new Date(filterDateStart);
                    if (filterDateEnd) {
                        end = new Date(filterDateEnd);
                        end.setHours(23, 59, 59, 999);
                    }
                }

                filtered = filtered.filter(t => {
                    const accName = getAccountName(t.accountId);
                    const toAccName = t.type === 'transfer' ? getAccountName(t.toAccountId) : '';

                    // Text Search
                    if (query && !(t.desc.toLowerCase().includes(query) ||
                        (t.categoryName && t.categoryName.toLowerCase().includes(query)) ||
                        accName.toLowerCase().includes(query) ||
                        toAccName.toLowerCase().includes(query) ||
                        t.amount.toString().includes(query))) {
                        return false;
                    }

                    // Date Range Check
                    const d = new Date(t.date);
                    if (d < start || d > end) return false;

                    // Type Filter
                    if (filterType && t.type !== filterType) {
                        return false;
                    }

                    // Category Filter
                    if (filterCategory && t.category !== filterCategory) {
                        return false;
                    }

                    return true;
                }).sort((a, b) => new Date(b.date) - new Date(a.date));

                // Calculate and Update Totals
                let inc = 0, exp = 0;
                filtered.forEach(t => {
                    if (t.type === 'income') inc += t.amount;
                    else if (t.type === 'expense') exp += t.amount;
                });

                const elInc = document.getElementById('summaryTotalIncome');
                const elExp = document.getElementById('summaryTotalExpense');
                const elNet = document.getElementById('summaryNetBalance');

                if (elInc) elInc.textContent = formatMoney(inc);
                if (elExp) elExp.textContent = formatMoney(exp);
                if (elNet) elNet.textContent = formatMoney(inc - exp);

                document.getElementById('txTableBody').innerHTML = renderTxRows(filtered);
            }

            function resetFilters() {
                document.getElementById('txSearch').value = '';
                document.getElementById('filterDuration').value = 'current_month';
                toggleFilterDates();

                document.getElementById('filterType').value = '';
                document.getElementById('filterCategory').value = '';
                document.getElementById('filterDateStart').value = '';
                document.getElementById('filterDateEnd').value = '';
                applyFilters();
            }

            // --- BANKING LOGIC REMOVED ---


            // --- CREDIT CARD & BUDGET LOGIC REMOVED ---


            function renderSettings(container) {
                if (!store.settings) store.settings = { theme: 'light', currency: 'USD', dateFormat: 'yyyy-mm-dd' };
                const isINR = store.settings.currency === 'INR';

                container.innerHTML = `
                <div class="max-w-7xl mx-auto space-y-8 fade-in">
            <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-200">Settings & Management</h2>

            <!-- App Preferences -->
            <div class="bg-white dark:bg-dark-surface p-6 rounded-3xl shadow-sm border border-gray-100 dark:border-dark-border">
                <h3 class="font-bold text-gray-700 dark:text-gray-300 mb-6">Preferences</h3>
                <div class="flex items-center justify-between p-4 bg-gray-50 dark:bg-dark-bg rounded-xl border border-gray-100 dark:border-dark-border mb-3">
                    <div>
                        <div class="font-medium text-gray-800 dark:text-gray-200">Currency</div>
                        <div class="text-xs text-gray-500 dark:text-gray-400">Choose your display currency</div>
                    </div>
                    <div class="flex bg-white dark:bg-dark-surface rounded-lg p-1 border border-gray-200 dark:border-dark-border">
                        <button onclick="updateCurrency('USD')"
                            class="px-4 py-2 rounded-md text-sm font-bold transition ${!isINR ? 'bg-blue-600 text-white shadow-sm' : 'text-gray-500 dark:text-gray-400 hover:bg-gray-50 dark:bg-dark-bg dark:hover:bg-gray-800'}">$
                            USD</button>
                        <button onclick="updateCurrency('INR')"
                            class="px-4 py-2 rounded-md text-sm font-bold transition ${isINR ? 'bg-blue-600 text-white shadow-sm' : 'text-gray-500 dark:text-gray-400 hover:bg-gray-50 dark:bg-dark-bg dark:hover:bg-gray-800'}">
                            INR</button>
                    </div>
                </div>

                <!-- Date Format -->
                <div class="flex items-center justify-between p-4 bg-gray-50 dark:bg-dark-bg rounded-xl border border-gray-100 dark:border-dark-border mb-3">
                    <div>
                        <div class="font-medium text-gray-800 dark:text-gray-200">Date Format</div>
                        <div class="text-xs text-gray-500 dark:text-gray-400">Choose display format</div>
                    </div>
                    <select onchange="updateDateFormat(this.value)" class="bg-white dark:bg-dark-surface border border-gray-200 dark:border-dark-border px-3 py-2 rounded-lg text-sm outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="yyyy-mm-dd" ${(!store.settings.dateFormat || store.settings.dateFormat === 'yyyy-mm-dd') ? 'selected' : ''}>YYYY-MM-DD</option>
                        <option value="dd/mm/yyyy" ${store.settings.dateFormat === 'dd/mm/yyyy' ? 'selected' : ''}>DD/MM/YYYY</option>
                        <option value="dd mmm yyyy" ${store.settings.dateFormat === 'dd mmm yyyy' ? 'selected' : ''}>DD MMM YYYY</option>
                    </select>
                </div>

                <div class="p-4 bg-gray-50 dark:bg-dark-bg rounded-xl border border-gray-100 dark:border-dark-border">
                    <div class="mb-3">
                        <div class="font-medium text-gray-800 dark:text-gray-200">Theme</div>
                        <div class="text-xs text-gray-500 dark:text-gray-400">Customize appearance</div>
                    </div>
                    
                    <div class="grid grid-cols-5 gap-2">
                        <!-- Default -->
                        <button onclick="setTheme('light')" 
                            class="group relative h-12 rounded-lg border-2 transition overflow-hidden ${(store.settings.theme === 'light' || !store.settings.theme) ? 'border-blue-500 ring-1 ring-blue-500' : 'border-gray-200 dark:border-gray-700'}">
                            <div class="absolute inset-0 bg-[#f0f2f5]"></div>
                            <div class="absolute bottom-0 left-0 w-full h-1/2 bg-white"></div>
                           ${(store.settings.theme === 'light' || !store.settings.theme) ? '<div class="absolute inset-0 flex items-center justify-center text-blue-600"><i class="fa-solid fa-check"></i></div>' : ''}
                            <span class="sr-only">Default</span>
                        </button>

                        <!-- Dark -->
                        <button onclick="setTheme('dark')" 
                           class="group relative h-12 rounded-lg border-2 transition overflow-hidden text-white ${store.settings.theme === 'dark' ? 'border-blue-500 ring-1 ring-blue-500' : 'border-gray-200 dark:border-gray-700'}">
                            <div class="absolute inset-0 bg-[#18181b]"></div>
                            <div class="absolute bottom-0 left-0 w-full h-1/2 bg-[#27272a]"></div>
                            ${store.settings.theme === 'dark' ? '<div class="absolute inset-0 flex items-center justify-center text-white"><i class="fa-solid fa-check"></i></div>' : ''}
                            <span class="sr-only">Dark</span>
                        </button>

                         <!-- Cute -->
                        <button onclick="setTheme('cute')" 
                           class="group relative h-12 rounded-lg border-2 transition overflow-hidden ${store.settings.theme === 'cute' ? 'border-pink-500 ring-1 ring-pink-500' : 'border-gray-200 dark:border-gray-700'}">
                            <div class="absolute inset-0 bg-[#fce7f3]"></div>
                            <div class="absolute bottom-0 left-0 w-full h-1/2 bg-[#fff1f2]"></div>
                            ${store.settings.theme === 'cute' ? '<div class="absolute inset-0 flex items-center justify-center text-pink-600"><i class="fa-solid fa-check"></i></div>' : ''}
                            <span class="sr-only">Cute</span>
                        </button>

                         <!-- Sea Blue -->
                        <button onclick="setTheme('seablue')" 
                           class="group relative h-12 rounded-lg border-2 transition overflow-hidden ${store.settings.theme === 'seablue' ? 'border-cyan-500 ring-1 ring-cyan-500' : 'border-gray-200 dark:border-gray-700'}">
                            <div class="absolute inset-0 bg-gradient-to-br from-[#001f3f] via-[#003d5c] to-[#006d99]"></div>
                            ${store.settings.theme === 'seablue' ? '<div class="absolute inset-0 flex items-center justify-center text-white"><i class="fa-solid fa-check"></i></div>' : ''}
                            <span class="sr-only">Sea Blue</span>
                        </button>

                        <!-- Pastel -->
                        <button onclick="setTheme('pastel')" 
                           class="group relative h-12 rounded-lg border-2 transition overflow-hidden ${store.settings.theme === 'pastel' ? 'border-indigo-500 ring-1 ring-indigo-500' : 'border-gray-200 dark:border-gray-700'}">
                            <div class="absolute inset-0" style="background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%);"></div>
                            ${store.settings.theme === 'pastel' ? '<div class="absolute inset-0 flex items-center justify-center text-white drop-shadow-md"><i class="fa-solid fa-check"></i></div>' : ''}
                            <span class="sr-only">Pastel</span>
                        </button>
                    </div>

                </div>

                <!-- Auto Dark Mode -->
                <div class="flex items-center justify-between p-4 bg-gray-50 dark:bg-dark-bg rounded-xl border border-gray-100 dark:border-dark-border mt-3">
                    <div>
                        <div class="font-medium text-gray-800 dark:text-gray-200 flex items-center gap-2">
                            <i class="fa-solid fa-moon text-indigo-500"></i> Auto Dark Mode
                        </div>
                        <div class="text-xs text-gray-500 dark:text-gray-400">Automatically switch to dark theme after sunset (6 PM - 6 AM)</div>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" ${store.settings.autoDarkMode ? 'checked' : ''} onchange="toggleAutoDarkMode(this.checked)" class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
                    </label>
                </div>

            </div>

            <!-- Scheduled Transactions -->
            <div class="bg-white dark:bg-dark-surface p-6 rounded-3xl shadow-sm border border-gray-100 dark:border-dark-border">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="font-bold text-gray-700 dark:text-gray-300">
                        <i class="fa-solid fa-clock-rotate-left text-blue-500 mr-2"></i>Scheduled Transactions
                    </h3>
                </div>
                ${(() => {
                        const recurringTxs = store.transactions.filter(t => t.recurring);
                        if (recurringTxs.length === 0) {
                            return `<div class="text-center py-8 text-gray-400">
                            <i class="fa-solid fa-calendar-xmark text-4xl mb-3 opacity-50"></i>
                            <p>No scheduled transactions. Create a recurring transaction to see it here.</p>
                        </div>`;
                        }
                        return `<div class="space-y-3">
                        ${recurringTxs.map(tx => {
                            const acc = store.accounts.find(a => a.id === tx.accountId);
                            const isPaused = tx.paused === true;
                            return `
                        <div class="flex items-center justify-between p-4 rounded-xl border ${isPaused ? 'bg-gray-100 dark:bg-gray-800 border-gray-200 dark:border-gray-700 opacity-60' : 'bg-gray-50 dark:bg-dark-bg border-gray-100 dark:border-dark-border'}">
                            <div class="flex items-center gap-4">
                                <div class="w-10 h-10 rounded-xl flex items-center justify-center ${tx.type === 'income' ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'}">
                                    <i class="fa-solid ${tx.type === 'income' ? 'fa-arrow-down' : 'fa-arrow-up'}"></i>
                                </div>
                                <div>
                                    <div class="font-medium text-gray-800 dark:text-gray-200">${tx.desc || 'Unnamed'}</div>
                                    <div class="text-xs text-gray-500 dark:text-gray-400">
                                        ${formatMoney(tx.amount)}  ${tx.frequency}  ${acc ? acc.name : 'Unknown Account'}
                                    </div>
                                    <div class="text-xs ${isPaused ? 'text-orange-500' : 'text-blue-500'}">
                                        ${isPaused ? 'Paused' : 'Next: ' + (tx.nextDueDate || 'N/A')}
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <button onclick="toggleRecurringPause('${tx.id}')" class="w-9 h-9 rounded-lg flex items-center justify-center ${isPaused ? 'bg-green-100 text-green-600 hover:bg-green-200' : 'bg-orange-100 text-orange-600 hover:bg-orange-200'} transition" title="${isPaused ? 'Resume' : 'Pause'}">
                                    <i class="fa-solid ${isPaused ? 'fa-play' : 'fa-pause'}"></i>
                                </button>
                                <button onclick="openTxModal('${tx.id}')" class="w-9 h-9 rounded-lg flex items-center justify-center bg-blue-100 text-blue-600 hover:bg-blue-200 transition" title="Edit">
                                    <i class="fa-solid fa-pen-to-square"></i>
                                </button>
                                <button onclick="deleteTx('${tx.id}')" class="w-9 h-9 rounded-lg flex items-center justify-center bg-red-100 text-red-600 hover:bg-red-200 transition" title="Delete">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </div>
                        </div>`;
                        }).join('')}
                    </div>`;
                    })()}
            </div>

            <!-- Accounts Manager -->
            <div class="bg-white dark:bg-dark-surface p-6 rounded-3xl shadow-sm border border-gray-100 dark:border-dark-border">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="font-bold text-gray-700 dark:text-gray-300">Your Accounts</h3>
                    <button onclick="openAccountModal()" class="text-sm text-blue-600 font-medium hover:underline">+ Add
                        Account</button>
                </div>
                <div class="space-y-3">
                    ${store.accounts.map(a => `
                    <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-dark-bg rounded-xl border border-gray-100 dark:border-dark-border">
                        <div class="flex items-center gap-3">
                            <div
                                class="w-8 h-8 rounded-lg bg-white dark:bg-dark-surface flex items-center justify-center border border-gray-200 text-gray-500">
                                <i
                                    class="fa-solid ${a.type === 'asset' ? 'fa-wallet' : (a.type === 'liability' ? 'fa-credit-card' : 'fa-hand-holding-dollar')}"></i>
                            </div>
                            <div>
                                <div class="font-medium text-gray-800 dark:text-gray-200">${a.name}</div>
                                <div class="text-xs text-gray-400 capitalize">${a.type} | Current:
                                    ${formatMoney(getAccountBalance(a.id))}</div>
                            </div>
                        </div>
                        <div class="space-x-2">
                            <button onclick="openAccountModal('${a.id}')"
                                class="text-gray-400 hover:text-blue-500 p-2"><i
                                    class="fa-solid fa-pen-to-square"></i></button>
                            <button onclick="deleteAccount('${a.id}')" class="text-gray-400 hover:text-red-500 p-2"><i
                                    class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>
                    `).join('')}
                </div>
            </div>

            <!-- Categories Management -->
            <div class="bg-white dark:bg-dark-surface p-6 rounded-3xl shadow-sm border border-gray-100 dark:border-dark-border">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="font-bold text-gray-700 dark:text-gray-300">Categories</h3>
                    <button onclick="openCategoryModal()" class="text-sm text-blue-600 font-medium hover:underline">+
                        Add Category</button>
                </div>
                <div class="flex flex-wrap gap-2">
                    ${store.categories.map(c => `
                    <span
                        class="px-3 py-1 bg-gray-50 dark:bg-dark-bg border border-gray-200 rounded-lg text-sm text-gray-600 flex items-center gap-2 group">
                        ${c.name}
                        <i onclick="openCategoryModal('${c.id}')"
                            class="fa-solid fa-pen-to-square text-gray-300 hover:text-blue-500 cursor-pointer text-xs transition"></i>
                        <i onclick="deleteCategory('${c.id}')"
                            class="fa-solid fa-xmark text-gray-300 hover:text-red-500 cursor-pointer text-xs transition"></i>
                    </span>
                    `).join('')}
                </div>
            </div>

            <!-- App Security -->
            <div class="bg-white dark:bg-dark-surface p-6 rounded-3xl shadow-sm border border-gray-100 dark:border-dark-border mb-6">
                <h3 class="font-bold text-gray-700 dark:text-gray-300 mb-6">App Security</h3>
                <div class="flex items-center justify-between p-4 bg-gray-50 dark:bg-dark-bg rounded-xl border border-gray-100 dark:border-dark-border">
                    <div>
                        <div class="font-medium text-gray-800 dark:text-gray-200">Password Protection</div>
                        <div class="text-xs text-gray-500 dark:text-gray-400">
                            ${currentPassword ? 'App is currently password protected.' : 'Secure your data with a password.'}
                        </div>
                    </div>
                    <div>
                        ${currentPassword ? `
                            <button onclick="openPasswordModal('remove')" class="px-4 py-2 bg-red-50 text-red-600 hover:bg-red-100 rounded-lg text-sm font-bold mr-2 transition">Remove</button>
                            <button onclick="openPasswordModal('change')" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-bold shadow-sm transition">Change</button>
                        ` : `
                            <button onclick="openPasswordModal('set')" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-bold shadow-sm transition">Setup Password</button>
                        `}
                    </div>
                </div>

                <!-- Recovery Options -->
                ${currentPassword ? `
                <div class="mt-4 flex items-center justify-between p-4 bg-gray-50 dark:bg-dark-bg rounded-xl border border-gray-100 dark:border-dark-border">
                     <div>
                        <div class="font-medium text-gray-800 dark:text-gray-200">Account Recovery</div>
                        <div class="text-xs text-gray-500 dark:text-gray-400" id="recoveryStatus">
                            ${localStorage.getItem('flow_recovery_v1') ? 'Recovery questions are set.' : 'Set security questions to recover your password.'}
                        </div>
                    </div>
                    <div>
                        <button onclick="openRecoverySetupModal()" class="px-4 py-2 bg-purple-50 text-purple-600 hover:bg-purple-100 rounded-lg text-sm font-bold transition">
                            ${localStorage.getItem('flow_recovery_v1') ? 'Update Questions' : 'Setup Recovery'}
                        </button>
                    </div>
                </div>
                ` : ''}

            </div>

            <!-- Data Actions -->
                <div class="bg-white dark:bg-dark-surface p-6 rounded-3xl shadow-sm border border-gray-100 dark:border-dark-border">
                    <h3 class="font-bold text-gray-700 dark:text-gray-300 mb-6">Data Management</h3>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div class="border border-green-100 dark:border-green-900/30 bg-green-50 dark:bg-green-900/10 p-4 rounded-xl">
                            <div class="font-bold text-green-800 dark:text-green-400 mb-2">Excel / CSV</div>
                            <div class="flex gap-2">
                                <button onclick="exportCSV()"
                                    class="flex-1 px-3 py-2 bg-white dark:bg-dark-bg text-green-600 dark:text-green-400 border border-green-200 dark:border-green-800 rounded-lg text-sm font-medium hover:bg-green-50 dark:hover:bg-green-900/20 transition">Export
                                    CSV</button>
                                <label
                                    class="flex-1 px-3 py-2 bg-green-600 dark:bg-green-700 text-white rounded-lg text-sm font-medium hover:bg-green-700 dark:hover:bg-green-600 transition text-center cursor-pointer">
                                    Import <input type="file" class="hidden" accept=".csv" onchange="importCSV(this)">
                                </label>
                            </div>
                        </div>

                        <div class="border border-blue-100 dark:border-blue-900/30 bg-blue-50 dark:bg-blue-900/10 p-4 rounded-xl">
                            <div class="font-bold text-blue-800 dark:text-blue-400 mb-2">Full Backup (JSON)</div>
                            <div class="flex gap-2">
                                <button onclick="exportData()"
                                    class="flex-1 px-3 py-2 bg-white dark:bg-dark-bg text-blue-600 dark:text-blue-400 border border-blue-200 dark:border-blue-800 rounded-lg text-sm font-medium hover:bg-blue-50 dark:hover:bg-blue-900/20 transition">Backup</button>
                                <label
                                    class="flex-1 px-3 py-2 bg-blue-600 dark:bg-blue-700 text-white rounded-lg text-sm font-medium hover:bg-blue-700 dark:hover:bg-blue-600 transition text-center cursor-pointer">
                                    Restore <input type="file" class="hidden" accept=".json" onchange="importData(this)">
                                </label>
                            </div>
                        </div>
                        
                         <div class="border border-purple-100 dark:border-purple-900/30 bg-purple-50 dark:bg-purple-900/10 p-4 rounded-xl">
                            <div class="font-bold text-purple-800 dark:text-purple-400 mb-2">Database Dump (SQL)</div>
                            <div class="flex gap-2">
                                <button onclick="exportSQL()"
                                    class="flex-1 px-3 py-2 bg-white dark:bg-dark-bg text-purple-600 dark:text-purple-400 border border-purple-200 dark:border-purple-800 rounded-lg text-sm font-medium hover:bg-purple-50 dark:hover:bg-purple-900/20 transition">Export SQL</button>
                                <label
                                    class="flex-1 px-3 py-2 bg-purple-600 dark:bg-purple-700 text-white rounded-lg text-sm font-medium hover:bg-purple-700 dark:hover:bg-purple-600 transition text-center cursor-pointer">
                                    Import SQL <input type="file" class="hidden" accept=".sql" onchange="importSQL(this)">
                                </label>
                            </div>
                        </div>
                    </div>

                    <button onclick="resetApp()"
                        class="w-full px-4 py-3 bg-red-50 dark:bg-red-900/10 text-red-700 dark:text-red-400 rounded-xl font-medium hover:bg-red-100 dark:hover:bg-red-900/20 transition text-center border border-red-100 dark:border-red-900/30">Reset
                        All App Data</button>
                </div>
        </div>
        
        <!-- Credits -->
        <div class="text-center mt-10 pb-6 fade-in" style="animation-delay: 0.1s;">
            <p class="text-sm text-gray-500 dark:text-gray-400 mb-2">
                Made with <i class="fa-solid fa-heart text-red-500 mx-1 animate-pulse"></i> by <span class="font-bold text-gray-700 dark:text-gray-200">Dyal</span>
            </p>
            <a href="https://github.com/dyal96/flow/" target="_blank" 
               class="inline-flex items-center gap-2 px-4 py-2 bg-gray-100 dark:bg-dark-surface rounded-full text-xs font-bold text-gray-600 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-dark-bg transition group">
                <i class="fa-brands fa-github text-lg group-hover:text-black dark:group-hover:text-white transition-colors"></i> 
                <span>github.com/dyal96/flow</span>
            </a>
        </div>
        
        </div>
                `;
            }

            function updateCurrency(curr) {
                store.settings.currency = curr;
                save();
                renderSettings(document.getElementById('app-content'));
            }

            function updateDateFormat(fmt) {
                store.settings.dateFormat = fmt;
                save();
                renderSettings(document.getElementById('app-content'));
            }

            // Chart initialization functions defined in later section of the code

            // --- TRANSACTION HANDLERS (ADD/EDIT) ---

            function toggleAccountCategory() {
                const category = document.querySelector('input[name="accountCategory"]:checked').value;
                const assetOpts = document.getElementById('assetOptions');
                const liaOpts = document.getElementById('liabilityOptions');

                if (category === 'asset') {
                    assetOpts.classList.remove('hidden');
                    liaOpts.classList.add('hidden');

                    // Auto-select first if none checked or wrong type
                    if (!assetOpts.querySelector('input:checked')) {
                        assetOpts.querySelector('input').checked = true;
                    }
                } else {
                    assetOpts.classList.add('hidden');
                    liaOpts.classList.remove('hidden');

                    if (!liaOpts.querySelector('input:checked')) {
                        liaOpts.querySelector('input').checked = true;
                    }
                }
                toggleCCFields();
            }

            function toggleCCFields() {
                const types = document.querySelectorAll('input[name="accountType"]');
                let type = 'asset';
                types.forEach(t => { if (t.checked && !t.closest('div').classList.contains('hidden')) type = t.value; });
                // Or simpler, just query checked visible one

                // Check if liability options are visible
                const isLiability = document.getElementById('liabilityOptions').classList.contains('hidden') === false;

                const fields = document.getElementById('creditCardFields');
                const selectedType = document.querySelector('#liabilityOptions input:checked')?.value;

                if (isLiability && (selectedType === 'credit_card' || selectedType === 'loan')) {
                    fields.classList.remove('hidden');
                } else {
                    fields.classList.add('hidden');
                }
            }

            function toggleTransferMode(isTransfer) {
                const catField = document.getElementById('categoryField');
                const toAccField = document.getElementById('toAccountField');
                const accLabel = document.getElementById('accountLabel');
                const type = document.querySelector('#txModal input[name="txType"]:checked')?.value || 'expense';

                // Update styling based on type
                const modalHeader = document.querySelector('#txModalTitle').parentElement;
                const submitBtn = document.getElementById('txSubmitBtn');

                // Clear previous colors
                modalHeader.classList.remove('bg-red-50', 'bg-green-50', 'bg-gray-50/50', 'dark:bg-red-900/20', 'dark:bg-green-900/20', 'dark:bg-dark-bg/50');
                submitBtn.classList.remove('bg-red-600', 'hover:bg-red-700', 'bg-green-600', 'hover:bg-green-700', 'bg-blue-600', 'hover:bg-blue-700');

                if (type === 'expense') {
                    // Red theme
                    modalHeader.classList.add('bg-red-50', 'dark:bg-red-900/20');
                    submitBtn.classList.add('bg-red-600', 'hover:bg-red-700');
                } else if (type === 'income') {
                    // Green theme
                    modalHeader.classList.add('bg-green-50', 'dark:bg-green-900/20');
                    submitBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                } else {
                    // Transfer / Default (Blue/Gray)
                    modalHeader.classList.add('bg-gray-50/50', 'dark:bg-dark-bg/50');
                    submitBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                }

                if (isTransfer) {
                    catField.classList.add('hidden');
                    toAccField.classList.remove('hidden');
                    accLabel.innerText = "From Account";
                } else {
                    catField.classList.remove('hidden');
                    toAccField.classList.add('hidden');
                    accLabel.innerText = "Account";
                }

                updateCategoryDropdown();
            }

            function updateCategoryDropdown() {
                const type = document.querySelector('#txModal input[name="txType"]:checked')?.value || 'expense';
                const select = document.getElementById('txCategory');
                select.innerHTML = '';

                store.categories.filter(c => c.type === type).forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c.id;
                    opt.innerText = c.name;
                    select.appendChild(opt);
                });
            }

            function updateAccountDropdowns() {
                const opts = store.accounts.map(a => `<option value="${a.id}">${a.name}</option>`).join('');
                document.getElementById('txAccount').innerHTML = opts;
                document.getElementById('txToAccount').innerHTML = opts;
            }

            // --- HELPERS ---
            function isModalOpen() {
                const modals = ['txModal', 'accountModal', 'categoryModal', 'budgetModal', 'investmentModal', 'loanModal', 'payLoanModal', 'exportModal', 'confirmModal'];
                return modals.some(id => {
                    const el = document.getElementById(id);
                    return el && !el.classList.contains('hidden');
                });
            }

            function toggleFilterPanel() {
                const panel = document.getElementById('filterPanel');
                if (panel.classList.contains('hidden')) {
                    panel.classList.remove('hidden');
                } else {
                    panel.classList.add('hidden');
                }
            }

            function showConfirm(title, message, callback) {
                document.getElementById('confirmTitle').innerText = title;
                document.getElementById('confirmMessage').innerText = message;

                const btn = document.getElementById('confirmYesBtn');
                // Remove old listeners to prevent stacking
                const newBtn = btn.cloneNode(true);
                btn.parentNode.replaceChild(newBtn, btn);

                newBtn.onclick = () => {
                    callback();
                    closeModal('confirmModal');
                };

                openModal('confirmModal');
                // Auto-focus the Confirm (Yes) button as requested
                setTimeout(() => document.getElementById('confirmYesBtn').focus(), 100);
            }

            function openTxModal(txId = null, defaultType = null) {
                const isEdit = txId !== null;
                const txModal = document.getElementById('txModal');
                const form = document.getElementById('txForm');

                // Update currency symbol
                const symbol = (store.settings && store.settings.currency === 'INR') ? '' : '$';
                document.getElementById('txCurrencySymbol').innerText = symbol;

                form.reset();
                document.getElementById('txId').value = '';
                document.getElementById('txModalTitle').innerText = isEdit ? 'Edit Transaction' : 'New Entry';
                document.getElementById('txSubmitBtn').innerText = isEdit ? 'Update Transaction' : 'Save Transaction';

                updateAccountDropdowns();

                if (isEdit) {
                    const tx = store.transactions.find(t => t.id == txId);
                    if (tx) {
                        document.getElementById('txId').value = tx.id;
                        document.getElementById('txAmount').value = tx.amount;
                        document.getElementById('txDate').value = tx.date;
                        document.getElementById('txDesc').value = tx.desc;

                        document.querySelector(`input[name = "txType"][value = "${tx.type}"]`).checked = true;
                        toggleTransferMode(tx.type === 'transfer');

                        updateCategoryDropdown();

                        if (tx.type === 'transfer') {
                            document.getElementById('txAccount').value = tx.accountId;
                            document.getElementById('txToAccount').value = tx.toAccountId;
                        } else {
                            document.getElementById('txAccount').value = tx.accountId;
                            document.getElementById('txCategory').value = tx.category;
                        }
                    }
                } else {
                    // Default to Expense or provided type
                    const initType = defaultType || 'expense';
                    document.querySelector(`input[name = "txType"][value = "${initType}"]`).checked = true;

                    toggleTransferMode(initType === 'transfer');
                    document.getElementById('txDate').valueAsDate = new Date();
                    updateCategoryDropdown();

                    // Context-aware Account Selection
                    if (window.activeRoute === 'account_detail' && window.currentAccountId) {
                        const accField = document.getElementById('txAccount');
                        if (accField && accField.querySelector(`option[value="${window.currentAccountId}"]`)) {
                            accField.value = window.currentAccountId;
                        }
                    }

                    // Auto focus amount if new
                    setTimeout(() => document.getElementById('txAmount').focus(), 100);
                }

                openModal('txModal');
            }

            function handleTxSubmit(e) {
                e.preventDefault();

                const id = document.getElementById('txId').value;
                const type = document.querySelector('input[name="txType"]:checked').value;

                const recurring = document.getElementById('txRecurring').checked;
                const frequency = document.getElementById('txRecurrenceFreq').value;

                const newTx = {
                    id: id ? id : generateId('tx'),
                    type: type,
                    amount: parseFloat(document.getElementById('txAmount').value),
                    date: document.getElementById('txDate').value,
                    desc: document.getElementById('txDesc').value,
                    accountId: document.getElementById('txAccount').value,
                    recurring: recurring,
                    frequency: recurring ? frequency : null,
                    nextDueDate: recurring ? calculateNextDueDate(document.getElementById('txDate').value, frequency) : null
                };

                if (type === 'transfer') {
                    newTx.toAccountId = document.getElementById('txToAccount').value;
                    newTx.category = null;
                    newTx.categoryName = null;
                    if (newTx.accountId === newTx.toAccountId) {
                        alert("Cannot transfer to the same account.");
                        return;
                    }
                } else {
                    const catSelect = document.getElementById('txCategory');
                    newTx.category = catSelect.value;
                    newTx.categoryName = catSelect.options[catSelect.selectedIndex].text.split(' ')[0];
                    newTx.toAccountId = null;
                }

                if (id) {
                    // Update existing transaction
                    const index = store.transactions.findIndex(t => t.id == id);
                    if (index !== -1) {
                        store.transactions[index] = newTx;
                    }
                } else {
                    // Add new transaction
                    store.transactions.push(newTx);
                }

                save();
                closeModal('txModal');

                // Refresh current view
                const active = window.activeRoute || document.querySelector('.sidebar-item.active')?.getAttribute('onclick')?.match(/'([^']+)'/)?.[1] || 'dashboard';

                if (active === 'account_detail' && window.currentAccountId) {
                    router('account_detail', window.currentAccountId);
                } else {
                    router(active);
                }
            }

            // --- ACCOUNT HANDLERS (ADD/EDIT) ---

            function openAccountModal(accountId = null) {
                const isEdit = accountId !== null;
                const modal = document.getElementById('accountModal');
                const form = document.getElementById('accountForm');

                // Set Currency Symbol
                const symbol = (store.settings && store.settings.currency === 'INR') ? '' : '$';
                document.getElementById('accBalCurrency').innerText = symbol;
                const limitSymbol = document.getElementById('accLimitCurrency');
                if (limitSymbol) limitSymbol.innerText = symbol;

                form.reset();
                document.getElementById('accountId').value = '';
                document.getElementById('accountNotes').value = ''; // Reset notes
                document.getElementById('accountModalTitle').innerText = isEdit ? 'Edit Account' : 'Add New Account';
                document.getElementById('accountSubmitBtn').innerText = isEdit ? 'Update Account' : 'Save Account';

                if (isEdit) {
                    const acc = store.accounts.find(a => a.id === accountId);
                    if (acc) {
                        document.getElementById('accountId').value = acc.id;
                        document.getElementById('accountName').value = acc.name;
                        document.getElementById('accountOpeningBalance').value = acc.openingBalance;
                        document.getElementById('accountNotes').value = acc.notes || ''; // Populate notes

                        if (acc.billingDay) document.getElementById('accountBillingDay').value = acc.billingDay;
                        if (acc.gracePeriod) document.getElementById('accountGracePeriod').value = acc.gracePeriod;
                        if (acc.limit) document.getElementById('accountLimit').value = acc.limit;

                        // Set Category and Type
                        let category = 'asset';
                        if (['liability', 'credit_card', 'loan', 'payable'].includes(acc.type)) category = 'liability';
                        if (acc.type === 'general') {
                            // Guess based on balance? Or just default to Asset/Person
                            category = acc.openingBalance < 0 ? 'liability' : 'asset';
                            // Map type to 'general' or 'payable'
                            if (category === 'liability') {
                                document.querySelector(`input[name = "accountType"][value = "payable"]`).checked = true;
                            } else {
                                document.querySelector(`input[name = "accountType"][value = "general"]`).checked = true;
                            }
                        } else if (acc.type === 'loan') {
                            document.querySelector(`input[name = "accountType"][value = "loan"]`).checked = true;
                        } else {
                            // Standard types
                            const radio = document.querySelector(`input[name = "accountType"][value = "${acc.type}"]`);
                            if (radio) radio.checked = true;
                        }

                        document.querySelector(`input[name = "accountCategory"][value = "${category}"]`).checked = true;
                    }
                } else {
                    // Default to Asset for new accounts
                    document.querySelector('input[name="accountCategory"][value="asset"]').checked = true;
                    document.querySelector('#assetOptions input[value="asset"]').checked = true;
                }
                toggleAccountCategory();
                openModal('accountModal');
            }

            function handleAccountSubmit(e) {
                e.preventDefault();
                const id = document.getElementById('accountId').value;
                const name = document.getElementById('accountName').value;
                // Get checked accountType from the VISIBLE container
                const category = document.querySelector('input[name="accountCategory"]:checked').value;
                let type = 'asset';
                if (category === 'asset') {
                    type = document.querySelector('#assetOptions input:checked').value;
                } else {
                    type = document.querySelector('#liabilityOptions input:checked').value;
                }
                const openingBalance = parseFloat(document.getElementById('accountOpeningBalance').value);
                const notes = document.getElementById('accountNotes').value; // Capture notes

                // CC Fields
                const billingDay = document.getElementById('accountBillingDay').value;
                const gracePeriod = document.getElementById('accountGracePeriod').value;
                const limitValue = document.getElementById('accountLimit').value;

                const newAccount = { id: id || generateId('acc'), name, type, openingBalance, notes };
                if (type === 'credit_card') {
                    newAccount.billingDay = parseInt(billingDay) || 15;
                    newAccount.gracePeriod = parseInt(gracePeriod) || 20;
                    if (limitValue) newAccount.limit = parseFloat(limitValue);
                }

                if (id) {
                    // Update existing account
                    const index = store.accounts.findIndex(a => a.id === id);
                    if (index !== -1) {
                        store.accounts[index] = newAccount;
                    }
                } else {
                    // Add new account
                    store.accounts.push(newAccount);
                }

                save();
                closeModal('accountModal');
                router('accounts');
            }

            function deleteAccount(id) {
                showConfirm(
                    'Delete Account?',
                    'This will remove the account and all associated transactions. This action cannot be undone.',
                    () => {
                        store.accounts = store.accounts.filter(a => a.id !== id);
                        store.transactions = store.transactions.filter(t => t.accountId !== id && t.toAccountId !== id);
                        save();
                        const activeRoute = document.querySelector('.sidebar-item.active')?.getAttribute('onclick')?.match(/'([^']+)'/)[1];
                        router(activeRoute || 'accounts');
                    }
                );
            }

            // --- CATEGORY HANDLERS (ADD/EDIT) ---

            function openCategoryModal(categoryId = null) {
                const isEdit = categoryId !== null;
                const modal = document.getElementById('categoryModal');
                const form = document.getElementById('categoryForm');

                form.reset();
                document.getElementById('categoryId').value = '';
                document.getElementById('categoryModalTitle').innerText = isEdit ? 'Edit Category' : 'Add New Category';
                document.getElementById('categorySubmitBtn').innerText = isEdit ? 'Update Category' : 'Save Category';

                if (isEdit) {
                    const cat = store.categories.find(c => c.id === categoryId);
                    if (cat) {
                        document.getElementById('categoryId').value = cat.id;
                        document.getElementById('categoryName').value = cat.name;
                        document.querySelector(`input[name = "categoryType"][value = "${cat.type}"]`).checked = true;
                    }
                } else {
                    // Default to Expense for new categories
                    document.querySelector('input[name="categoryType"][value="expense"]').checked = true;
                }

                openModal('categoryModal');
            }

            function handleCategorySubmit(e) {
                e.preventDefault();
                const id = document.getElementById('categoryId').value;
                const name = document.getElementById('categoryName').value;
                const type = document.querySelector('input[name="categoryType"]:checked').value;

                const newCategory = { id: id || generateId('cat'), name, type };

                if (id) {
                    // Update existing category
                    const index = store.categories.findIndex(c => c.id === id);
                    if (index !== -1) {
                        store.categories[index] = newCategory;
                    }
                } else {
                    // Add new category
                    store.categories.push(newCategory);
                }

                save();
                closeModal('categoryModal');
                router('settings');
            }

            function deleteCategory(id) {
                store.categories = store.categories.filter(c => c.id !== id);
                save();
                router('settings');
            }



            // --- CHARTS & GRAPHS ---

            let mainChartInstance = null;
            let savingsChartInstance = null;
            let incChartInstance = null;
            let expChartInstance = null;

            // Helper function: Check if dark theme is active
            function isDarkTheme() {
                return document.documentElement.classList.contains('dark') ||
                    ['dark', 'seablue'].includes(store.settings.theme);
            }

            // Report Chart Instances
            let reportsDayChart = null;
            let reportsTrendChart = null;

            // Report State
            let reportFilter = {
                mode: 'this_month', // this_month, 3_months, year, custom
                start: null,
                end: null
            };

            let activeReportTab = 'income'; // income, expense, combined

            function updateReportFilter(mode, isCustom = false) {
                reportFilter.mode = mode;
                if (!isCustom) {
                    reportFilter.start = null;
                    reportFilter.end = null;
                }
                const container = document.getElementById('reportContainer');
                if (container) renderReports(container);
                else {
                    // Fallback if re-rendering from scratch or if container ID changes
                    router('reports');
                }
            }

            function setRecustomDates() {
                const s = document.getElementById('reportStart').value;
                const e = document.getElementById('reportEnd').value;
                if (s && e) {
                    reportFilter.mode = 'custom';
                    reportFilter.start = s;
                    reportFilter.end = e;
                    const container = document.getElementById('reportContainer');
                    if (container) renderReports(container);
                }
            }

            function setReportTab(tab) {
                activeReportTab = tab;
                const container = document.getElementById('reportContainer');
                if (container) renderReports(container);
                else router('reports');
            }

            function renderReports(container) {
                // Ensure container has ID for re-renders
                if (!container.id) container.id = 'reportContainer';

                // 1. Determine Date Range
                const now = new Date();
                let startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                let endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                let daysCount = now.getDate(); // Default to days elapsed in current month for average

                if (reportFilter.mode === '3_months') {
                    startDate = new Date(now.getFullYear(), now.getMonth() - 2, 1);
                    endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0); // End of current month
                    daysCount = Math.floor((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
                } else if (reportFilter.mode === 'year') {
                    startDate = new Date(now.getFullYear(), 0, 1);
                    endDate = new Date(now.getFullYear(), 11, 31);
                    // For average, use days elapsed so far in year if current year, else 365
                    const endOfCalc = (now.getFullYear() === startDate.getFullYear()) ? now : endDate;
                    daysCount = Math.floor((endOfCalc - startDate) / (1000 * 60 * 60 * 24)) + 1;
                } else if (reportFilter.mode === 'custom' && reportFilter.start && reportFilter.end) {
                    startDate = new Date(reportFilter.start);
                    endDate = new Date(reportFilter.end);
                    // For custom, average over total days in range
                    daysCount = Math.max(1, Math.floor((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1);
                }

                // Ensure dates are string comparable (YYYY-MM-DD or simple Obj comparison)
                // Actually simply comparing timestamps for transactions
                const startTs = startDate.setHours(0, 0, 0, 0);
                const endTs = endDate.setHours(23, 59, 59, 999);

                // 2. Process Transactions
                let totalSpend = 0;
                let totalIncome = 0;

                // Daily Arrays (Dynamic size based on range? Or just map by date string)
                const dailyStats = {}; // { 'YYYY-MM-DD': { income: 0, expense: 0 } }
                const spendByDay = Array(7).fill(0); // 0=Sun
                const incomeByDay = Array(7).fill(0);

                store.transactions.forEach(t => {
                    const d = new Date(t.date);
                    const ts = d.getTime();

                    if (ts >= startTs && ts <= endTs) {
                        const amt = parseFloat(t.amount);
                        const dayOfWeek = d.getDay();
                        const dateStr = t.date;

                        if (!dailyStats[dateStr]) dailyStats[dateStr] = { income: 0, expense: 0 };

                        if (t.type === 'expense') {
                            totalSpend += amt;
                            spendByDay[dayOfWeek] += amt;
                            dailyStats[dateStr].expense += amt;
                        } else if (t.type === 'income') {
                            totalIncome += amt;
                            incomeByDay[dayOfWeek] += amt;
                            dailyStats[dateStr].income += amt;
                        }
                    }
                });

                // 3. Analysis
                const avgDailySpend = daysCount > 0 ? totalSpend / daysCount : 0;
                const avgDailyIncome = daysCount > 0 ? totalIncome / daysCount : 0;
                const netSavings = totalIncome - totalSpend;
                const savingsRate = totalIncome > 0 ? (netSavings / totalIncome) * 100 : 0;

                // Max Days
                let maxSpendDay = { date: 'N/A', amount: 0 };
                let maxIncomeDay = { date: 'N/A', amount: 0 };

                const sortedDates = Object.keys(dailyStats).sort();
                sortedDates.forEach(date => {
                    const s = dailyStats[date];
                    if (s.expense > maxSpendDay.amount) maxSpendDay = { date, amount: s.expense };
                    if (s.income > maxIncomeDay.amount) maxIncomeDay = { date, amount: s.income };
                });

                const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];

                // Busiest Days
                let maxSpendWeekDayIndex = 0;
                let maxIncomeWeekDayIndex = 0;
                for (let i = 1; i < 7; i++) {
                    if (spendByDay[i] > spendByDay[maxSpendWeekDayIndex]) maxSpendWeekDayIndex = i;
                    if (incomeByDay[i] > incomeByDay[maxIncomeWeekDayIndex]) maxIncomeWeekDayIndex = i;
                }
                const busiestSpendDay = totalSpend > 0 ? dayNames[maxSpendWeekDayIndex] : 'N/A';
                const busiestIncomeDay = totalIncome > 0 ? dayNames[maxIncomeWeekDayIndex] : 'N/A';


                // 4. Render Layout
                container.innerHTML = `
                <div class="max-w-7xl mx-auto space-y-8 fade-in">
                    
                    <!-- Header & Controls -->
                    <div class="flex flex-col xl:flex-row justify-between items-start xl:items-center gap-4">
                        <div>
                            <h2 class="text-3xl font-bold text-gray-800 dark:text-gray-200 tracking-tight">Financial Reports</h2>
                            <p class="text-gray-500 font-medium">
                                ${startDate.toLocaleDateString(undefined, { month: 'long', day: 'numeric', year: 'numeric' })} - ${endDate.toLocaleDateString(undefined, { month: 'long', day: 'numeric', year: 'numeric' })}
                            </p>
                        </div>

                        <div class="flex flex-col sm:flex-row gap-4 w-full xl:w-auto">
                            <!-- Tab Switcher -->
                             <div class="bg-gray-100 dark:bg-dark-surface p-1.5 rounded-2xl flex">
                                <button onclick="setReportTab('income')" class="flex-1 px-6 py-2.5 rounded-xl text-sm font-bold transition ${activeReportTab === 'income' ? 'bg-white dark:bg-dark-bg shadow-sm text-green-600 dark:text-green-400' : 'text-gray-500 hover:text-gray-700 dark:text-gray-400'}">Income</button>
                                <button onclick="setReportTab('expense')" class="flex-1 px-6 py-2.5 rounded-xl text-sm font-bold transition ${activeReportTab === 'expense' ? 'bg-white dark:bg-dark-bg shadow-sm text-red-600 dark:text-red-400' : 'text-gray-500 hover:text-gray-700 dark:text-gray-400'}">Expense</button>
                                <button onclick="setReportTab('combined')" class="flex-1 px-6 py-2.5 rounded-xl text-sm font-bold transition ${activeReportTab === 'combined' ? 'bg-white dark:bg-dark-bg shadow-sm text-blue-600 dark:text-blue-400' : 'text-gray-500 hover:text-gray-700 dark:text-gray-400'}">Combined</button>
                            </div>

                            <!-- Filter Controls -->
                            <div class="flex items-center gap-2 bg-white dark:bg-dark-surface p-1.5 rounded-2xl shadow-sm border border-gray-100 dark:border-dark-border">
                                <button onclick="updateReportFilter('this_month')" 
                                    class="px-4 py-2.5 rounded-xl text-sm font-bold transition ${reportFilter.mode === 'this_month' ? 'bg-blue-50 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400' : 'text-gray-500 hover:bg-gray-50 dark:hover:bg-dark-bg transition'}">
                                    Month
                                </button>
                                <button onclick="updateReportFilter('3_months')" 
                                    class="px-4 py-2.5 rounded-xl text-sm font-bold transition ${reportFilter.mode === '3_months' ? 'bg-blue-50 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400' : 'text-gray-500 hover:bg-gray-50 dark:hover:bg-dark-bg transition'}">
                                    3 Mo
                                </button>
                                <button onclick="updateReportFilter('year')" 
                                    class="px-4 py-2.5 rounded-xl text-sm font-bold transition ${reportFilter.mode === 'year' ? 'bg-blue-50 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400' : 'text-gray-500 hover:bg-gray-50 dark:hover:bg-dark-bg transition'}">
                                    Year
                                </button>
                                <button onclick="document.getElementById('customDateModal').classList.remove('hidden')" 
                                    class="px-4 py-2.5 rounded-xl text-sm font-bold transition ${reportFilter.mode === 'custom' ? 'bg-blue-50 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400' : 'text-gray-500 hover:bg-gray-50 dark:hover:bg-dark-bg transition'}">
                                    Custom
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- CONDITIONAL CONTENT BASED ON TAB -->
                    ${activeReportTab === 'income' ? `
                        <!-- INCOME METRICS -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="bg-white dark:bg-dark-surface p-5 rounded-3xl shadow-sm border border-gray-100 dark:border-dark-border relative overflow-hidden group">
                                <div class="absolute right-4 top-4 p-2 bg-green-50 dark:bg-green-900/20 rounded-2xl text-green-600 dark:text-green-400">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                </div>
                                <div class="text-sm text-gray-500 font-semibold mb-1">Total Income</div>
                                <div class="text-3xl font-extrabold text-green-600 dark:text-green-400 tracking-tight">${formatMoney(totalIncome)}</div>
                                <div class="mt-2 text-xs font-medium text-gray-400 flex items-center gap-1">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
                                    Avg: ${formatMoney(avgDailyIncome)} / day
                                </div>
                            </div>
                            <div class="bg-white dark:bg-dark-surface p-5 rounded-3xl shadow-sm border border-gray-100 dark:border-dark-border relative overflow-hidden group">
                                <div class="absolute right-4 top-4 p-2 bg-blue-50 dark:bg-blue-900/20 rounded-2xl text-blue-600 dark:text-blue-400">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
                                </div>
                                <div class="text-sm text-gray-500 font-semibold mb-1">Highest Day</div>
                                <div class="text-xl font-bold text-gray-800 dark:text-gray-200">${maxIncomeDay.date !== 'N/A' ? new Date(maxIncomeDay.date).toLocaleDateString(undefined, { weekday: 'short', day: 'numeric' }) : 'N/A'}</div>
                                <div class="text-2xl font-extrabold text-gray-800 dark:text-gray-100 mt-1">${formatMoney(maxIncomeDay.amount)}</div>
                            </div>
                            <div class="bg-white dark:bg-dark-surface p-5 rounded-3xl shadow-sm border border-gray-100 dark:border-dark-border relative overflow-hidden group">
                                <div class="absolute right-4 top-4 p-2 bg-purple-50 dark:bg-purple-900/20 rounded-2xl text-purple-600 dark:text-purple-400">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                </div>
                                <div class="text-sm text-gray-500 font-semibold mb-1">Best Weekday</div>
                                <div class="text-2xl font-extrabold text-gray-800 dark:text-gray-200">${busiestIncomeDay}</div>
                                <div class="mt-2 text-xs font-medium text-gray-400">Most active earning day</div>
                            </div>
                        </div>
                    ` : activeReportTab === 'expense' ? `
                         <!-- EXPENSE METRICS -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="bg-white dark:bg-dark-surface p-5 rounded-3xl shadow-sm border border-gray-100 dark:border-dark-border relative overflow-hidden group">
                                <div class="absolute right-4 top-4 p-2 bg-red-50 dark:bg-red-900/20 rounded-2xl text-red-600 dark:text-red-400">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                </div>
                                <div class="text-sm text-gray-500 font-semibold mb-1">Total Expense</div>
                                <div class="text-3xl font-extrabold text-red-600 dark:text-red-400 tracking-tight">${formatMoney(totalSpend)}</div>
                                <div class="mt-2 text-xs font-medium text-gray-400 flex items-center gap-1">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6"></path></svg>
                                    Avg: ${formatMoney(avgDailySpend)} / day
                                </div>
                            </div>
                            <div class="bg-white dark:bg-dark-surface p-5 rounded-3xl shadow-sm border border-gray-100 dark:border-dark-border relative overflow-hidden group">
                                <div class="absolute right-4 top-4 p-2 bg-orange-50 dark:bg-orange-900/20 rounded-2xl text-orange-600 dark:text-orange-400">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6"></path></svg>
                                </div>
                                <div class="text-sm text-gray-500 font-semibold mb-1">Highest Spend</div>
                                <div class="text-xl font-bold text-gray-800 dark:text-gray-200">${maxSpendDay.date !== 'N/A' ? new Date(maxSpendDay.date).toLocaleDateString(undefined, { weekday: 'short', day: 'numeric' }) : 'N/A'}</div>
                                <div class="text-2xl font-extrabold text-gray-800 dark:text-gray-100 mt-1">${formatMoney(maxSpendDay.amount)}</div>
                            </div>
                             <div class="bg-white dark:bg-dark-surface p-5 rounded-3xl shadow-sm border border-gray-100 dark:border-dark-border relative overflow-hidden group">
                                <div class="absolute right-4 top-4 p-2 bg-purple-50 dark:bg-purple-900/20 rounded-2xl text-purple-600 dark:text-purple-400">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                </div>
                                <div class="text-sm text-gray-500 font-semibold mb-1">Busy Weekday</div>
                                <div class="text-2xl font-extrabold text-gray-800 dark:text-gray-200">${busiestSpendDay}</div>
                                <div class="mt-2 text-xs font-medium text-gray-400">Most active spending day</div>
                            </div>
                        </div>
                    ` : `
                        <!-- COMBINED METRICS -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="bg-white dark:bg-dark-surface p-5 rounded-3xl shadow-sm border border-gray-100 dark:border-dark-border relative overflow-hidden">
                                <div class="absolute right-4 top-4 p-2 bg-green-50 dark:bg-green-900/20 rounded-2xl text-green-600 dark:text-green-400">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                </div>
                                <div class="text-sm text-gray-500 font-semibold mb-1">Total Income</div>
                                <div class="text-2xl font-extrabold text-green-600 dark:text-green-400 tracking-tight">${formatMoney(totalIncome)}</div>
                            </div>
                             <div class="bg-white dark:bg-dark-surface p-5 rounded-3xl shadow-sm border border-gray-100 dark:border-dark-border relative overflow-hidden">
                                <div class="absolute right-4 top-4 p-2 bg-red-50 dark:bg-red-900/20 rounded-2xl text-red-600 dark:text-red-400">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                </div>
                                <div class="text-sm text-gray-500 font-semibold mb-1">Total Expense</div>
                                <div class="text-2xl font-extrabold text-red-600 dark:text-red-400 tracking-tight">${formatMoney(totalSpend)}</div>
                            </div>
                            <div class="bg-white dark:bg-dark-surface p-5 rounded-3xl shadow-sm border border-gray-100 dark:border-dark-border relative overflow-hidden">
                                <div class="absolute right-4 top-4 p-2 bg-blue-50 dark:bg-blue-900/20 rounded-2xl text-blue-600 dark:text-blue-400">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                </div>
                                <div class="text-sm text-gray-500 font-semibold mb-1">Net Savings</div>
                                <div class="text-2xl font-extrabold ${netSavings >= 0 ? 'text-blue-600 dark:text-blue-400' : 'text-red-500'} tracking-tight">${formatMoney(netSavings)}</div>
                                <div class="mt-2 text-xs font-medium text-gray-400">Savings Rate: ${savingsRate.toFixed(1)}%</div>
                            </div>
                        </div>
                    `}

                    <!-- Charts Grid -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4"> <!-- START GRID -->
                        
                        <!-- Left Chart: Radar (Visible only on Income/Expense) -->
                         ${activeReportTab !== 'combined' ? `
                         <div class="bg-white dark:bg-dark-surface p-5 rounded-3xl shadow-sm border border-gray-100 dark:border-dark-border min-h-[320px]">
                            <h3 class="font-bold text-gray-700 dark:text-gray-300 mb-4">
                                ${activeReportTab === 'income' ? 'Income Pattern' : 'Spending Pattern'}
                            </h3>
                            <div class="h-64 relative">
                                <canvas id="reportsDayChart"></canvas>
                            </div>
                        </div>
                        ` : ''}

                        <!-- Right Chart: Trend (Spans full if Combined) -->
                        <div class="bg-white dark:bg-dark-surface p-5 rounded-3xl shadow-sm border border-gray-100 dark:border-dark-border min-h-[320px] ${activeReportTab === 'combined' ? 'col-span-1 lg:col-span-2' : ''}">
                            <h3 class="font-bold text-gray-700 dark:text-gray-300 mb-4">
                                ${activeReportTab === 'income' ? 'Daily Income Trend' : activeReportTab === 'expense' ? 'Daily Spending Trend' : 'Income vs Expense Flow'}
                            </h3>
                            <div class="h-64 relative">
                                <canvas id="reportsTrendChart"></canvas>
                            </div>
                        </div>

                    </div> <!-- END GRID -->
                </div>

                <!-- Custom Date Picker Modal -->
                <div id="customDateModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center fade-in">
                    <div class="bg-white dark:bg-dark-surface p-6 rounded-2xl shadow-xl w-full max-w-sm m-4 scale-in">
                        <h3 class="text-lg font-bold text-gray-800 dark:text-gray-200 mb-4">Select Date Range</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-1">Start Date</label>
                                <input type="date" id="reportStart" value="${reportFilter.start || ''}" class="w-full bg-gray-50 dark:bg-dark-bg border border-gray-200 dark:border-dark-border rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-blue-500 dark:text-white">
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-1">End Date</label>
                                <input type="date" id="reportEnd" value="${reportFilter.end || ''}" class="w-full bg-gray-50 dark:bg-dark-bg border border-gray-200 dark:border-dark-border rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-blue-500 dark:text-white">
                            </div>
                            <div class="flex gap-3 pt-2">
                                <button onclick="document.getElementById('customDateModal').classList.add('hidden')" class="flex-1 px-4 py-2 rounded-xl text-gray-500 hover:bg-gray-100 dark:hover:bg-dark-bg font-semibold transition">Cancel</button>
                                <button onclick="setRecustomDates(); document.getElementById('customDateModal').classList.add('hidden')" class="flex-1 px-4 py-2 rounded-xl bg-blue-600 text-white shadow-lg shadow-blue-500/30 hover:bg-blue-700 font-semibold transition">Apply</button>
                            </div>
                        </div>
                    </div>
                </div>
                `;

                // Render Charts
                const isDark = isDarkTheme();
                const textColor = isDark ? '#a1a1aa' : '#64748b';
                const gridColor = isDark ? '#334155' : '#f1f5f9';

                // Prepare Data
                const fullDateRange = [];
                for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                    // Use local time formatting to avoid TZ issues
                    const year = d.getFullYear();
                    const month = String(d.getMonth() + 1).padStart(2, '0');
                    const day = String(d.getDate()).padStart(2, '0');
                    fullDateRange.push(`${year}-${month}-${day}`);
                }

                const trendLabels = fullDateRange;
                const dailyIncData = fullDateRange.map(dateStr => dailyStats[dateStr] ? dailyStats[dateStr].income : 0);
                const dailyExpData = fullDateRange.map(dateStr => dailyStats[dateStr] ? dailyStats[dateStr].expense : 0);

                // 1. TREND CHART
                if (reportsTrendChart) reportsTrendChart.destroy();
                const trendCtx = document.getElementById('reportsTrendChart').getContext('2d');

                let datasets = [];
                if (activeReportTab === 'income') {
                    datasets.push({
                        label: 'Income',
                        data: dailyIncData,
                        borderColor: '#22c55e',
                        backgroundColor: (ctx) => {
                            const gradient = ctx.chart.ctx.createLinearGradient(0, 0, 0, 300);
                            gradient.addColorStop(0, 'rgba(34, 197, 94, 0.4)');
                            gradient.addColorStop(1, 'rgba(34, 197, 94, 0)');
                            return gradient;
                        },
                        fill: true,
                        tension: 0.4,
                        pointRadius: 3
                    });
                } else if (activeReportTab === 'expense') {
                    datasets.push({
                        label: 'Expense',
                        data: dailyExpData,
                        borderColor: '#f97316',
                        backgroundColor: (ctx) => {
                            const gradient = ctx.chart.ctx.createLinearGradient(0, 0, 0, 300);
                            gradient.addColorStop(0, 'rgba(249, 115, 22, 0.4)');
                            gradient.addColorStop(1, 'rgba(249, 115, 22, 0)');
                            return gradient;
                        },
                        fill: true,
                        tension: 0.4,
                        pointRadius: 3
                    });
                } else {
                    // Combined
                    datasets = [
                        {
                            label: 'Income',
                            data: dailyIncData,
                            borderColor: '#22c55e',
                            backgroundColor: 'rgba(34, 197, 94, 0.1)',
                            fill: true,
                            tension: 0.3
                        },
                        {
                            label: 'Expense',
                            data: dailyExpData,
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            fill: true,
                            tension: 0.3
                        }
                    ];
                }

                reportsTrendChart = new Chart(trendCtx, {
                    type: 'line',
                    data: {
                        labels: trendLabels.map(d => d.substring(5)),
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: activeReportTab === 'combined' } },
                        scales: {
                            y: { beginAtZero: true, grid: { color: gridColor }, ticks: { color: textColor } },
                            x: { grid: { display: false }, ticks: { color: textColor } }
                        }
                    }
                });


                // 2. RADAR CHART (Only for Income/Expense tabs)
                if (activeReportTab !== 'combined') {
                    if (reportsDayChart) reportsDayChart.destroy();
                    const dayCtx = document.getElementById('reportsDayChart').getContext('2d');

                    const radarData = activeReportTab === 'income' ? incomeByDay : spendByDay;
                    const color = activeReportTab === 'income' ? '34, 197, 94' : '59, 130, 246'; // Green vs Blue (or Orange?) 
                    // Let's use BlueGS standard for Spending, Green for Income.
                    // Actually expense usually red/orange. Let's use Orange for expense radar to match trend? 
                    // Or keep Blue for "Spending" as per original design. Let's use Blue for Expense Radar, Green for Income Radar.

                    const radarColor = activeReportTab === 'income' ? '34, 197, 94' : '59, 130, 246';

                    reportsDayChart = new Chart(dayCtx, {
                        type: 'radar',
                        data: {
                            labels: dayNames,
                            datasets: [{
                                label: 'Activity',
                                data: radarData,
                                backgroundColor: `rgba(${radarColor}, 0.2)`,
                                borderColor: `rgba(${radarColor}, 1)`,
                                pointBackgroundColor: `rgba(${radarColor}, 1)`,
                                borderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: {
                                r: {
                                    grid: { color: gridColor },
                                    pointLabels: { color: textColor, font: { size: 12 } },
                                    ticks: { display: false, backdropColor: 'transparent' },
                                    angleLines: { color: gridColor }
                                }
                            }
                        }
                    });
                }
            }



            // --- CHART HELPERS ---

            function initMainChart() {
                // Last 6 months data
                const months = [];
                const incomeData = [];
                const expenseData = [];

                for (let i = 5; i >= 0; i--) {
                    const d = new Date();
                    d.setMonth(d.getMonth() - i);
                    const m = d.getMonth();
                    const y = d.getFullYear();

                    months.push(d.toLocaleString('default', { month: 'short' }));
                    incomeData.push(calculateTotal('income', m, y));
                    expenseData.push(calculateTotal('expense', m, y));
                }

                // Destroy previous instance to prevent memory leak
                if (mainChartInstance) {
                    mainChartInstance.destroy();
                    mainChartInstance = null;
                }

                const ctx = document.getElementById('mainChart').getContext('2d');
                const isDark = isDarkTheme();

                mainChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: months,
                        datasets: [
                            {
                                label: 'Income',
                                data: incomeData,
                                backgroundColor: '#34a853',
                                borderRadius: 6,
                                barPercentage: 0.6,
                            },
                            {
                                label: 'Expense',
                                data: expenseData,
                                backgroundColor: '#ea4335',
                                borderRadius: 6,
                                barPercentage: 0.6,
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: { color: isDark ? '#f4f4f5' : '#666' }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: { color: isDark ? '#3f3f46' : '#f0f0f0' },
                                ticks: { color: isDark ? '#a1a1aa' : '#666' }
                            },
                            x: {
                                grid: { display: false },
                                ticks: { color: isDark ? '#a1a1aa' : '#666' }
                            }
                        }
                    }
                });
            }

            function initSavingsChart() {
                // Savings Trend (Income - Expense)
                const months = [];
                const savingsData = [];

                for (let i = 5; i >= 0; i--) {
                    const d = new Date();
                    d.setMonth(d.getMonth() - i);
                    const m = d.getMonth();
                    const y = d.getFullYear();

                    months.push(d.toLocaleString('default', { month: 'short' }));
                    const inc = calculateTotal('income', m, y);
                    const exp = calculateTotal('expense', m, y);
                    savingsData.push(inc - exp);
                }

                // Destroy previous instance to prevent memory leak
                if (savingsChartInstance) {
                    savingsChartInstance.destroy();
                    savingsChartInstance = null;
                }

                const ctx = document.getElementById('savingsChart').getContext('2d');
                const isDark = isDarkTheme();

                savingsChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: months,
                        datasets: [{
                            label: 'Net Savings',
                            data: savingsData,
                            borderColor: '#1a73e8',
                            backgroundColor: (context) => {
                                const ctx = context.chart.ctx;
                                const gradient = ctx.createLinearGradient(0, 0, 0, 200);
                                gradient.addColorStop(0, 'rgba(26, 115, 232, 0.4)');
                                gradient.addColorStop(1, 'rgba(26, 115, 232, 0.0)');
                                return gradient;
                            },
                            borderWidth: 3,
                            pointBackgroundColor: '#fff',
                            pointBorderColor: '#1a73e8',
                            pointRadius: 4,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: { color: isDark ? '#3f3f46' : '#f0f0f0' },
                                ticks: { color: isDark ? '#a1a1aa' : '#666' }
                            },
                            x: {
                                grid: { display: false },
                                ticks: { color: isDark ? '#a1a1aa' : '#666' }
                            }
                        }
                    }
                });
            }

            function initDonut(canvasId, dataObj, colors, legendId) {
                const ctx = document.getElementById(canvasId);
                if (!ctx) return;

                // Handle Instances
                if (canvasId === 'incChart') {
                    if (incChartInstance) incChartInstance.destroy();
                } else {
                    if (expChartInstance) expChartInstance.destroy();
                }

                const labels = Object.keys(dataObj);
                const data = Object.values(dataObj);
                const total = data.reduce((a, b) => a + b, 0);

                if (labels.length === 0) {
                    return;
                }

                const config = {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: colors,
                            borderWidth: 0,
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '70%',
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        const label = context.label || '';
                                        const value = context.raw || 0;
                                        const percentage = Math.round((value / total) * 100) + '%';
                                        return `${label}: ${formatMoney(value)} (${percentage})`;
                                    }
                                }
                            }
                        }
                    },
                    plugins: [{
                        id: 'centerText',
                        beforeDraw: function (chart) {
                            const width = chart.width, height = chart.height, ctx = chart.ctx;
                            ctx.restore();

                            // Draw Total
                            const text = formatMoney(total);

                            ctx.font = "bold 1.2em sans-serif";
                            ctx.textBaseline = "middle";
                            ctx.fillStyle = document.documentElement.classList.contains('dark') ? '#f1f5f9' : '#1e293b';

                            const textX = Math.round((width - ctx.measureText(text).width) / 2);
                            const textY = height / 2;

                            ctx.fillText(text, textX, textY);
                            ctx.save();
                        }
                    }]
                };

                const chart = new Chart(ctx, config);
                if (canvasId === 'incChart') incChartInstance = chart;
                else expChartInstance = chart;

                // Render Custom Legend
                const legend = document.getElementById(legendId);
                if (legend) {
                    legend.innerHTML = labels.map((l, i) => {
                        const pct = ((data[i] / total) * 100).toFixed(1);
                        return `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full" style="background-color: ${colors[i % colors.length]}"></span>
                            <span class="text-gray-600 truncate w-24" title="${l}">${l}</span>
                        </div>
                        <div class="text-right">
                            <span class="font-bold text-gray-800 dark:text-gray-200 block text-xs">${formatMoney(data[i])}</span>
                            <span class="text-[10px] text-gray-400 block">${pct}%</span>
                        </div>
                    </div>
                `}).join('');
                }
            }

            function deleteTx(id) {
                showConfirm('Delete Transaction?', 'Are you sure you want to delete this transaction?', () => {
                    store.transactions = store.transactions.filter(t => t.id != id);
                    save();

                    const active = window.activeRoute || document.querySelector('.sidebar-item.active')?.getAttribute('onclick')?.match(/'([^']+)'/)?.[1] || 'dashboard';
                    if (active === 'account_detail' && window.currentAccountId) {
                        router('account_detail', window.currentAccountId);
                    } else {
                        router(active);
                    }
                });
            }

            // --- DATA MANAGEMENT & UTILS (CSV/PDF) ---

            function exportData() {
                const blob = new Blob([JSON.stringify(store, null, 2)], { type: "application/json" });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `flow_backup_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
            }

            function importData(input) {
                const reader = new FileReader();
                reader.onload = e => {
                    try {
                        const importedData = JSON.parse(e.target.result);

                        // Validate required structure
                        if (!importedData.accounts || !importedData.transactions || !importedData.categories) {
                            alert('Invalid backup file. Missing required data (accounts, transactions, or categories).');
                            return;
                        }

                        store = importedData;
                        save();
                        alert('Import Successful! App will refresh.');
                        location.reload();
                    } catch (err) {
                        console.error('Import Error:', err);
                        alert('Failed to import data. The file may be corrupted or invalid.');
                    }
                };
                reader.readAsText(input.files[0]);
            }

            // --- TRANSACTION MONTH NAVIGATION ---
            let currentTxMonth = new Date();

            function navigateTransactionMonth(direction) {
                currentTxMonth.setMonth(currentTxMonth.getMonth() + direction);
                updateTransactionMonthDisplay();
                applyFilters();
            }

            function updateTransactionMonthDisplay() {
                const display = document.getElementById('txMonthYearDisplay');
                if (display) {
                    display.innerHTML = `
                    <div class="text-lg font-bold text-gray-800 dark:text-gray-200">${currentTxMonth.toLocaleString('default', { month: 'long' })}</div>
                    <div class="text-xs text-gray-400">${currentTxMonth.getFullYear()}</div>
            `;
                }
            }

            function toggleTransactionSearch() {
                const container = document.getElementById('txSearchContainer');
                if (container) {
                    container.classList.toggle('hidden');
                    if (!container.classList.contains('hidden')) {
                        document.getElementById('txSearch')?.focus();
                    }
                }
            }

            // --- ACCOUNT EXPORT FUNCTIONS ---
            function openAccountExportModal() {
                window.exportMode = 'accounts';
                const title = document.querySelector('#accountExportModal h2');
                if (title) title.textContent = 'Export Accounts';
                openModal('accountExportModal');
            }

            function openBankingExportModal() {
                window.exportMode = 'banking';
                const title = document.querySelector('#accountExportModal h2');
                if (title) title.textContent = 'Export Banking Data';
                openModal('accountExportModal');
            }

            function handleUniversalExport(type) {
                closeModal('accountExportModal');
                if (window.exportMode === 'banking') {
                    if (type === 'csv') exportBankingCSV();
                    else exportBankingPDF();
                } else {
                    if (type === 'csv') exportAccountsCSV();
                    else exportAccountsPDF();
                }
            }

            function exportBankingCSV() {
                const fds = (store.investments || []).map(inv => ({
                    Category: 'Fixed Deposit',
                    Name: inv.name,
                    'Start Date': inv.startDate,
                    'Maturity Date': inv.maturityDate,
                    Principal: inv.amount,
                    Rate: inv.rate + '%',
                    'Current Value': calculateCurrentValue(inv).toFixed(2)
                }));

                const loans = (store.loans || []).map(l => {
                    const details = calculateLoanDetails(l);
                    return {
                        Category: 'Loan',
                        Name: l.name,
                        'Start Date': l.startDate,
                        Principal: l.amount,
                        Rate: l.rate + '%',
                        Paid: details.paid,
                        Outstanding: details.outstanding.toFixed(2)
                    };
                });

                const data = [...fds, ...loans];
                if (!data.length) return alert('No banking data found.');

                const csv = Papa.unparse(data);
                const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `banking_export_${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
            }

            function exportBankingPDF() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                doc.setFont("helvetica", "bold");
                doc.setFontSize(22);
                doc.setTextColor(59, 130, 246);
                doc.text("Flow Accounting", 20, 20);

                doc.setFontSize(14);
                doc.setTextColor(100);
                doc.text("Banking & Assets Report", 20, 30);
                doc.setFontSize(10);
                doc.text(`Generated: ${new Date().toLocaleDateString()}`, 20, 36);

                let y = 50;

                // Fixed Deposits
                const fds = store.investments || [];
                if (fds.length > 0) {
                    doc.setFontSize(14);
                    doc.setTextColor(0);
                    doc.text("Fixed Deposits", 20, y);
                    y += 10;

                    const fdHeaders = [["Name", "Start", "Maturity", "Principal", "Rate", "Current"]];
                    const fdRows = fds.map(inv => [
                        inv.name,
                        inv.startDate,
                        inv.maturityDate,
                        formatMoneyPlain(inv.amount),
                        inv.rate + '%',
                        formatMoneyPlain(calculateCurrentValue(inv))
                    ]);

                    doc.autoTable({
                        startY: y,
                        head: fdHeaders,
                        body: fdRows,
                        theme: 'striped',
                        headStyles: { fillColor: [22, 163, 74] } // Green
                    });
                    y = doc.lastAutoTable.finalY + 20;
                }

                // Loans
                const loans = store.loans || [];
                if (loans.length > 0) {
                    doc.setFontSize(14);
                    doc.setTextColor(0);
                    doc.text("Loans", 20, y);
                    y += 10;

                    const loanHeaders = [["Name", "Start", "Principal", "Rate", "Paid", "Outstanding"]];
                    const loanRows = loans.map(l => {
                        const d = calculateLoanDetails(l);
                        return [
                            l.name,
                            l.startDate,
                            formatMoneyPlain(l.amount),
                            l.rate + '%',
                            formatMoneyPlain(d.paid),
                            formatMoneyPlain(d.outstanding)
                        ];
                    });

                    doc.autoTable({
                        startY: y,
                        head: loanHeaders,
                        body: loanRows,
                        theme: 'striped',
                        headStyles: { fillColor: [220, 38, 38] } // Red
                    });
                }

                doc.save(`Flow_Banking_${new Date().toISOString().split('T')[0]}.pdf`);
            }

            function exportAccountsCSV() {
                const accounts = store.accounts.map(acc => {
                    const balance = getAccountBalance(acc.id);
                    return {
                        Name: acc.name,
                        Type: acc.type,
                        'Opening Balance': acc.openingBalance || 0,
                        'Current Balance': balance,
                        ...(acc.type === 'credit_card' ? {
                            Limit: acc.limit || 0,
                            'Billing Day': acc.billingDay || 0,
                            'Grace Period': acc.gracePeriod || 0
                        } : {})
                    };
                });

                const csv = Papa.unparse(accounts);
                const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `accounts_${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
            }

            function exportAccountsPDF() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                // --- Branding ---
                doc.setFont("helvetica", "bold");
                doc.setFontSize(22);
                doc.setTextColor(30, 64, 175);
                doc.text("Flow Accounting", 14, 20);

                doc.setFontSize(14);
                doc.setTextColor(107, 114, 128);
                doc.text("Account Summary Statement", 14, 28);

                doc.setDrawColor(229, 231, 235);
                doc.line(14, 32, 196, 32);

                doc.setFontSize(10);
                doc.setTextColor(55, 65, 81);
                doc.text(`Generated On: ${new Date().toLocaleString()}`, 14, 38);

                // --- Calculate Totals ---
                let totalAsset = 0;
                let totalLiability = 0;

                const tableData = store.accounts.map(acc => {
                    const balance = getAccountBalance(acc.id);
                    // Add to totals
                    if (acc.type === 'liability' || acc.type === 'credit_card' || acc.type === 'payable' || (acc.type === 'general' && balance < 0)) {
                        totalLiability += Math.abs(balance);
                    } else {
                        totalAsset += balance;
                    }

                    return [
                        acc.name,
                        acc.type.replace('_', ' ').toUpperCase(),
                        formatMoneyPlain(acc.openingBalance || 0),
                        formatMoneyPlain(balance)
                    ];
                });

                // Summary Box
                const netWorth = totalAsset - totalLiability;
                const summaryX = 14;
                doc.setFillColor(243, 244, 246);
                doc.roundedRect(summaryX, 42, 182, 18, 2, 2, 'F');

                doc.setFontSize(10);
                doc.setTextColor(22, 163, 74);
                doc.text(`Total Assets: ${formatMoneyPlain(totalAsset)}`, summaryX + 6, 54);

                doc.setTextColor(220, 38, 38);
                doc.text(`Total Liabilities: ${formatMoneyPlain(totalLiability)}`, summaryX + 70, 54);

                doc.setTextColor(30, 64, 175);
                doc.setFont("helvetica", "bold");
                doc.text(`Net Worth: ${formatMoneyPlain(netWorth)}`, summaryX + 130, 54);


                doc.autoTable({
                    head: [['Account Name', 'Type', 'Opening Balance', 'Current Balance']],
                    body: tableData,
                    startY: 70,
                    theme: 'grid',
                    styles: {
                        fontSize: 10,
                        cellPadding: 4,
                        font: 'helvetica'
                    },
                    headStyles: {
                        fillColor: [30, 64, 175],
                        textColor: 255,
                        fontStyle: 'bold'
                    },
                    columnStyles: {
                        2: { halign: 'right' },
                        3: { halign: 'right', fontStyle: 'bold' }
                    },
                    alternateRowStyles: {
                        fillColor: [249, 250, 251]
                    }
                });

                // Footer
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setTextColor(156, 163, 175);
                    doc.text(`Page ${i} of ${pageCount}`, 105, 290, { align: 'center' });
                }

                doc.save(`Flow_Accounts_${new Date().toISOString().split('T')[0]}.pdf`);
            }

            // --- NOTIFICATIONS & BUDGET CHECKS ---
            function showToast(message, type = 'info') {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                toast.className = `toast ${type} `;

                let icon = 'fa-circle-info text-blue-500';
                if (type === 'warning') icon = 'fa-triangle-exclamation text-amber-500';
                if (type === 'error') icon = 'fa-circle-xmark text-red-500';
                if (type === 'success') icon = 'fa-circle-check text-green-500';

                toast.innerHTML = `
                <div class="flex items-center gap-3 w-full">
                    <i class="fa-solid ${icon} text-lg"></i>
                    <div class="flex-1 font-medium text-sm text-gray-700 dark:text-gray-200">${message}</div>
                    <button onclick="this.closest('.toast').remove()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition"><i class="fa-solid fa-xmark"></i></button>
                </div>
            `;

                container.appendChild(toast);

                // Auto remove after 5s
                setTimeout(() => {
                    toast.style.animation = 'fadeOut 0.3s ease-in forwards';
                    setTimeout(() => toast.remove(), 300);
                }, 5000);
            }

            function checkBudgetLimits() {
                const currentMonth = new Date().getMonth();
                const currentYear = new Date().getFullYear();

                // Optimization: Pre-calculate totals map (O(N))
                const catTotals = {};
                let totalExpense = 0;

                store.transactions.forEach(t => {
                    const d = new Date(t.date);
                    if (d.getMonth() === currentMonth && d.getFullYear() === currentYear && t.type === 'expense') {
                        const amt = parseFloat(t.amount);
                        totalExpense += amt;
                        if (t.category) {
                            catTotals[t.category] = (catTotals[t.category] || 0) + amt;
                        }
                    }
                });

                store.budgets.forEach(b => {
                    if (b.type !== 'expense') return; // Only check expenses

                    let actual = 0;
                    if (b.category) {
                        actual = catTotals[b.category] || 0;
                    } else {
                        // General Expense Budget
                        actual = totalExpense;
                    }

                    const pct = (actual / b.amount) * 100;
                    // Check if we should notify (limit check)
                    // We'll use a session flag to avoid spamming every refresh?
                    // For now, simpler: just show if > 90%
                    if (pct >= 90 && pct < 100) {
                        // Unique ID for this warning to prevent spamming in same session?
                        // We can just rely on user traversing tabs.
                        showToast(`Warning: '${b.name}' budget is at ${pct.toFixed(0)}% of limit!`, 'warning');
                    } else if (pct >= 100) {
                        showToast(`Alert: '${b.name}' budget exceeded!`, 'error');
                    }
                });
            }


            // --- QUARTERLY INTEREST AUTO-DEPOSIT FOR FDs & RDs ---
            function processQuarterlyInterest() {
                const today = new Date();

                const processCollection = (items, type) => {
                    if (!items || items.length === 0) return;

                    items.forEach(item => {
                        if (!item.interestPayments) item.interestPayments = [];

                        const startDate = new Date(item.startDate);
                        let maturityDate;
                        if (item.maturityDate) {
                            maturityDate = new Date(item.maturityDate);
                        } else if (item.tenure) {
                            maturityDate = new Date(startDate);
                            maturityDate.setMonth(startDate.getMonth() + parseInt(item.tenure));
                        } else {
                            maturityDate = new Date(startDate);
                            maturityDate.setFullYear(startDate.getFullYear() + 100); // Far future
                        }

                        if (today < startDate) return;

                        // Identify the quarters we need to process
                        let checkDate = new Date(startDate);
                        let quarterCount = 1;

                        // Pre-fetch transactions for this item for performance
                        const relevantTxs = store.transactions.filter(t =>
                            t.accountId === item.id || t.toAccountId === item.id
                        );

                        while (true) {
                            // Determine Quarter End
                            let quarterEnd = new Date(startDate);
                            quarterEnd.setMonth(startDate.getMonth() + (quarterCount * 3));
                            // Ensure quarterEnd is end-of-day for comparison? No, date matches are 'YYYY-MM-DD'
                            // Use pure dates.

                            // Stop if this full quarter hasn't ended yet
                            if (quarterEnd > today || quarterEnd > maturityDate) break;

                            const quarterKey = `Q${quarterCount} - ${quarterEnd.getFullYear()}-${(quarterEnd.getMonth() + 1).toString().padStart(2, '0')}`;

                            // If not already processed
                            if (!item.interestPayments.includes(quarterKey)) {

                                // Calculate exact daily interest for this period
                                // Period Start: StartDate if Q1, else Previous Quarter End
                                let periodStart = new Date(startDate);
                                periodStart.setMonth(startDate.getMonth() + ((quarterCount - 1) * 3));

                                let accumulatedInterest = 0;
                                let currentDate = new Date(periodStart);
                                // Start from Day 1 of the period
                                currentDate.setDate(currentDate.getDate() + 1);

                                // Find initial balance at periodStart
                                let currentBalance = 0;
                                relevantTxs.forEach(t => {
                                    if (new Date(t.date) <= periodStart) {
                                        if (t.accountId === item.id) {
                                            if (t.type === 'income') currentBalance += t.amount;
                                            else currentBalance -= t.amount;
                                        }
                                        if (t.toAccountId === item.id) currentBalance += t.amount;
                                    }
                                });

                                // Iterate daily
                                while (currentDate <= quarterEnd) {
                                    const dayStr = currentDate.toISOString().split('T')[0];

                                    // Update balance with transactions on this day
                                    relevantTxs.forEach(t => {
                                        if (t.date === dayStr) {
                                            if (t.accountId === item.id) {
                                                if (t.type === 'income') currentBalance += t.amount;
                                                else currentBalance -= t.amount;
                                            }
                                            if (t.toAccountId === item.id) currentBalance += t.amount;
                                        }
                                    });

                                    // Accrue daily interest
                                    if (currentBalance > 0) {
                                        accumulatedInterest += currentBalance * (item.rate / 100) / 365.25;
                                    }
                                    currentDate.setDate(currentDate.getDate() + 1);
                                }

                                if (accumulatedInterest > 0) {
                                    // Credit on the last day of the quarter
                                    // (Same as Accrued Logic cutoff)

                                    const tx = {
                                        id: generateId('tx'),
                                        date: quarterEnd.toISOString().split('T')[0],
                                        type: 'income',
                                        amount: parseFloat(accumulatedInterest.toFixed(2)),
                                        category: null,
                                        categoryName: 'Interest Income',
                                        accountId: item.id,
                                        desc: `${type.toUpperCase()} Interest - ${item.name} (${quarterKey})`,
                                        isAutoInterest: true
                                    };

                                    store.transactions.push(tx);
                                    // Important: Add to relevantTxs locally so subsequent quarters see this interest!
                                    // Although next iteration re-filters? No, I defined relevantTxs outside.
                                    // I must push to relevantTxs to ensure Compounding happens in the next loop iteration.
                                    relevantTxs.push(tx);

                                    item.interestPayments.push(quarterKey);
                                }
                            }
                            quarterCount++;
                        }
                    });
                };

                processCollection(store.investments, 'FD');
                processCollection(store.rds, 'RD');
                save();
            }

            // --- RECURRING TRANSACTIONS LOGIC ---
            function calculateNextDueDate(dateStr, frequency) {
                const date = new Date(dateStr);
                if (frequency === 'daily') date.setDate(date.getDate() + 1);
                if (frequency === 'weekly') date.setDate(date.getDate() + 7);
                if (frequency === 'monthly') date.setMonth(date.getMonth() + 1);
                if (frequency === 'yearly') date.setFullYear(date.getFullYear() + 1);

                // Format YYYY-MM-DD
                return date.toISOString().split('T')[0];
            }

            function checkRecurringTransactions() {
                if (!store.transactions) return;

                let changes = false;
                const todayStr = new Date().toISOString().split('T')[0];
                const today = new Date(todayStr); // normalized

                store.transactions.forEach(tx => {
                    if (tx.recurring && tx.nextDueDate && !tx.paused) {
                        let due = new Date(tx.nextDueDate);

                        // If due date is today or passed
                        if (due <= today) {
                            // Trigger Recurrence
                            const newId = Date.now() + Math.random();
                            const newTx = { ...tx };
                            newTx.id = newId;
                            newTx.date = tx.nextDueDate; // Date is when it was due
                            newTx.recurring = false;
                            newTx.desc = tx.desc + ' (Recurring)';
                            delete newTx.frequency;
                            delete newTx.nextDueDate;

                            store.transactions.push(newTx);

                            // Update Parent
                            tx.nextDueDate = calculateNextDueDate(tx.nextDueDate, tx.frequency);
                            changes = true;
                        }
                    }
                });

                if (changes) {
                    save();
                    showToast('Recurring transactions processed.', 'success');
                }
            }

            function toggleRecurringPause(txId) {
                const tx = store.transactions.find(t => t.id == txId || t.id === txId);
                if (tx && tx.recurring) {
                    tx.paused = !tx.paused;
                    save();
                    router('settings');
                    showToast(tx.paused ? 'Transaction paused.' : 'Transaction resumed.', 'info');
                }
            }

            // --- APP DATA & THEME ---

            function resetApp() {
                if (confirm('CRITICAL WARNING: This will WIPE ALL DATA regarding transactions, accounts, and settings. This cannot be undone. Are you absolutely sure?')) {
                    localStorage.removeItem(APP_ID);
                    location.reload();
                }
            }

            // --- THEME SYSTEM ---
            const THEMES = {
                'light': { name: 'Default', icon: '', colors: '#3b82f6' },
                'dark': { name: 'Dark', icon: '', colors: '#1e293b' },
                'cute': { name: 'Pink', icon: '', colors: '#db2777' },
                'seablue': { name: 'Sea Blue', icon: '', colors: '#0077be' },
                'pastel': { name: 'Pastel', icon: '', colors: 'linear-gradient(135deg, #e0c3fc, #8ec5fc)' }
            };

            function setTheme(themeName) {
                if (!THEMES[themeName]) themeName = 'light';
                store.settings.theme = themeName;
                applyTheme(themeName);
                save();
            }

            function cycleTheme() {
                const keys = Object.keys(THEMES);
                let current = store.settings.theme || 'light';
                let idx = keys.indexOf(current);
                if (idx === -1) idx = 0;
                const next = keys[(idx + 1) % keys.length];
                setTheme(next);
            }

            function toggleAutoDarkMode(enabled) {
                store.settings.autoDarkMode = enabled;
                save();
                if (enabled) {
                    checkAutoDarkMode();
                    showToast('Auto Dark Mode enabled. Theme will switch based on time of day.', 'info');
                } else {
                    showToast('Auto Dark Mode disabled.', 'info');
                }
            }

            function checkAutoDarkMode() {
                if (!store.settings.autoDarkMode) return;

                const hour = new Date().getHours();
                const isNightTime = hour >= 18 || hour < 6; // 6 PM to 6 AM

                if (isNightTime && store.settings.theme !== 'dark') {
                    store.settings.theme = 'dark';
                    applyTheme('dark');
                    save();
                } else if (!isNightTime && store.settings.theme === 'dark') {
                    store.settings.theme = 'light';
                    applyTheme('light');
                    save();
                }
            }

            function applyTheme(themeName) {
                if (!themeName) themeName = store.settings.theme || 'light';

                const html = document.documentElement;
                const badge = document.getElementById('themeBadge');

                // Remove all theme attributes and dark class
                html.removeAttribute('data-theme');
                html.classList.remove('dark');

                // Apply new theme
                if (themeName === 'dark' || themeName === 'seablue') {
                    html.classList.add('dark');
                }
                if (themeName !== 'light') {
                    html.setAttribute('data-theme', themeName);
                }

                // Update badge
                if (badge && THEMES[themeName]) {
                    badge.innerText = THEMES[themeName].name;
                }

                // Update Chart.js colors based on theme
                if (typeof Chart !== 'undefined') {
                    if (themeName === 'dark' || themeName === 'seablue') {
                        Chart.defaults.color = '#94a3b8';
                        Chart.defaults.borderColor = '#334155';
                    } else {
                        Chart.defaults.color = '#64748b';
                        Chart.defaults.borderColor = '#e2e8f0';
                    }
                }

                // Re-render charts if on dashboard
                if (document.getElementById('dashboardView')) {
                    setTimeout(() => router('dashboard'), 50);
                }
            }



            // --- EXPORT & UTILS ---

            function navigateTabs(dir) {
                const ROUTE_ORDER = ['dashboard', 'accounts', 'transactions', 'reports', 'settings'];
                const activeBtn = document.querySelector('.sidebar-item.active');
                if (!activeBtn) return;

                // Extract route name
                const currentOnClick = activeBtn.getAttribute('onclick');
                const currentRoute = currentOnClick.match(/'([^']+)'/)[1];

                let idx = ROUTE_ORDER.indexOf(currentRoute);
                if (idx === -1) return;

                let newIdx = idx + dir;
                if (newIdx < 0) newIdx = ROUTE_ORDER.length - 1;
                if (newIdx >= ROUTE_ORDER.length) newIdx = 0;

                router(ROUTE_ORDER[newIdx]);
            }

            function openExportModal() {
                const now = new Date();
                // Check if currentTxMonth is different from current real month
                const isSameMonth = currentTxMonth.getMonth() === now.getMonth() && currentTxMonth.getFullYear() === now.getFullYear();

                // Detect Context
                const isAccountView = window.activeRoute === 'account_detail' && window.currentAccountId;
                const title = document.querySelector('#exportModal h2');
                if (title) {
                    if (isAccountView) {
                        const acc = store.accounts.find(a => a.id === window.currentAccountId) || { name: 'Account' };
                        title.textContent = `Export: ${acc.name}`;
                    } else {
                        title.textContent = 'Export Data';
                    }
                }

                if (!isSameMonth) {
                    document.getElementById('exportDuration').value = 'custom';

                    // Set Custom Dates to match currentTxMonth
                    const start = new Date(currentTxMonth.getFullYear(), currentTxMonth.getMonth(), 1);
                    const end = new Date(currentTxMonth.getFullYear(), currentTxMonth.getMonth() + 1, 0);

                    const formatDateInput = (d) => {
                        const offset = d.getTimezoneOffset() * 60000;
                        return new Date(d.getTime() - offset).toISOString().split('T')[0];
                    };

                    document.getElementById('exportStartDate').value = formatDateInput(start);
                    document.getElementById('exportEndDate').value = formatDateInput(end);
                } else {
                    document.getElementById('exportDuration').value = 'current_month';
                }

                toggleExportDates();
                openModal('exportModal');
            }

            function toggleExportDates() {
                const val = document.getElementById('exportDuration').value;
                if (val === 'custom') document.getElementById('exportCustomDates').classList.remove('hidden');
                else document.getElementById('exportCustomDates').classList.add('hidden');
            }

            function getExportData() {
                const duration = document.getElementById('exportDuration').value;
                let start = new Date(0);
                let end = new Date(9999, 11, 31);
                const now = new Date();

                if (duration === 'current_month') {
                    start = new Date(now.getFullYear(), now.getMonth(), 1);
                    end = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                } else if (duration === 'last_3_months') {
                    start = new Date(now.getFullYear(), now.getMonth() - 2, 1);
                    end = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                } else if (duration === 'last_6_months') {
                    start = new Date(now.getFullYear(), now.getMonth() - 5, 1);
                    end = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                } else if (duration === 'current_year') {
                    start = new Date(now.getFullYear(), 0, 1);
                    end = new Date(now.getFullYear(), 11, 31);
                } else if (duration === 'custom') {
                    if (document.getElementById('exportStartDate').value) start = new Date(document.getElementById('exportStartDate').value);
                    if (document.getElementById('exportEndDate').value) end = new Date(document.getElementById('exportEndDate').value);
                }

                let data = store.transactions.filter(t => {
                    const d = new Date(t.date);
                    return d >= start && d <= end;
                });

                // Context Filter for Account View
                if (window.activeRoute === 'account_detail' && window.currentAccountId) {
                    const accId = window.currentAccountId;
                    // Check if it's a virtual account (FD/Loan) found in investments/loans arrays
                    let acc = store.accounts.find(a => a.id === accId);
                    if (!acc) {
                        const inv = (store.investments || []).find(i => i.id === accId);
                        if (inv) acc = { ...inv, isVirtual: true };
                        else {
                            const loan = (store.loans || []).find(l => l.id === accId);
                            if (loan) acc = { ...loan, isVirtual: true };
                        }
                    }

                    if (acc) {
                        data = data.filter(t => {
                            if (acc.isVirtual) {
                                return t.desc && t.desc.toLowerCase().includes((acc.name || '').toLowerCase());
                            } else {
                                if (t.accountId === accId) return true;
                                if (t.type === 'transfer' && t.toAccountId === accId) return true;
                                return false;
                            }
                        });
                    }
                }

                return data.sort((a, b) => new Date(b.date) - new Date(a.date));
            }

            function handleExport(format) {
                const data = getExportData();
                if (data.length === 0) { alert('No data in selected range'); return; }

                if (format === 'csv') exportCSV(data);
                if (format === 'pdf') downloadPDF(data);
                closeModal('exportModal');
            }

            function exportCSV(data = null) {
                const txs = data || store.transactions;
                if (!txs.length) return alert("No data to export.");

                // Prepare data for PapaParse
                const csvData = txs.map(t => {
                    const acc = store.accounts.find(a => a.id === t.accountId);
                    return {
                        Date: t.date,
                        Description: t.desc,
                        Type: t.type,
                        Category: t.categoryName || '',
                        Account: acc ? acc.name : 'Unknown',
                        Amount: t.amount,
                        ToAccount: t.toAccountId ? (store.accounts.find(a => a.id === t.toAccountId)?.name || '') : ''
                    };
                });

                const csv = Papa.unparse(csvData);
                const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `flow_export_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            }

            function exportSQL() {
                let sql = `-- Flow Accounting SQL Dump\n-- Generated: ${new Date().toISOString()}\n\n`;

                // Helper to escape strings
                const esc = (text) => text ? `'${text.toString().replace(/'/g, "''")}'` : 'NULL';

                // 1. Accounts
                sql += `CREATE TABLE IF NOT EXISTS accounts (id TEXT PRIMARY KEY, name TEXT, type TEXT, openingBalance REAL, currentBalance REAL, notes TEXT);\n`;
                store.accounts.forEach(a => {
                    const balance = getAccountBalance(a.id);
                    sql += `INSERT INTO accounts (id, name, type, openingBalance, currentBalance, notes) VALUES (${esc(a.id)}, ${esc(a.name)}, ${esc(a.type)}, ${a.openingBalance || 0}, ${balance}, ${esc(a.notes)});\n`;
                });
                sql += `\n`;

                // 2. Categories
                sql += `CREATE TABLE IF NOT EXISTS categories (id TEXT PRIMARY KEY, name TEXT, type TEXT);\n`;
                store.categories.forEach(c => {
                    sql += `INSERT INTO categories (id, name, type) VALUES (${esc(c.id)}, ${esc(c.name)}, ${esc(c.type)});\n`;
                });
                sql += `\n`;

                // 3. Transactions
                sql += `CREATE TABLE IF NOT EXISTS transactions (id TEXT PRIMARY KEY, date TEXT, description TEXT, type TEXT, amount REAL, category_id TEXT, account_id TEXT, to_account_id TEXT);\n`;
                store.transactions.forEach(t => {
                    sql += `INSERT INTO transactions (id, date, description, type, amount, category_id, account_id, to_account_id) VALUES (${esc(t.id)}, ${esc(t.date)}, ${esc(t.desc)}, ${esc(t.type)}, ${t.amount}, ${esc(t.category)}, ${esc(t.accountId)}, ${esc(t.toAccountId)});\n`;
                });
                sql += `\n`;

                // 4. Budgets
                sql += `CREATE TABLE IF NOT EXISTS budgets (id TEXT PRIMARY KEY, name TEXT, type TEXT, amount REAL, category_id TEXT);\n`;
                store.budgets.forEach(b => {
                    sql += `INSERT INTO budgets (id, name, type, amount, category_id) VALUES (${esc(b.id)}, ${esc(b.name)}, ${esc(b.type)}, ${b.amount}, ${esc(b.category)});\n`;
                });
                sql += `\n`;

                // 5. Investments (FDs)
                if (store.investments) {
                    sql += `CREATE TABLE IF NOT EXISTS investments (id TEXT PRIMARY KEY, name TEXT, amount REAL, rate REAL, startDate TEXT, maturityDate TEXT, type TEXT, account_id TEXT);\n`;
                    store.investments.forEach(i => {
                        sql += `INSERT INTO investments (id, name, amount, rate, startDate, maturityDate, type, account_id) VALUES (${esc(i.id)}, ${esc(i.name)}, ${i.amount}, ${i.rate}, ${esc(i.startDate)}, ${esc(i.maturityDate)}, ${esc(i.type)}, ${esc(i.accountId)});\n`;
                    });
                    sql += `\n`;
                }

                // 6. Loans
                if (store.loans) {
                    sql += `CREATE TABLE IF NOT EXISTS loans (id TEXT PRIMARY KEY, name TEXT, amount REAL, rate REAL, startDate TEXT, type TEXT, emi REAL);\n`;
                    store.loans.forEach(l => {
                        sql += `INSERT INTO loans (id, name, amount, rate, startDate, type, emi) VALUES (${esc(l.id)}, ${esc(l.name)}, ${l.amount}, ${l.rate}, ${esc(l.startDate)}, ${esc(l.type)}, ${l.emi || 0});\n`;
                    });
                    sql += `\n`;
                }

                const blob = new Blob([sql], { type: "application/sql" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `flow_backup_${new Date().toISOString().split('T')[0]}.sql`;
                document.body.appendChild(a); // Required for Firefox/some browsers
                a.click();
                document.body.removeChild(a);
            }

            function importSQL(input) {
                const file = input.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = e => {
                    const content = e.target.result;

                    if (confirm("WARNING: Importing SQL will replace all current data. Continue?")) {
                        try {
                            const newStore = {
                                accounts: [],
                                categories: [],
                                transactions: [],
                                budgets: [],
                                investments: [],
                                loans: [],
                                settings: store.settings // Preserve settings
                            };

                            const lines = content.split('\n');

                            // Regex to parse INSERT statements
                            // Matches: INSERT INTO table (cols...) VALUES (vals...);
                            const insertRegex = /INSERT INTO\s+(\w+)\s*\(([^)]+)\)\s*VALUES\s*\((.+)\);/i;
                            // Regex to parse values, handling quoted strings containing commas
                            // This is a simplified parser; for production SQL it might need a real tokenizer.
                            // But for our export format ('' escaping), it should work with standard CSV-like parsing logic if we strip outer parens.

                            lines.forEach(line => {
                                const match = line.match(insertRegex);
                                if (match) {
                                    const tableName = match[1].toLowerCase();
                                    // const columns = match[2].split(',').map(s => s.trim()); 
                                    const valuesStr = match[3];

                                    // Parse values respecting quotes
                                    // Strategy: Split by comma ONLY if not inside single quotes
                                    const values = [];
                                    let current = '';
                                    let inQuote = false;

                                    for (let i = 0; i < valuesStr.length; i++) {
                                        const char = valuesStr[i];
                                        if (char === "'" && valuesStr[i + 1] === "'") { // Escaped quote
                                            current += "'";
                                            i++;
                                        } else if (char === "'") {
                                            inQuote = !inQuote;
                                        } else if (char === ',' && !inQuote) {
                                            values.push(current.trim());
                                            current = '';
                                        } else {
                                            current += char;
                                        }
                                    }
                                    values.push(current.trim());

                                    // Clean up values (remove nulls, parse numbers)
                                    const cleanValues = values.map(v => {
                                        if (v === 'NULL') return null;
                                        if (!isNaN(v) && v !== '') return parseFloat(v); // Number
                                        return v; // String (already unescaped by our logic above? no, we stripped outer quotes? wait)
                                    });

                                    // Map based on fixed schema knowledge (simpler than dynamic column mapping for this specific tool)
                                    // We know the export order.

                                    if (tableName === 'accounts') {
                                        // id, name, type, openingBalance, currentBalance, notes
                                        newStore.accounts.push({
                                            id: cleanValues[0],
                                            name: cleanValues[1],
                                            type: cleanValues[2],
                                            openingBalance: cleanValues[3],
                                            // currentBalance (calc) - ignore
                                            notes: cleanValues[5] // Notes is 6th
                                        });
                                    } else if (tableName === 'categories') {
                                        newStore.categories.push({
                                            id: cleanValues[0],
                                            name: cleanValues[1],
                                            type: cleanValues[2]
                                        });
                                    } else if (tableName === 'transactions') {
                                        // id, date, description, type, amount, category_id, account_id, to_account_id
                                        newStore.transactions.push({
                                            id: cleanValues[0],
                                            date: cleanValues[1],
                                            desc: cleanValues[2],
                                            type: cleanValues[3],
                                            amount: cleanValues[4],
                                            category: cleanValues[5],
                                            accountId: cleanValues[6],
                                            toAccountId: cleanValues[7]
                                        });
                                    } else if (tableName === 'budgets') {
                                        newStore.budgets.push({
                                            id: cleanValues[0],
                                            name: cleanValues[1],
                                            type: cleanValues[2],
                                            amount: cleanValues[3],
                                            category: cleanValues[4]
                                        });
                                    } else if (tableName === 'investments') {
                                        // id, name, amount, rate, startDate, maturityDate, type, account_id
                                        newStore.investments.push({
                                            id: cleanValues[0],
                                            name: cleanValues[1],
                                            amount: cleanValues[2],
                                            rate: cleanValues[3],
                                            startDate: cleanValues[4],
                                            maturityDate: cleanValues[5],
                                            type: cleanValues[6],
                                            accountId: cleanValues[7]
                                        });
                                    } else if (tableName === 'loans') {
                                        newStore.loans.push({
                                            id: cleanValues[0],
                                            name: cleanValues[1],
                                            amount: cleanValues[2],
                                            rate: cleanValues[3],
                                            startDate: cleanValues[4],
                                            type: cleanValues[5],
                                            emi: cleanValues[6]
                                        });
                                    }
                                }
                            });

                            store = newStore;
                            save(); // triggers reload or should we reload manually?
                            alert("SQL Import Successful! App will refresh.");
                            location.reload();

                        } catch (err) {
                            console.error(err);
                            alert("Failed to import SQL: " + err.message);
                        }
                    }
                    input.value = ''; // Reset
                };
                reader.readAsText(file);
            }

            function importCSV(input) {
                const file = input.files[0];
                if (!file) return;

                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    complete: function (results) {
                        if (!results.data || results.data.length === 0) {
                            alert('No data found in CSV file.');
                            return;
                        }

                        let imported = 0;
                        let skipped = 0;

                        results.data.forEach(row => {
                            // Fuzzy Helper
                            const getVal = (keys) => {
                                for (let k of keys) {
                                    if (row[k] !== undefined) return row[k];
                                    const rk = Object.keys(row).find(key => key.toLowerCase() === k.toLowerCase());
                                    if (rk) return row[rk];
                                }
                                return null;
                            };

                            // Expected columns mapping
                            const date = getVal(['Date', 'date', 'Timestamp', 'time']);
                            const desc = getVal(['Description', 'desc', 'Memo', 'Details', 'Narration']) || '';
                            const typeRaw = getVal(['Type', 'type', 'Kind', 'Flow']) || 'expense';
                            const type = typeRaw.toLowerCase();
                            const categoryName = getVal(['Category', 'cat', 'category']) || '';
                            const accountName = getVal(['Account', 'account', 'Wallet', 'Bank']) || '';
                            const amount = parseFloat(getVal(['Amount', 'amount', 'cost', 'value', 'price', 'Debit', 'Credit'])) || 0;
                            const toAccountName = getVal(['ToAccount', 'toAccount', 'Destination']) || '';

                            // Duplicate Check
                            const isDuplicate = store.transactions.some(t =>
                                t.date === date && t.amount === amount && t.desc === desc &&
                                store.accounts.find(a => a.id === t.accountId)?.name === accountName
                            );
                            if (isDuplicate) {
                                skipped++;
                                return;
                            }

                            // Skip invalid rows
                            if (!date || !amount || !accountName) {
                                skipped++;
                                return;
                            }

                            // Find or create account
                            let account = store.accounts.find(a => a.name.toLowerCase() === accountName.toLowerCase());
                            if (!account) {
                                // Create new account
                                account = {
                                    id: 'acc_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                                    name: accountName,
                                    type: 'asset',
                                    openingBalance: 0
                                };
                                store.accounts.push(account);
                            }

                            // Find or create category
                            let category = store.categories.find(c => c.name.toLowerCase() === categoryName.toLowerCase());
                            if (!category && categoryName && type !== 'transfer') {
                                category = {
                                    id: 'cat_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                                    name: categoryName,
                                    type: type === 'income' ? 'income' : 'expense'
                                };
                                store.categories.push(category);
                            }

                            // Find to account for transfers
                            let toAccountId = null;
                            if (type === 'transfer' && toAccountName) {
                                let toAccount = store.accounts.find(a => a.name.toLowerCase() === toAccountName.toLowerCase());
                                if (!toAccount) {
                                    toAccount = {
                                        id: 'acc_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                                        name: toAccountName,
                                        type: 'asset',
                                        openingBalance: 0
                                    };
                                    store.accounts.push(toAccount);
                                }
                                toAccountId = toAccount.id;
                            }

                            // Create transaction
                            const transaction = {
                                id: Date.now() + Math.floor(Math.random() * 10000),
                                date: date,
                                desc: desc,
                                type: type,
                                category: category ? category.id : null,
                                categoryName: category ? category.name : categoryName,
                                accountId: account.id,
                                amount: amount,
                                toAccountId: toAccountId
                            };

                            store.transactions.push(transaction);
                            imported++;
                        });

                        save();
                        alert(`Import Complete!\n\nImported: ${imported} transactions\nSkipped: ${skipped} rows`);

                        // Reset file input
                        input.value = '';

                        // Refresh view
                        router('transactions');
                    },
                    error: function (error) {
                        alert('Error parsing CSV: ' + error.message);
                    }
                });
            }


            function downloadPDF(data = null) {
                const txs = data || store.transactions;
                if (!txs.length) return alert("No data to export");

                txs.sort((a, b) => new Date(b.date) - new Date(a.date));

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                // Use Standard Helvetica
                doc.setFont("helvetica");

                // Determine Currency (Reverted to INR)
                const currencyCode = (store.settings && store.settings.currency === 'INR') ? 'INR' : '$';
                const fmt = (n) => parseFloat(n).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

                // --- PRE-CALCULATE BALANCES ---
                const balanceMap = new Map();
                let accountDetails = null;

                if (window.activeRoute === 'account_detail' && window.currentAccountId) {
                    const acc = store.accounts.find(a => a.id === window.currentAccountId);
                    if (acc) {
                        accountDetails = acc;
                        const allAccountTxs = store.transactions.filter(t =>
                            t.accountId === acc.id ||
                            (t.type === 'transfer' && t.toAccountId === acc.id)
                        );
                        allAccountTxs.sort((a, b) => new Date(a.date) - new Date(b.date));
                        let currentBal = acc.openingBalance || 0;
                        allAccountTxs.forEach(t => {
                            let amount = parseFloat(t.amount);
                            if (t.type === 'income') {
                                currentBal += amount;
                            } else if (t.type === 'expense') {
                                currentBal -= amount;
                            } else if (t.type === 'transfer') {
                                if (t.accountId === acc.id) currentBal -= amount;
                                if (t.toAccountId === acc.id) currentBal += amount;
                            }
                            balanceMap.set(t.id, currentBal);
                        });
                    }
                }

                // --- 1. TITLE & BRANDING ---
                doc.setFont("helvetica", "bold");
                doc.setFontSize(20);
                doc.setTextColor(30, 64, 175); // Blue-800
                doc.text("Flow Accounting", 14, 20);

                doc.setFontSize(12);
                doc.setTextColor(107, 114, 128); // Gray-500
                doc.text("Statement of Accounts", 14, 26);

                doc.setDrawColor(209, 213, 219); // Gray-300
                doc.line(14, 30, 196, 30);

                // --- 2. HEADER SECTION (2-Column Layout) ---
                let leftY = 40;
                let rightY = 40;

                // LEFT COLUMN: Account Details
                doc.setFontSize(11);
                doc.setTextColor(31, 41, 55); // Gray-800

                if (accountDetails) {
                    doc.setFont("helvetica", "bold");
                    doc.text("Account Details", 14, leftY);
                    leftY += 6;

                    doc.setFontSize(10);
                    doc.setFont("helvetica", "normal");
                    doc.setTextColor(55, 65, 81);

                    doc.text(`Name: ${accountDetails.name}`, 14, leftY);
                    leftY += 5;
                    doc.text(`Type: ${accountDetails.type.toUpperCase()}`, 14, leftY);
                    leftY += 5;

                    if (accountDetails.notes) {
                        const notes = `Notes: ${accountDetails.notes}`;
                        const splitNotes = doc.splitTextToSize(notes, 85); // Width limit for left col
                        doc.text(splitNotes, 14, leftY);
                        leftY += (splitNotes.length * 5);
                    }
                    leftY += 4; // Extra spacer
                }

                // Metadata (Below details on left)
                doc.setFontSize(10);

                // Date Range
                const dates = txs.map(t => new Date(t.date));
                const minDate = new Date(Math.min(...dates));
                const maxDate = new Date(Math.max(...dates));
                const formatDate = d => d.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });

                doc.setFont("helvetica", "bold");
                doc.text("Period:", 14, leftY);
                doc.setFont("helvetica", "normal");
                doc.text(`${formatDate(minDate)} - ${formatDate(maxDate)}`, 30, leftY);
                leftY += 5;

                doc.setFont("helvetica", "bold");
                doc.text("Generated:", 14, leftY);
                doc.setFont("helvetica", "normal");
                doc.text(new Date().toLocaleDateString() + ' ' + new Date().toLocaleTimeString(), 35, leftY);
                leftY += 5;

                doc.setFont("helvetica", "bold");
                doc.text("Total txs:", 14, leftY);
                doc.setFont("helvetica", "normal");
                doc.text(txs.length.toString(), 35, leftY);
                leftY += 8; // Spacer before table

                // RIGHT COLUMN: Financial Summary
                // Statistics
                const totalInc = txs.filter(t => t.type === 'income').reduce((sum, t) => sum + parseFloat(t.amount), 0);
                const totalExp = txs.filter(t => t.type === 'expense').reduce((sum, t) => sum + parseFloat(t.amount), 0);
                const netChange = totalInc - totalExp;

                // Opening/Closing Balance Logic
                let openingBal = 0;
                let closingBal = 0;
                if (accountDetails && balanceMap.size > 0 && txs.length > 0) {
                    const latestTx = txs[0];
                    if (balanceMap.has(latestTx.id)) {
                        closingBal = balanceMap.get(latestTx.id);
                        openingBal = closingBal - netChange;
                    }
                }

                const summaryX = 110;

                // Box Background
                doc.setFillColor(243, 244, 246);
                doc.roundedRect(summaryX, 35, 86, 44, 3, 3, 'F');

                rightY = 41;
                doc.setFontSize(10);
                doc.setFont("helvetica", "bold");
                doc.setTextColor(31, 41, 55);
                doc.text("Summary", summaryX + 5, rightY);
                rightY += 6;

                doc.setFontSize(9);
                doc.setFont("helvetica", "normal"); // Reset to normal for items

                // Open Bal
                if (accountDetails) {
                    doc.setTextColor(55, 65, 81);
                    doc.text("Opening Balance:", summaryX + 5, rightY);
                    doc.text(`${currencyCode} ${fmt(openingBal)}`, summaryX + 81, rightY, { align: 'right' });
                    rightY += 5;
                }

                doc.setFontSize(9);
                doc.setTextColor(22, 163, 74); // Green
                doc.text("Total Income:", summaryX + 5, rightY);
                doc.text(`+ ${currencyCode} ${fmt(totalInc)}`, summaryX + 81, rightY, { align: 'right' });
                rightY += 5;

                doc.setTextColor(220, 38, 38); // Red
                doc.text("Total Expense:", summaryX + 5, rightY);
                doc.text(`- ${currencyCode} ${fmt(totalExp)}`, summaryX + 81, rightY, { align: 'right' });
                rightY += 6;

                // Dividier inside box
                doc.setDrawColor(209, 213, 219);
                doc.line(summaryX + 5, rightY - 3, summaryX + 81, rightY - 3);

                doc.setTextColor(31, 41, 55);
                doc.setFont("helvetica", "bold");
                doc.text("Net Change:", summaryX + 5, rightY);
                doc.text(`${currencyCode} ${fmt(netChange)}`, summaryX + 81, rightY, { align: 'right' });

                // Close Bal
                if (accountDetails) {
                    rightY += 5;
                    doc.text("Closing Balance:", summaryX + 5, rightY);
                    doc.text(`${currencyCode} ${fmt(closingBal)}`, summaryX + 81, rightY, { align: 'right' });
                }


                // --- 3. TABLE ---
                // Header with Currency
                const tableColumn = [
                    "Date",
                    "Description",
                    "Category",
                    `Income (${currencyCode})`,
                    `Expense (${currencyCode})`,
                    `Balance (${currencyCode})`
                ];

                const tableRows = [];

                txs.forEach(t => {
                    const amt = parseFloat(t.amount);
                    const formattedAmt = amt.toLocaleString('en-US', { minimumFractionDigits: 2 });

                    let incomeStr = "";
                    let expenseStr = "";

                    if (t.type === 'income') {
                        incomeStr = formattedAmt;
                    } else if (t.type === 'expense') {
                        expenseStr = formattedAmt;
                    } else if (t.type === 'transfer') {
                        if (accountDetails) {
                            if (t.accountId === accountDetails.id) expenseStr = formattedAmt + " (Trf)";
                            if (t.toAccountId === accountDetails.id) incomeStr = formattedAmt + " (Trf)";
                        } else {
                            expenseStr = formattedAmt + " (Trf)";
                        }
                    }

                    let balStr = "-";
                    if (balanceMap.has(t.id)) {
                        balStr = balanceMap.get(t.id).toLocaleString('en-US', { minimumFractionDigits: 2 });
                    }

                    const dataRow = [
                        t.date,
                        t.desc,
                        t.categoryName || '-',
                        incomeStr,
                        expenseStr,
                        balStr
                    ];
                    tableRows.push(dataRow);
                });

                // Start table below the lowest column
                const tableStartY = Math.max(leftY, 70) + 5;

                doc.autoTable({
                    head: [tableColumn],
                    body: tableRows,
                    startY: tableStartY,
                    theme: 'grid',
                    styles: {
                        fontSize: 9,
                        cellPadding: 4, // More padding
                        font: 'helvetica',
                        textColor: [55, 65, 81]
                    },
                    headStyles: {
                        fillColor: [30, 64, 175],
                        textColor: 255,
                        fontStyle: 'bold',
                        halign: 'center'
                    },
                    columnStyles: {
                        0: { cellWidth: 24 }, // Date
                        1: { cellWidth: 'auto' }, // Desc
                        3: { cellWidth: 26, halign: 'right', textColor: [22, 163, 74] }, // Income
                        4: { cellWidth: 26, halign: 'right', textColor: [220, 38, 38] }, // Expense
                        5: { cellWidth: 30, halign: 'right', fontStyle: 'bold' }  // Balance
                    },
                    alternateRowStyles: {
                        fillColor: [249, 250, 251]
                    },
                    foot: [['', 'Total', '', `${currencyCode} ${fmt(totalInc)}`, `${currencyCode} ${fmt(totalExp)}`, '']],
                    footStyles: {
                        fillColor: [243, 244, 246],
                        textColor: [31, 41, 55],
                        fontStyle: 'bold',
                        halign: 'right'
                    }
                });

                // Page numbering
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setTextColor(156, 163, 175);
                    doc.text(`Page ${i} of ${pageCount}`, 105, 290, { align: 'center' });
                }

                const minDateStr = minDate.toISOString().split('T')[0];
                const maxDateStr = maxDate.toISOString().split('T')[0];
                const filename = `Statement_${accountDetails ? accountDetails.name.replace(/\s+/g, '_') : 'Export'}_${minDateStr}_to_${maxDateStr}.pdf`;

                doc.save(filename);
            }


            // Global listeners for modal fields
            document.querySelectorAll('#txModal input[name="txType"]').forEach(radio => {
                radio.addEventListener('change', updateCategoryDropdown);
            });

            // Item Focus State for keyboard navigation
            let focusedItemIndex = -1;
            let focusableItems = [];

            function updateFocusableItems() {
                // Use global activeRoute variable
                if (activeRoute === 'accounts') {
                    focusableItems = Array.from(document.querySelectorAll('.account-item, [data-account-id]'));
                } else if (activeRoute === 'transactions') {
                    focusableItems = Array.from(document.querySelectorAll('#txTableBody tr'));
                } else if (activeRoute === 'account_detail') {
                    focusableItems = Array.from(document.querySelectorAll('#accountTxTableBody tr'));
                } else {
                    focusableItems = [];
                }
                return focusableItems;
            }

            function highlightFocusedItem() {
                // Remove previous highlight
                document.querySelectorAll('.kb-focused').forEach(el => {
                    el.classList.remove('kb-focused');
                    // Inline styles are no longer used for focus, clean them
                    el.style.backgroundColor = '';
                    el.style.boxShadow = '';
                    el.style.transform = '';
                });

                if (focusedItemIndex >= 0 && focusedItemIndex < focusableItems.length) {
                    const item = focusableItems[focusedItemIndex];
                    item.classList.add('kb-focused');
                    item.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            }

            // Keyboard Shortcuts
            document.addEventListener('keydown', (e) => {
                const key = e.key.toLowerCase();
                const isInput = ['INPUT', 'TEXTAREA', 'SELECT'].includes(e.target.tagName);

                // Get current active route
                const activeRoute = window.activeRoute || document.querySelector('.sidebar-item.active')?.getAttribute('onclick')?.match(/'([^']+)'/)?.[1] || 'dashboard';

                // Escape - Close modals/panels, or go back if nothing to close
                if (key === 'escape') {
                    // Clear item focus first
                    focusedItemIndex = -1;
                    highlightFocusedItem();

                    const filterPanel = document.getElementById('filterPanel');
                    if (filterPanel && !filterPanel.classList.contains('hidden')) {
                        toggleFilterPanel();
                        return;
                    }
                    const modalIds = ['txModal', 'accountModal', 'categoryModal', 'exportModal', 'budgetModal', 'investmentModal', 'loanModal', 'withdrawFDModal', 'payLoanModal', 'confirmModal', 'unlockModal', 'accountExportModal', 'shortcutsModal'];
                    let modalClosed = false;
                    modalIds.forEach(id => {
                        const modal = document.getElementById(id);
                        if (modal && !modal.classList.contains('hidden')) {
                            closeModal(id);
                            modalClosed = true;
                        }
                    });
                    if (!modalClosed && routeHistory.length > 1) {
                        routeHistory.pop();
                        const previousRoute = routeHistory[routeHistory.length - 1];
                        router(previousRoute, { skipHistory: true });
                    }
                    return;
                }

                // Backspace - Go back to previous view
                if (e.key === 'Backspace' && !isInput) {
                    e.preventDefault();
                    if (routeHistory.length > 1) {
                        routeHistory.pop();
                        const previousRoute = routeHistory[routeHistory.length - 1];
                        router(previousRoute, { skipHistory: true });
                    }
                    return;
                }

                // Ctrl+Z - Undo
                if (e.ctrlKey && key === 'z' && !isInput) {
                    e.preventDefault();
                    undo();
                    return;
                }

                // Ctrl+Y or Ctrl+Shift+Z - Redo
                if ((e.ctrlKey && key === 'y') || (e.ctrlKey && e.shiftKey && key === 'z')) {
                    if (!isInput) {
                        e.preventDefault();
                        redo();
                        return;
                    }
                }

                // Shift+T - Toggle theme
                if (e.shiftKey && key === 't' && !isInput) {
                    e.preventDefault();
                    cycleTheme();
                    return;
                }

                // Shift+H - Toggle Privacy Mode
                if (e.shiftKey && key === 'h' && !isInput) {
                    e.preventDefault();
                    togglePrivacyMode();
                    return;
                }

                // Skip shortcuts when typing in inputs
                if (isInput) return;



                // Arrow Up/Down - Navigate items in accounts/transactions/account_detail, or scroll
                if (e.key === 'ArrowUp' || e.key === 'ArrowDown') {
                    if (activeRoute === 'accounts' || activeRoute === 'transactions' || activeRoute === 'account_detail') {
                        e.preventDefault();
                        updateFocusableItems();
                        if (focusableItems.length > 0) {
                            if (e.key === 'ArrowUp') {
                                focusedItemIndex = focusedItemIndex <= 0 ? focusableItems.length - 1 : focusedItemIndex - 1;
                            } else {
                                focusedItemIndex = focusedItemIndex >= focusableItems.length - 1 ? 0 : focusedItemIndex + 1;
                            }
                            highlightFocusedItem();
                        }
                    } else {
                        document.getElementById('app-content')?.scrollBy(0, e.key === 'ArrowUp' ? -100 : 100);
                    }
                    return;
                }

                // Enter - Select focused item
                if (e.key === 'Enter' && focusedItemIndex >= 0 && focusableItems.length > 0 && !isModalOpen()) {
                    e.preventDefault();
                    const item = focusableItems[focusedItemIndex];
                    if (activeRoute === 'accounts') {
                        // Open account detail
                        const accId = item.getAttribute('data-account-id') || item.getAttribute('onclick')?.match(/router\('account_detail',\s*'([^']+)'\)/)?.[1];
                        if (accId) router('account_detail', accId);
                    } else if (activeRoute === 'transactions' || activeRoute === 'account_detail') {
                        // Edit transaction
                        const editBtn = item.querySelector('.fa-pen-to-square')?.parentElement;
                        if (editBtn) editBtn.click();
                    }
                    return;
                }

                // Delete key - Delete focused transaction
                if (e.key === 'Delete' && focusedItemIndex >= 0 && focusableItems.length > 0 && (activeRoute === 'transactions' || activeRoute === 'account_detail')) {
                    e.preventDefault();
                    const item = focusableItems[focusedItemIndex];
                    const deleteBtn = item.querySelector('.fa-trash')?.parentElement;
                    if (deleteBtn) deleteBtn.click();
                    return;
                }

                const isLeft = e.key === 'ArrowLeft' || key === ',' || key === '<';
                const isRight = e.key === 'ArrowRight' || key === '.' || key === '>';

                // Arrow Left/Right and < > - Month navigation (Dashboard & Transactions)
                if (isLeft || isRight) {
                    // Modal Navigation (Arrow Keys)
                    if (isModalOpen()) {
                        const modals = document.querySelectorAll('.fixed:not(.hidden)');
                        const topModal = modals[modals.length - 1]; // Assuming last one is top
                        if (topModal) {
                            const buttons = Array.from(topModal.querySelectorAll('button, input, select, textarea, a[href]')).filter(el => !el.disabled && el.offsetParent !== null); // Visible & enabled
                            const currentFocusIndex = buttons.indexOf(document.activeElement);
                            let nextIndex = 0;

                            if (isRight) {
                                nextIndex = (currentFocusIndex + 1) % buttons.length;
                            } else {
                                nextIndex = (currentFocusIndex - 1 + buttons.length) % buttons.length;
                            }

                            if (buttons[nextIndex]) {
                                e.preventDefault();
                                buttons[nextIndex].focus();
                            }
                        }
                        return;
                    }

                    if (isLeft) {
                        if (activeRoute === 'dashboard') {
                            changeDashboardMonth(-1);
                        } else if (activeRoute === 'transactions') {
                            navigateTransactionMonth(-1);
                        } else if (activeRoute === 'account_detail') {
                            changeAccountHistoryMonth(-1);
                        }
                    } else if (isRight) {
                        if (activeRoute === 'dashboard') {
                            changeDashboardMonth(1);
                        } else if (activeRoute === 'transactions') {
                            navigateTransactionMonth(1);
                        } else if (activeRoute === 'account_detail') {
                            changeAccountHistoryMonth(1);
                        }
                    }
                }

                // Tab - Cycle through sidebar items
                if (e.key === 'Tab' && !e.shiftKey && !e.ctrlKey && !isModalOpen()) {
                    e.preventDefault();
                    focusedItemIndex = -1; // Reset item focus
                    const routes = ['dashboard', 'accounts', 'transactions', 'reports', 'settings'];
                    const currentIdx = routes.indexOf(activeRoute);
                    const nextIdx = (currentIdx + 1) % routes.length;
                    router(routes[nextIdx]);
                    return;
                }

                // Shift+Tab - Cycle backwards
                if (e.key === 'Tab' && e.shiftKey && !isModalOpen()) {
                    e.preventDefault();
                    focusedItemIndex = -1;
                    const routes = ['dashboard', 'accounts', 'transactions', 'reports', 'settings'];
                    const currentIdx = routes.indexOf(activeRoute);
                    const prevIdx = (currentIdx - 1 + routes.length) % routes.length;
                    router(routes[prevIdx]);
                    return;
                }

                // F - Focus search/filter
                if (key === 'f') {
                    e.preventDefault();

                    // Check for transaction search (in transactions view)
                    if (activeRoute === 'transactions') {
                        const txSearchContainer = document.getElementById('txSearchContainer');
                        const txSearch = document.getElementById('txSearch');

                        // If container exists and is hidden, show it first
                        if (txSearchContainer && txSearchContainer.classList.contains('hidden')) {
                            toggleTransactionSearch();
                        }

                        // Now focus
                        if (txSearch) txSearch.focus();
                        return;
                    }

                    // Check for account transaction search (in account detail view)
                    if (activeRoute === 'account_detail') {
                        const accountTxSearchContainer = document.getElementById('accountTxSearchContainer');
                        const accountTxSearch = document.getElementById('accountTxSearch');

                        // If container exists and is hidden, show it first
                        if (accountTxSearchContainer && accountTxSearchContainer.classList.contains('hidden')) {
                            toggleAccountTxSearch();
                        }

                        if (accountTxSearch) accountTxSearch.focus();
                        return;
                    }

                    // Check for account search (in accounts view)
                    const accountSearch = document.getElementById('accountSearchInput');
                    if (accountSearch && activeRoute === 'accounts') {
                        toggleAccountSearch();
                        setTimeout(() => accountSearch?.focus(), 100);
                        return;
                    }

                    return;
                }

                // ? or / - Show shortcuts help modal (key === '/' for non-shift users)
                if ((key === '?' || key === '/') && !isInput) {
                    e.preventDefault();
                    openModal('shortcutsModal');
                    return;
                }

                // Ignore if Ctrl / Alt / Meta key is pressed (to avoid conflicts with browser shortcuts like Ctrl+P, Ctrl+C)
                if (e.ctrlKey || e.altKey || e.metaKey) return;

                // Navigation shortcuts (single keys)
                if (key === 'd') { router('dashboard'); return; }
                if (key === 'a') { router('accounts'); return; }
                if (key === 't') { router('transactions'); return; }
                if (key === 'r') { router('reports'); return; }
                if (key === 's') { router('settings'); return; }

                // Q / N - Quick add transaction
                if ((key === 'q' || key === 'n') && !isInput) {
                    openTxModal();
                    return;
                }

                // I / + / = - Add Income
                if ((key === 'i' || key === '+' || key === '=') && !isInput) {
                    e.preventDefault();
                    openTxModal(null, 'income');
                    return;
                }

                // O / - - Add Expense
                if ((key === 'o' || key === '-') && !isInput) {
                    e.preventDefault();
                    openTxModal(null, 'expense');
                    return;
                }

                // \ (backslash) / P / * - Add Transfer
                if ((key === '\\' || key === 'p' || key === '*') && !isInput) {
                    e.preventDefault();
                    openTxModal(null, 'transfer');
                    return;
                }

                // M - Add New Account
                if (key === 'm' && !isInput) {
                    e.preventDefault();
                    openAccountModal();
                    return;
                }

                // K - Toggle Account Grouping (Grouped/Unified)
                if (key === 'k' && !isInput && activeRoute === 'accounts') {
                    e.preventDefault();
                    const current = localStorage.getItem('accountGrouping') || 'grouped';
                    toggleAccountGrouping(current === 'grouped' ? 'unified' : 'grouped');
                    return;
                }

                // L - Toggle Account View (List/Grid)
                if (key === 'l' && !isInput && activeRoute === 'accounts') {
                    e.preventDefault();
                    const current = localStorage.getItem('accountView') || 'grid';
                    setAccountView(current === 'grid' ? 'list' : 'grid');
                    return;
                }

                // ; - Toggle Account Sort (Amount/Name)
                if (key === ';' && !isInput && activeRoute === 'accounts') {
                    e.preventDefault();
                    toggleAccountSort();
                    return;
                }

                // Home - Go to dashboard
                if (e.key === 'Home') {
                    e.preventDefault();
                    router('dashboard');
                }

                // End - Go to settings
                if (e.key === 'End') {
                    e.preventDefault();
                    router('settings');
                }
            });

            // Account Transaction Filter
            window.filterAccountTransactions = function (query) {
                const lowerQuery = query.toLowerCase();
                const rows = document.querySelectorAll('#accountTxTableBody tr');

                rows.forEach(row => {
                    const text = row.innerText.toLowerCase();
                    if (text.includes(lowerQuery)) {
                        row.classList.remove('hidden');
                    } else {
                        row.classList.add('hidden');
                    }
                });
            };

            // Start
            window.onload = init;

            // --- RECOVERY MANAGEMENT ---

            // Load recovery state to see if it exists
            function getRecoveryState() {
                const raw = localStorage.getItem('flow_recovery_v1');
                return raw ? JSON.parse(raw) : null;
            }

            function openRecoverySetupModal() {
                if (!currentPassword) {
                    showToast('Please set a password first.', 'warning');
                    return;
                }
                document.getElementById('recoverySetupForm').reset();
                openModal('recoverySetupModal');
            }

            async function handleRecoverySetupSubmit(e) {
                e.preventDefault();
                // For simplified flow, we treat the 'Question' fields as the Keywords directly.
                // We are not storing separate answers now, just the keywords themselves act as the secret keys.
                // OR better: The user enters "Keyword 1" (e.g. Red) and "Keyword 2" (e.g. 1234).
                // We'll effectively use these inputs as the answers. Ideally we'd want a Label + Answer pair if we wan to show a hint,
                // but for simplicity requested, we can just treat the inputs provided as the secrets.
                // However, `reqQ1` and `reqQ2` ids are used.
                // In previous code `reqQ1` was select (question), `reqA1` was answer.
                // Now I have `reqQ1` as input (Keyword 1).

                const k1 = document.getElementById('reqQ1').value;
                const k2 = document.getElementById('reqQ2').value;
                const pwd = document.getElementById('reqCurrentPass').value;

                if (pwd !== currentPassword) {
                    showToast('Incorrect password.', 'error');
                    return;
                }

                // Backup
                const answers = [k1, k2];
                try {
                    const encryptedPwd = await EncryptionService.backupPassword(pwd, answers);

                    // We store "Security Keyword 1" and "Security Keyword 2" as the "questions" labels
                    // so the user knows what to enter during recovery.
                    const recoveryData = {
                        questions: ['Security Keyword 1', 'Security Keyword 2'],
                        data: encryptedPwd
                    };
                    localStorage.setItem('flow_recovery_v1', JSON.stringify(recoveryData));
                    showToast('Recovery keywords saved.', 'success');
                    closeModal('recoverySetupModal');
                    // Refresh settings UI
                    if (document.getElementById('recoveryStatus')) {
                        router('settings');
                    }
                } catch (err) {
                    console.error(err);
                    showToast('Failed to save recovery options.', 'error');
                }
            }

            function initiateRecovery() {
                const recoveryState = getRecoveryState();
                if (!recoveryState) {
                    showToast('No recovery options set.', 'error');
                    return;
                }

                // We display the generic labels "Security Keyword 1" etc. unless we stored specific hints.
                // Since we hardcoded the labels in setup, we can use them or just hardcode here.
                document.getElementById('labelQ1').innerText = recoveryState.questions[0] || 'Keyword 1';
                document.getElementById('labelQ2').innerText = recoveryState.questions[1] || 'Keyword 2';

                document.getElementById('recoveryActionForm').reset();
                document.getElementById('recoveryActionError').classList.add('hidden');

                openModal('recoveryActionModal');
            }

            async function handleRecoveryActionSubmit(e) {
                e.preventDefault();
                const a1 = document.getElementById('targetA1').value;
                const a2 = document.getElementById('targetA2').value;
                const errorMsg = document.getElementById('recoveryActionError');

                const recoveryState = getRecoveryState();
                const answers = [a1, a2];

                try {
                    const recoveredPwd = await EncryptionService.recoverPassword(recoveryState.data, answers);

                    // If successful, we have the password.
                    // Now try to unlock the main store with it to be doubly sure and actually unlock app.
                    const encryptedStore = localStorage.getItem('flow_encrypted_v1');
                    if (!encryptedStore) {
                        // Weird state, but okay
                        currentPassword = recoveredPwd;
                        isAppLocked = false;
                        document.getElementById('unlockModal').classList.add('hidden');
                        document.getElementById('appContainer').classList.remove('blur-sm', 'pointer-events-none');
                        closeModal('recoveryActionModal');
                        finishInit();
                        return;
                    }

                    // Attempt main decrypt
                    const json = await EncryptionService.decrypt(encryptedStore, recoveredPwd);
                    store = JSON.parse(json);

                    // Success!
                    currentPassword = recoveredPwd;
                    isAppLocked = false;
                    document.getElementById('unlockModal').classList.add('hidden');
                    document.getElementById('appContainer').classList.remove('blur-sm', 'pointer-events-none');
                    finishInit();

                    // Show success state with reset options instead of closing modal
                    document.getElementById('recoveryActionForm').classList.add('hidden');
                    document.getElementById('recoverySuccessState').classList.remove('hidden');
                    document.querySelector('#recoveryActionModal h2').textContent = 'Recovery Successful';

                } catch (err) {
                    console.error(err);
                    errorMsg.textContent = 'Incorrect answers or data corruption.';
                    errorMsg.classList.remove('hidden');
                }
            }

            // Helper to reset recovery modal to initial state
            function resetRecoveryModalState() {
                document.getElementById('recoveryActionForm').classList.remove('hidden');
                document.getElementById('recoverySuccessState').classList.add('hidden');
                document.querySelector('#recoveryActionModal h2').textContent = 'Recover Password';
                document.getElementById('recoveryActionForm').reset();
                document.getElementById('recoveryActionError').classList.add('hidden');
            }

            // Reset security keys after successful recovery
            function resetSecurityKeysAfterRecovery() {
                closeModal('recoveryActionModal');
                resetRecoveryModalState();
                // Open recovery setup modal to set new security keys
                openRecoverySetupModal();
                showToast('Please set new security keys.', 'info');
            }

            // Change password after successful recovery
            function changePasswordAfterRecovery() {
                closeModal('recoveryActionModal');
                resetRecoveryModalState();
                // Open password change modal in 'reset' mode (no current password required)
                openPasswordModal('reset');
                showToast('Please set a new password.', 'info');
            }

            // Continue without making changes
            function continueWithoutReset() {
                closeModal('recoveryActionModal');
                resetRecoveryModalState();
                showToast('Recovery Successful! You can update your security settings in Settings.', 'success');
            }

            function openPasswordModal(mode) {
                const modal = document.getElementById('passwordSetupModal');
                const form = document.getElementById('passwordSetupForm');
                const title = document.getElementById('passwordModalTitle');
                const oldPassField = document.getElementById('oldPasswordField');
                const errorMsg = document.getElementById('passwordSetupError');

                // Reset
                form.reset();
                errorMsg.classList.add('hidden');
                document.getElementById('passwordMode').value = mode;

                if (mode === 'set') {
                    title.textContent = 'Setup Password';
                    oldPassField.classList.add('hidden');
                    document.getElementById('oldPassword').required = false;
                } else if (mode === 'reset') {
                    // Reset mode - after recovery, no current password needed
                    title.textContent = 'Reset Password';
                    oldPassField.classList.add('hidden');
                    document.getElementById('oldPassword').required = false;
                } else if (mode === 'change') {
                    title.textContent = 'Change Password';
                    oldPassField.classList.remove('hidden');
                    document.getElementById('oldPassword').required = true;
                } else if (mode === 'remove') {
                    title.textContent = 'Remove Password';
                    oldPassField.classList.remove('hidden');
                    document.getElementById('oldPassword').required = true;
                }

                // Adjust UI for 'remove' mode
                if (mode === 'remove') {
                    document.getElementById('newPassword').parentElement.classList.add('hidden');
                    document.getElementById('newPassword').required = false;
                    document.getElementById('confirmPassword').parentElement.classList.add('hidden');
                    document.getElementById('confirmPassword').required = false;
                    const subBtn = form.querySelector('button[type="submit"]');
                    subBtn.textContent = 'Remove Password';
                    subBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                    subBtn.classList.add('bg-red-600', 'hover:bg-red-700');
                } else {
                    document.getElementById('newPassword').parentElement.classList.remove('hidden');
                    document.getElementById('newPassword').required = true;
                    document.getElementById('confirmPassword').parentElement.classList.remove('hidden');
                    document.getElementById('confirmPassword').required = true;
                    const subBtn = form.querySelector('button[type="submit"]');
                    subBtn.textContent = 'Save Password';
                    subBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
                    subBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                }

                openModal('passwordSetupModal');
            }

            window.toggleAccountTxSearch = function () {
                const container = document.getElementById('accountTxSearchContainer');
                const input = document.getElementById('accountTxSearch');
                if (container) {
                    container.classList.toggle('hidden');
                    if (!container.classList.contains('hidden')) {
                        input.focus();
                    }
                }
            };

            async function handlePasswordSetupSubmit(e) {
                e.preventDefault();
                const mode = document.getElementById('passwordMode').value;
                const oldPwd = document.getElementById('oldPassword').value;
                const newPwd = document.getElementById('newPassword').value;
                const confirmPwd = document.getElementById('confirmPassword').value;
                const errorMsg = document.getElementById('passwordSetupError');

                errorMsg.classList.add('hidden');

                // Verify Old Password first (if required)
                if (mode === 'change' || mode === 'remove') {
                    if (oldPwd !== currentPassword) {
                        errorMsg.textContent = 'Incorrect current password.';
                        errorMsg.classList.remove('hidden');
                        return;
                    }
                }

                // Verify New Password (if required)
                if (mode === 'set' || mode === 'change' || mode === 'reset') {
                    if (newPwd.length < 4) {
                        errorMsg.textContent = 'Password must be at least 4 characters.';
                        errorMsg.classList.remove('hidden');
                        return;
                    }
                    if (newPwd !== confirmPwd) {
                        errorMsg.textContent = 'Passwords do not match.';
                        errorMsg.classList.remove('hidden');
                        return;
                    }
                }

                // Execute Action
                try {
                    if (mode === 'remove') {
                        currentPassword = null;
                        // Save plain
                        localStorage.setItem(APP_ID, JSON.stringify(store));
                        localStorage.removeItem('flow_encrypted_v1');
                        showToast('Password removed successfully.', 'success');
                    } else {
                        // Set/Change
                        currentPassword = newPwd;
                        // Trigger save to re-encrypt
                        await save(true); // skip history push
                        showToast('Password set successfully.', 'success');
                    }

                    closeModal('passwordSetupModal');
                    // Re-render settings if active
                    const activeLink = document.querySelector('.sidebar-item.active');
                    if (activeLink && activeLink.getAttribute('onclick').includes('settings')) {
                        router('settings');
                    }
                } catch (err) {
                    console.error(err);
                    errorMsg.textContent = 'An error occurred. Please try again.';
                    errorMsg.classList.remove('hidden');
                }
            }

        </script>

        <!-- Account Export Modal -->
        <div id="accountExportModal" onclick="if(event.target === this) closeModal('accountExportModal')"
            class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-[60] backdrop-blur-sm opacity-0 transition-opacity duration-300">
            <div onclick="event.stopPropagation()"
                class="bg-white dark:bg-dark-surface rounded-3xl p-8 w-full max-w-md transform scale-95 transition-transform duration-300 shadow-2xl">

                <!-- Header -->
                <div class="flex justify-between items-start mb-6">
                    <div
                        class="w-14 h-14 bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400 rounded-2xl flex items-center justify-center text-2xl">
                        <i class="fa-solid fa-file-export"></i>
                    </div>
                    <button onclick="closeModal('accountExportModal')"
                        class="w-8 h-8 rounded-full hover:bg-gray-100 dark:hover:bg-dark-bg flex items-center justify-center text-gray-400 transition">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </div>

                <!-- Content -->
                <div class="mb-6">
                    <h2 class="text-xl font-bold text-gray-800 dark:text-gray-200 mb-2">Export Accounts</h2>
                    <p class="text-gray-500 dark:text-gray-400 text-sm">Choose your preferred export format</p>
                </div>

                <!-- Actions -->
                <div class="flex gap-3">
                    <button onclick="handleUniversalExport('csv')"
                        class="flex-1 px-6 py-4 bg-green-50 dark:bg-green-900/20 text-green-600 dark:text-green-400 rounded-xl font-bold hover:bg-green-100 dark:hover:bg-green-900/40 transition flex flex-col items-center gap-2">
                        <i class="fa-solid fa-file-csv text-2xl"></i>
                        <span>CSV / Excel</span>
                    </button>
                    <button onclick="handleUniversalExport('pdf')"
                        class="flex-1 px-6 py-4 bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 rounded-xl font-bold hover:bg-red-100 dark:hover:bg-red-900/40 transition flex flex-col items-center gap-2">
                        <i class="fa-solid fa-file-pdf text-2xl"></i>
                        <span>PDF</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Confirmation Modal -->
        <div id="confirmModal" onclick="if(event.target === this) closeModal('confirmModal')"
            class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-[60] backdrop-blur-sm opacity-0 transition-opacity duration-300">
            <div onclick="event.stopPropagation()"
                class="bg-white dark:bg-dark-surface rounded-3xl p-8 w-full max-w-md transform scale-95 transition-transform duration-300 shadow-2xl">

                <!-- Header with close button -->
                <div class="flex justify-between items-start mb-6">
                    <div
                        class="w-14 h-14 bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-500 rounded-2xl flex items-center justify-center text-2xl">
                        <i class="fa-solid fa-triangle-exclamation"></i>
                    </div>
                    <button onclick="closeModal('confirmModal')"
                        class="w-8 h-8 rounded-full hover:bg-gray-100 dark:hover:bg-dark-bg flex items-center justify-center text-gray-400 transition">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </div>

                <!-- Content -->
                <div class="mb-6">
                    <h2 class="text-xl font-bold text-gray-800 dark:text-gray-200 mb-3" id="confirmTitle">Are you sure?
                    </h2>
                    <p class="text-red-600 dark:text-red-500 font-medium text-sm leading-relaxed" id="confirmMessage">
                        This
                        action cannot be undone.</p>
                </div>

                <!-- Actions -->
                <div class="flex gap-3">
                    <button onclick="closeModal('confirmModal')"
                        class="flex-1 px-6 py-3 bg-gray-100 dark:bg-dark-bg text-gray-700 dark:text-gray-300 rounded-xl font-medium hover:bg-gray-200 dark:hover:bg-gray-700 transition">Cancel</button>
                    <button id="confirmYesBtn"
                        class="flex-1 px-6 py-3 bg-red-600 text-white rounded-xl font-bold hover:bg-red-700 shadow-lg shadow-red-200 dark:shadow-red-900/30 transition">Delete</button>
                </div>
            </div>
        </div>

        <!-- Shortcuts Help Modal -->
        <div id="shortcutsModal" onclick="if(event.target === this) closeModal('shortcutsModal')"
            class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-[60] backdrop-blur-sm opacity-0 transition-opacity duration-300">
            <div onclick="event.stopPropagation()"
                class="bg-white dark:bg-dark-surface rounded-3xl p-6 w-full max-w-2xl max-h-[80vh] overflow-y-auto transform scale-95 transition-transform duration-300 shadow-2xl">

                <!-- Header -->
                <div class="flex justify-between items-center mb-6">
                    <div class="flex items-center gap-3">
                        <div
                            class="w-12 h-12 bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400 rounded-2xl flex items-center justify-center text-xl">
                            <i class="fa-solid fa-keyboard"></i>
                        </div>
                        <h2 class="text-xl font-bold text-gray-800 dark:text-gray-200">Keyboard Shortcuts</h2>
                    </div>
                    <button onclick="closeModal('shortcutsModal')"
                        class="w-8 h-8 rounded-full hover:bg-gray-100 dark:hover:bg-dark-bg flex items-center justify-center text-gray-400 transition">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </div>

                <!-- Shortcuts Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-sm">

                    <!-- Navigation -->
                    <div class="space-y-3">
                        <h3 class="font-bold text-gray-700 dark:text-gray-300 flex items-center gap-2">
                            <i class="fa-solid fa-compass text-blue-500"></i> Navigation
                        </h3>
                        <div class="space-y-2">
                            <div class="flex justify-between"><span
                                    class="text-gray-600 dark:text-gray-400">Dashboard</span><kbd
                                    class="bg-gray-100 dark:bg-dark-bg px-2 py-1 rounded font-mono">D</kbd></div>
                            <div class="flex justify-between"><span
                                    class="text-gray-600 dark:text-gray-400">Accounts</span><kbd
                                    class="bg-gray-100 dark:bg-dark-bg px-2 py-1 rounded font-mono">A</kbd></div>
                            <div class="flex justify-between"><span
                                    class="text-gray-600 dark:text-gray-400">Transactions</span><kbd
                                    class="bg-gray-100 dark:bg-dark-bg px-2 py-1 rounded font-mono">T</kbd></div>
                            <div class="flex justify-between"><span
                                    class="text-gray-600 dark:text-gray-400">Reports</span><kbd
                                    class="bg-gray-100 dark:bg-dark-bg px-2 py-1 rounded font-mono">R</kbd></div>
                            <div class="flex justify-between"><span class="text-gray-600 dark:text-gray-400">Add
                                    Account</span><kbd
                                    class="bg-gray-100 dark:bg-dark-bg px-2 py-1 rounded font-mono">Shift+N</kbd></div>
                            <div class="flex justify-between"><span
                                    class="text-gray-600 dark:text-gray-400">Settings</span><kbd
                                    class="bg-gray-100 dark:bg-dark-bg px-2 py-1 rounded font-mono">S</kbd></div>
                            <div class="flex justify-between"><span class="text-gray-600 dark:text-gray-400">Next
                                    View</span><kbd
                                    class="bg-gray-100 dark:bg-dark-bg px-2 py-1 rounded font-mono">Tab</kbd></div>
                            <div class="flex justify-between"><span class="text-gray-600 dark:text-gray-400">Previous
                                    View</span><kbd
                                    class="bg-gray-100 dark:bg-dark-bg px-2 py-1 rounded font-mono">Shift+Tab</kbd>
                            </div>
                        </div>
                    </div>

                    <!-- Transactions -->
                    <div class="space-y-3">
                        <h3 class="font-bold text-gray-700 dark:text-gray-300 flex items-center gap-2">
                            <i class="fa-solid fa-plus-minus text-green-500"></i> Add Transaction
                        </h3>
                        <div class="space-y-2">
                            <div class="flex justify-between"><span class="text-gray-600 dark:text-gray-400">Quick
                                    Add</span><kbd class="bg-gray-100 dark:bg-dark-bg px-2 py-1 rounded font-mono">Q /
                                    N</kbd></div>
                            <div class="flex justify-between"><span class="text-gray-600 dark:text-gray-400">Add
                                    Income</span><kbd class="bg-gray-100 dark:bg-dark-bg px-2 py-1 rounded font-mono">I
                                    or +</kbd></div>
                            <div class="flex justify-between"><span class="text-gray-600 dark:text-gray-400">Add
                                    Expense</span><kbd class="bg-gray-100 dark:bg-dark-bg px-2 py-1 rounded font-mono">O
                                    or -</kbd></div>
                            <div class="flex justify-between"><span class="text-gray-600 dark:text-gray-400">Add
                                    Transfer</span><kbd
                                    class="bg-gray-100 dark:bg-dark-bg px-2 py-1 rounded font-mono">\ or P or *</kbd>
                            </div>
                        </div>
                    </div>

                    <!-- Item Navigation -->
                    <div class="space-y-3">
                        <h3 class="font-bold text-gray-700 dark:text-gray-300 flex items-center gap-2">
                            <i class="fa-solid fa-arrow-pointer text-purple-500"></i> Item Selection
                        </h3>
                        <div class="space-y-2">
                            <div class="flex justify-between"><span class="text-gray-600 dark:text-gray-400">Navigate
                                    Items</span><kbd class="bg-gray-100 dark:bg-dark-bg px-2 py-1 rounded font-mono">
                                    </kbd></div>
                            <div class="flex justify-between"><span class="text-gray-600 dark:text-gray-400">Select/Open
                                    Item</span><kbd
                                    class="bg-gray-100 dark:bg-dark-bg px-2 py-1 rounded font-mono">Enter</kbd></div>
                            <div class="flex justify-between"><span class="text-gray-600 dark:text-gray-400">Delete
                                    Transaction</span><kbd
                                    class="bg-gray-100 dark:bg-dark-bg px-2 py-1 rounded font-mono">Delete</kbd></div>
                            <div class="flex justify-between"><span class="text-gray-600 dark:text-gray-400">Month
                                    Navigation</span><kbd
                                    class="bg-gray-100 dark:bg-dark-bg px-2 py-1 rounded font-mono"> </kbd></div>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="space-y-3">
                        <h3 class="font-bold text-gray-700 dark:text-gray-300 flex items-center gap-2">
                            <i class="fa-solid fa-wand-magic-sparkles text-amber-500"></i> Actions
                        </h3>
                        <div class="space-y-2">
                            <div class="flex justify-between"><span
                                    class="text-gray-600 dark:text-gray-400">Undo</span><kbd
                                    class="bg-gray-100 dark:bg-dark-bg px-2 py-1 rounded font-mono">Ctrl+Z</kbd></div>
                            <div class="flex justify-between"><span
                                    class="text-gray-600 dark:text-gray-400">Redo</span><kbd
                                    class="bg-gray-100 dark:bg-dark-bg px-2 py-1 rounded font-mono">Ctrl+Y</kbd></div>
                            <div class="flex justify-between"><span class="text-gray-600 dark:text-gray-400">Toggle
                                    Theme</span><kbd
                                    class="bg-gray-100 dark:bg-dark-bg px-2 py-1 rounded font-mono">Shift+T</kbd></div>
                            <div class="flex justify-between"><span class="text-gray-600 dark:text-gray-400">Focus
                                    Search</span><kbd
                                    class="bg-gray-100 dark:bg-dark-bg px-2 py-1 rounded font-mono">F</kbd></div>
                            <div class="flex justify-between"><span class="text-gray-600 dark:text-gray-400">Go
                                    Back</span><kbd
                                    class="bg-gray-100 dark:bg-dark-bg px-2 py-1 rounded font-mono">Backspace</kbd>
                            </div>
                            <div class="flex justify-between"><span
                                    class="text-gray-600 dark:text-gray-400">Close/Escape</span><kbd
                                    class="bg-gray-100 dark:bg-dark-bg px-2 py-1 rounded font-mono">Esc</kbd></div>
                            <div class="flex justify-between"><span class="text-gray-600 dark:text-gray-400">Toggle
                                    Grouping</span><kbd
                                    class="bg-gray-100 dark:bg-dark-bg px-2 py-1 rounded font-mono">K</kbd></div>
                            <div class="flex justify-between"><span class="text-gray-600 dark:text-gray-400">Toggle
                                    View</span><kbd
                                    class="bg-gray-100 dark:bg-dark-bg px-2 py-1 rounded font-mono">L</kbd></div>
                            <div class="flex justify-between"><span class="text-gray-600 dark:text-gray-400">Toggle
                                    Sort</span><kbd
                                    class="bg-gray-100 dark:bg-dark-bg px-2 py-1 rounded font-mono">;</kbd></div>
                            <div class="flex justify-between"><span class="text-gray-600 dark:text-gray-400">Show This
                                    Help</span><kbd
                                    class="bg-gray-100 dark:bg-dark-bg px-2 py-1 rounded font-mono">?</kbd></div>
                        </div>
                    </div>
                </div>

                <!-- Footer -->
                <div class="mt-6 pt-4 border-t border-gray-200 dark:border-dark-border text-center">
                    <button onclick="closeModal('shortcutsModal')"
                        class="px-6 py-2 bg-blue-600 text-white rounded-xl font-semibold hover:bg-blue-700 transition">
                        Got it!
                    </button>
                </div>
            </div>
        </div>
</body>

</html>